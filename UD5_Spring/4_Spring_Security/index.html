
<!doctype html>
<html lang="ca" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      
        <link rel="prev" href="../3_API_Rest/">
      
      
        <link rel="next" href="../5_Spring_Hateoas/">
      
      
        
          <link rel="alternate" href="../../en/UD5_Spring/4_Spring_Security/" hreflang="en">
        
          <link rel="alternate" href="./" hreflang="ca">
        
      
      
      <link rel="icon" href="../../assets/jaume.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.7.0">
    
    
      
        <title>4. Seguretat - Accés a Dades. IES Jaume II El Just</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.618322db.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.ab4e12ef.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../css/custom.css">
    
    <script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="deep-purple" data-md-color-accent="indigo">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#1-https" class="md-skip">
          Salta el contingut
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Capçalera">
    <a href="../.." title="Accés a Dades. IES Jaume II El Just" class="md-header__button md-logo" aria-label="Accés a Dades. IES Jaume II El Just" data-md-component="logo">
      
  <img src="../../assets/jaume.png" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Accés a Dades. IES Jaume II El Just
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              4. Seguretat
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="default" data-md-color-primary="deep-purple" data-md-color-accent="indigo"  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_0">
    
      <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_1" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a4 4 0 0 0-4 4 4 4 0 0 0 4 4 4 4 0 0 0 4-4 4 4 0 0 0-4-4m0 10a6 6 0 0 1-6-6 6 6 0 0 1 6-6 6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="slate" data-md-color-primary="brown" data-md-color-accent="indigo"  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_1">
    
      <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_0" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 18c-.89 0-1.74-.2-2.5-.55C11.56 16.5 13 14.42 13 12s-1.44-4.5-3.5-5.45C10.26 6.2 11.11 6 12 6a6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg>
      </label>
    
  
</form>
      
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
      <div class="md-header__option">
  <div class="md-select">
    
    <button class="md-header__button md-icon" aria-label="Selecciona la llengua">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="m12.87 15.07-2.54-2.51.03-.03A17.5 17.5 0 0 0 14.07 6H17V4h-7V2H8v2H1v2h11.17C11.5 7.92 10.44 9.75 9 11.35 8.07 10.32 7.3 9.19 6.69 8h-2c.73 1.63 1.73 3.17 2.98 4.56l-5.09 5.02L4 19l5-5 3.11 3.11zM18.5 10h-2L12 22h2l1.12-3h4.75L21 22h2zm-2.62 7 1.62-4.33L19.12 17z"/></svg>
    </button>
    <div class="md-select__inner">
      <ul class="md-select__list">
        
          <li class="md-select__item">
            <a href="../../en/UD5_Spring/4_Spring_Security/" hreflang="en" class="md-select__link">
              English
            </a>
          </li>
        
          <li class="md-select__item">
            <a href="./" hreflang="ca" class="md-select__link">
              Valencià
            </a>
          </li>
        
      </ul>
    </div>
  </div>
</div>
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Cerca" placeholder="Cerca" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Cerca">
        
        <button type="reset" class="md-search__icon md-icon" title="Neteja" aria-label="Neteja" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Inicialitzant cerca
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navegació" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="Accés a Dades. IES Jaume II El Just" class="md-nav__button md-logo" aria-label="Accés a Dades. IES Jaume II El Just" data-md-component="logo">
      
  <img src="../../assets/jaume.png" alt="logo">

    </a>
    Accés a Dades. IES Jaume II El Just
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Accés a Dades - Informació del mòdul
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2" >
        
          
          <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Unitat 1. Fitxers
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            
  
    Unitat 1. Fitxers
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../UD1_Files/1_File_System/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    1. Sistema de Fitxers
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../UD1_Files/2_Reading_and_writing_files/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    2. Llegint i Escrivint
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../UD1_Files/3_XML_Files/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    3. Treball amb Arxius XML
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../UD1_Files/4_JSON_Files/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    4. Treball amb Arxius JSON
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../UD1_Files/5_CSV/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    5. Arxius separats per comes. CSV
  

    
      <br>
      <small>2n DAM - Accés a Dades</small>
    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../UD1_Files/6_Properties/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    6. Arxius de propietats
  

    
      <br>
      <small>2n DAM - Accés a Dades</small>
    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../UD1_Files/7_Llibreries_Conversores/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    7. Llibreries conversores
  

    
      <br>
      <small>2n DAM - Accés a Dades</small>
    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3" >
        
          
          <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Unitat 2. Connectors
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            
  
    Unitat 2. Connectors
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../UD2_Connectors/1_Object_relational_impedance_mismatch/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    1. Desfase objecte-relacional
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../UD2_Connectors/2_Connectors/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    2. Connectors
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../UD2_Connectors/3_Connecting/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    3. Connectant-se a la base de dades
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../UD2_Connectors/4_Resultset/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    4. Resultats de les consultes
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../UD2_Connectors/5_Metadata/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    5. Metadades
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../UD2_Connectors/6_CRUD/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    6. Operacions CRUD
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../UD2_Connectors/7_Row_to_Object/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    7. De les files als objectes
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../UD2_Connectors/8_Exercises/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    8. Exercicis proposats
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4" >
        
          
          <label class="md-nav__link" for="__nav_4" id="__nav_4_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Unitat 3. Hibernate
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4">
            <span class="md-nav__icon md-icon"></span>
            
  
    Unitat 3. Hibernate
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../UD3_Hibernate/1_Mapping/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    1. Mapeig d'objectes
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../UD3_Hibernate/2_Hibernate/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    2. Introduccio a Hibernate
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../UD3_Hibernate/3_Entities_Beans/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    3. Entitats
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../UD3_Hibernate/4_Relationships/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    4. Relacions
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../UD3_Hibernate/5_HQL/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    5. Consultes
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../UD3_Hibernate/6_SQL_2_HQL/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    6. Aprofundim en HQL
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5" >
        
          
          <label class="md-nav__link" for="__nav_5" id="__nav_5_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Unitat 4. Bases de Dades OO
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5">
            <span class="md-nav__icon md-icon"></span>
            
  
    Unitat 4. Bases de Dades OO
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../UD4_BDOO/1_Introduction/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    1. Introduccio a les bases de dades OO
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../UD4_BDOO/2_ORDB/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    2. Bases de dades Objecte-Relacionals
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../UD4_BDOO/3_OODB/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    3. Bases de dades Orientades a Objectes
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_6" checked>
        
          
          <label class="md-nav__link" for="__nav_6" id="__nav_6_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Unitat 5. Spring
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_6_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_6">
            <span class="md-nav__icon md-icon"></span>
            
  
    Unitat 5. Spring
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../1_Data_Access_Services/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    1. Serveis d'Acces a Dades
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../2_Spring_SpringBoot/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    2. Introducció a Spring
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../3_API_Rest/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    3. Creació de APIs REST
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  
  <span class="md-ellipsis">
    
  
    4. Seguretat
  

    
  </span>
  
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  
  <span class="md-ellipsis">
    
  
    4. Seguretat
  

    
  </span>
  
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Taula de continguts">
  
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Taula de continguts
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#1-https" class="md-nav__link">
    <span class="md-ellipsis">
      
        1. HTTPS
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="1. HTTPS">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#11-certificat" class="md-nav__link">
    <span class="md-ellipsis">
      
        1.1. Certificat
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#12-configurar-spring" class="md-nav__link">
    <span class="md-ellipsis">
      
        1.2. Configurar Spring
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#2-spring-security" class="md-nav__link">
    <span class="md-ellipsis">
      
        2. Spring Security
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="2. Spring Security">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#21-dades-dusuaris-per-a-autenticacio-i-autoritzacio-models" class="md-nav__link">
    <span class="md-ellipsis">
      
        2.1. Dades d'Usuaris per a Autenticació i Autorització (Models)
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#22-usuaris-rols" class="md-nav__link">
    <span class="md-ellipsis">
      
        2.2. Usuaris &amp; Rols
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#23-repositori-dusuaris-i-rols" class="md-nav__link">
    <span class="md-ellipsis">
      
        2.3. Repositori d'Usuaris i Rols
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#24-userdetails" class="md-nav__link">
    <span class="md-ellipsis">
      
        2.4. UserDetails
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#25-carregues-de-dtos" class="md-nav__link">
    <span class="md-ellipsis">
      
        2.5. Càrregues de DTO's
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#26-signuprequest" class="md-nav__link">
    <span class="md-ellipsis">
      
        2.6. SignupRequest
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#27-loginrequest" class="md-nav__link">
    <span class="md-ellipsis">
      
        2.7. LoginRequest
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#28-jwtresponse" class="md-nav__link">
    <span class="md-ellipsis">
      
        2.8. JwtResponse
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#3-tokens-jwt" class="md-nav__link">
    <span class="md-ellipsis">
      
        3. Tokens JWT
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="3. Tokens JWT">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#31-que-es-un-token" class="md-nav__link">
    <span class="md-ellipsis">
      
        3.1. Què és un token?
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#32-estructura-dun-jwt" class="md-nav__link">
    <span class="md-ellipsis">
      
        3.2. Estructura d'un JWT
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#33-jwt-library-class" class="md-nav__link">
    <span class="md-ellipsis">
      
        3.3. JWT Library class
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#34-generar-tokens" class="md-nav__link">
    <span class="md-ellipsis">
      
        3.4. Generar Tokens
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#35-validacio-de-tokens" class="md-nav__link">
    <span class="md-ellipsis">
      
        3.5. Validació de Tokens
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#4-authentication-controller" class="md-nav__link">
    <span class="md-ellipsis">
      
        4. Authentication Controller
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="4. Authentication Controller">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#41-signup-nou-usuari" class="md-nav__link">
    <span class="md-ellipsis">
      
        4.1. Signup (nou usuari)
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#42-signin-validar-se-o-accedir" class="md-nav__link">
    <span class="md-ellipsis">
      
        4.2. Signin (Validar-se o accedir)
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#5-tokens-en-funcionament" class="md-nav__link">
    <span class="md-ellipsis">
      
        5. Tokens en funcionament
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="5. Tokens en funcionament">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#51-enviant-tokens" class="md-nav__link">
    <span class="md-ellipsis">
      
        5.1. Enviant tokens
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#6-configuracio-de-seguretat" class="md-nav__link">
    <span class="md-ellipsis">
      
        6. Configuració de Seguretat
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="6. Configuració de Seguretat">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#61-authtokenfilter" class="md-nav__link">
    <span class="md-ellipsis">
      
        6.1. AuthTokenFilter
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#62-authentrypoint" class="md-nav__link">
    <span class="md-ellipsis">
      
        6.2. AuthEntryPoint
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#7-controller-authorization" class="md-nav__link">
    <span class="md-ellipsis">
      
        7. Controller Authorization
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#8-exercici-com-fer-servir-aquest-projecte" class="md-nav__link">
    <span class="md-ellipsis">
      
        8. Exercici. Com fer servir aquest projecte?
      
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../5_Spring_Hateoas/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    5. Spring Haetoas
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../6_Postman_Swagger/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    6. Test. Postman i Swagger
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_7" >
        
          
          <label class="md-nav__link" for="__nav_7" id="__nav_7_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Unitat 6. MongoDB
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_7_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_7">
            <span class="md-nav__icon md-icon"></span>
            
  
    Unitat 6. MongoDB
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../UD6_MongoDB/1_NoSQL/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    1. Bases de dades NoSQL
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../UD6_MongoDB/2_MongoDB/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    2. MongoDB
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../UD6_MongoDB/3_ShellOperations/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    3. Treballant amb MongoDB: Operacions bàsiques de shell
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../UD6_MongoDB/4_Queries/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    4. Consultese en Mongo
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../UD6_MongoDB/5_Mongo_Java/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    5. MongoDB i Java
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../UD6_MongoDB/6_Spring_MongoDB/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    6. Spring Data MongoDB i API REST
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_8" >
        
          
          <label class="md-nav__link" for="__nav_8" id="__nav_8_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Pràctiques
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_8_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_8">
            <span class="md-nav__icon md-icon"></span>
            
  
    Pràctiques
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../Practiques/APAC1/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Pràctica 1
  

    
      <br>
      <small>APAC1. 2DAM - Accés a Dades</small>
    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../Practiques/APAC2/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Pràctica 2
  

    
      <br>
      <small>APAC2. 2DAM - Accés a Dades</small>
    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../license/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Llicència
  

    
  </span>
  
  

      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Taula de continguts">
  
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Taula de continguts
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#1-https" class="md-nav__link">
    <span class="md-ellipsis">
      
        1. HTTPS
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="1. HTTPS">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#11-certificat" class="md-nav__link">
    <span class="md-ellipsis">
      
        1.1. Certificat
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#12-configurar-spring" class="md-nav__link">
    <span class="md-ellipsis">
      
        1.2. Configurar Spring
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#2-spring-security" class="md-nav__link">
    <span class="md-ellipsis">
      
        2. Spring Security
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="2. Spring Security">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#21-dades-dusuaris-per-a-autenticacio-i-autoritzacio-models" class="md-nav__link">
    <span class="md-ellipsis">
      
        2.1. Dades d'Usuaris per a Autenticació i Autorització (Models)
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#22-usuaris-rols" class="md-nav__link">
    <span class="md-ellipsis">
      
        2.2. Usuaris &amp; Rols
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#23-repositori-dusuaris-i-rols" class="md-nav__link">
    <span class="md-ellipsis">
      
        2.3. Repositori d'Usuaris i Rols
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#24-userdetails" class="md-nav__link">
    <span class="md-ellipsis">
      
        2.4. UserDetails
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#25-carregues-de-dtos" class="md-nav__link">
    <span class="md-ellipsis">
      
        2.5. Càrregues de DTO's
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#26-signuprequest" class="md-nav__link">
    <span class="md-ellipsis">
      
        2.6. SignupRequest
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#27-loginrequest" class="md-nav__link">
    <span class="md-ellipsis">
      
        2.7. LoginRequest
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#28-jwtresponse" class="md-nav__link">
    <span class="md-ellipsis">
      
        2.8. JwtResponse
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#3-tokens-jwt" class="md-nav__link">
    <span class="md-ellipsis">
      
        3. Tokens JWT
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="3. Tokens JWT">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#31-que-es-un-token" class="md-nav__link">
    <span class="md-ellipsis">
      
        3.1. Què és un token?
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#32-estructura-dun-jwt" class="md-nav__link">
    <span class="md-ellipsis">
      
        3.2. Estructura d'un JWT
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#33-jwt-library-class" class="md-nav__link">
    <span class="md-ellipsis">
      
        3.3. JWT Library class
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#34-generar-tokens" class="md-nav__link">
    <span class="md-ellipsis">
      
        3.4. Generar Tokens
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#35-validacio-de-tokens" class="md-nav__link">
    <span class="md-ellipsis">
      
        3.5. Validació de Tokens
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#4-authentication-controller" class="md-nav__link">
    <span class="md-ellipsis">
      
        4. Authentication Controller
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="4. Authentication Controller">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#41-signup-nou-usuari" class="md-nav__link">
    <span class="md-ellipsis">
      
        4.1. Signup (nou usuari)
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#42-signin-validar-se-o-accedir" class="md-nav__link">
    <span class="md-ellipsis">
      
        4.2. Signin (Validar-se o accedir)
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#5-tokens-en-funcionament" class="md-nav__link">
    <span class="md-ellipsis">
      
        5. Tokens en funcionament
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="5. Tokens en funcionament">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#51-enviant-tokens" class="md-nav__link">
    <span class="md-ellipsis">
      
        5.1. Enviant tokens
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#6-configuracio-de-seguretat" class="md-nav__link">
    <span class="md-ellipsis">
      
        6. Configuració de Seguretat
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="6. Configuració de Seguretat">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#61-authtokenfilter" class="md-nav__link">
    <span class="md-ellipsis">
      
        6.1. AuthTokenFilter
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#62-authentrypoint" class="md-nav__link">
    <span class="md-ellipsis">
      
        6.2. AuthEntryPoint
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#7-controller-authorization" class="md-nav__link">
    <span class="md-ellipsis">
      
        7. Controller Authorization
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#8-exercici-com-fer-servir-aquest-projecte" class="md-nav__link">
    <span class="md-ellipsis">
      
        8. Exercici. Com fer servir aquest projecte?
      
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              
              <article class="md-content__inner md-typeset">
                
                  



  <h1>4. Seguretat</h1>

<h2 id="1-https">1. HTTPS</h2>
<p>Avui en dia, necessitem afegir tot el que puguem per assegurar les nostres aplicacions. Estudiarem el concepte de <strong>tokens</strong> per autoritzar i autenticar les nostres sol·licituds, però necessitem una capa extra, <strong>https</strong>.</p>
<p>En aquesta pàgina web <a href="https://tiptopsecurity.com/how-does-https-work-rsa-encryption-explained/">https://tiptopsecurity.com/how-does-https-work-rsa-encryption-explained/</a> podeu trobar com funciona https.</p>
<h3 id="11-certificat">1.1. Certificat</h3>
<p>Primerament, necessitem generar certificats, o comprar-los. Utilitzarem l'eina <code>keytool</code> inclosa amb el kit de desenvolupament de Java per generar-los. Aquesta comanda genera un parell de certificats (públic i privat).</p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Bash</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-1">1</a></span>
<span class="normal"><a href="#__codelineno-0-2">2</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1"></a>keytool<span class="w"> </span>-genkeypair<span class="w"> </span>-alias<span class="w"> </span>joange<span class="w"> </span>-keyalg<span class="w"> </span>RSA<span class="w"> </span>-keysize<span class="w"> </span><span class="m">2048</span>
<a id="__codelineno-0-2" name="__codelineno-0-2"></a>-storetype<span class="w"> </span>PKCS12<span class="w"> </span>-keystore<span class="w"> </span>jgce.p12<span class="w"> </span>-validity<span class="w"> </span><span class="m">3650</span>
</code></pre></div></td></tr></table></div>
<p>Després d'executar aquesta comanda, hem de respondre sobre qui som, de la següent manera:</p>
<center>![keytool](./img/keytool.png){width=95%}</center>

<h3 id="12-configurar-spring">1.2. Configurar Spring</h3>
<p>Un cop finalitzat el procés, hem d'afegir el certificat dins del nostre projecte. Per exemple, dins de <code>/resources/keystore</code>. Finalment, hem de carregar el certificat i habilitar SSL, simplement afegint aquestes línies a <code>application.properties</code>:</p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Bash</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-1-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-1-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-1-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-1-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-1-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-1-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-1-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-1-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-1-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-1-10">10</a></span>
<span class="normal"><a href="#__codelineno-1-11">11</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-1-1" name="__codelineno-1-1"></a><span class="c1"># The format used for the keystore.</span>
<a id="__codelineno-1-2" name="__codelineno-1-2"></a>server.ssl.key-store-type<span class="o">=</span>PKCS12
<a id="__codelineno-1-3" name="__codelineno-1-3"></a><span class="c1"># The path to the keystore containing the certificate</span>
<a id="__codelineno-1-4" name="__codelineno-1-4"></a>server.ssl.key-store<span class="o">=</span>classpath:keystore/jgce.p12
<a id="__codelineno-1-5" name="__codelineno-1-5"></a><span class="c1"># The password used to generate the certificate</span>
<a id="__codelineno-1-6" name="__codelineno-1-6"></a>server.ssl.key-store-password<span class="o">=</span>joangeca
<a id="__codelineno-1-7" name="__codelineno-1-7"></a><span class="c1"># The alias mapped to the certificate</span>
<a id="__codelineno-1-8" name="__codelineno-1-8"></a>server.ssl.key-alias<span class="o">=</span>joange
<a id="__codelineno-1-9" name="__codelineno-1-9"></a>
<a id="__codelineno-1-10" name="__codelineno-1-10"></a><span class="c1"># Use HTTPS instead of HTTP</span>
<a id="__codelineno-1-11" name="__codelineno-1-11"></a>server.ssl.enabled<span class="o">=</span><span class="nb">true</span>
</code></pre></div></td></tr></table></div>
<center>![HTTPS_Spring_Project](./img/HTTPS_Spring_Project.png){width=95%}</center>

<p>I això és tot, quan Spring comenci veurem que està funcionant amb el protocol <code>https</code>:</p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Bash</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-2-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-2-1" name="__codelineno-2-1"></a><span class="m">2023</span>-01-13<span class="w"> </span><span class="m">08</span>:29:37.267<span class="w">  </span>INFO<span class="w"> </span><span class="m">83291</span><span class="w"> </span>---<span class="w"> </span><span class="o">[</span><span class="w">           </span>main<span class="o">]</span><span class="w"> </span>o.s.b.w.embedded.tomcat.TomcatWebServer<span class="w">  </span>:<span class="w"> </span>Tomcat<span class="w"> </span>initialized<span class="w"> </span>with<span class="w"> </span>port<span class="o">(</span>s<span class="o">)</span>:<span class="w"> </span><span class="m">9091</span><span class="w"> </span><span class="o">(</span>https<span class="o">)</span>
</code></pre></div></td></tr></table></div>
<center>![HTTPS_Working](./img/HTTPS_Working.png){width=95%}</center>

<p>i en la sol·licitud probablement els navegadors no confiaran en el nostre certificat (haurem d'afegir una excepció de confiança):</p>
<center>![Certificate](./img/Certificate.png){width=95%}</center>

<h2 id="2-spring-security">2. Spring Security</h2>
<p>Spring Security és un projecte paraigua que agrupa tots els mecanismes referents a la seguretat. Necessitem afegir:</p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">XML</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-3-1">1</a></span>
<span class="normal"><a href="#__codelineno-3-2">2</a></span>
<span class="normal"><a href="#__codelineno-3-3">3</a></span>
<span class="normal"><a href="#__codelineno-3-4">4</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-3-1" name="__codelineno-3-1"></a><span class="nt">&lt;dependency&gt;</span>
<a id="__codelineno-3-2" name="__codelineno-3-2"></a><span class="nt">&lt;groupId&gt;</span>org.springframework.boot<span class="nt">&lt;/groupId&gt;</span>
<a id="__codelineno-3-3" name="__codelineno-3-3"></a><span class="nt">&lt;artifactId&gt;</span>spring-boot-starter-security<span class="nt">&lt;/artifactId&gt;</span><span class="w"> </span>
<a id="__codelineno-3-4" name="__codelineno-3-4"></a><span class="nt">&lt;/dependency&gt;</span>
</code></pre></div></td></tr></table></div>
<p>i automàgicament:</p>
<ul>
<li>La configuració per defecte està habilitada, a través d'un filtre, anomenat <code>SpringSecurityFilterChain</code>.</li>
<li>Es crea un bean de tipus <code>UserDetailsService</code> amb un usuari anomenat <code>user</code> i una contrasenya aleatòria que es mostra per la consola.</li>
<li>El filtre es registra en el contenidor de servlets per a totes les sol·licituds.</li>
</ul>
<p>Encara que no has configurat gaire, té moltes conseqüències:</p>
<ul>
<li>Requereix autenticació per interactuar amb la nostra aplicació</li>
<li>Genera un formulari de login per defecte.</li>
<li>Genera un mecanisme de logout</li>
<li>Protegeix l'emmagatzematge de contrasenyes amb <code>BCrypt</code>.</li>
<li>Proporciona protecció contra atacs CSRF, Fixació de Sessió, Clickjacking...</li>
</ul>
<p>Podem crear una classe de configuració, amb aquest contingut:</p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Java</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-4-1">1</a></span>
<span class="normal"><a href="#__codelineno-4-2">2</a></span>
<span class="normal"><a href="#__codelineno-4-3">3</a></span>
<span class="normal"><a href="#__codelineno-4-4">4</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-4-1" name="__codelineno-4-1"></a><span class="nd">@Configuration</span>
<a id="__codelineno-4-2" name="__codelineno-4-2"></a><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">SecurityConfig</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-4-3" name="__codelineno-4-3"></a>
<a id="__codelineno-4-4" name="__codelineno-4-4"></a><span class="p">}</span>
</code></pre></div></td></tr></table></div>
<div class="admonition note">
<p class="admonition-title">Atenció</p>
<p>Tornarem a aquesta classe per afegir més configuracions. El més interessant és el mètode <code>configure</code> i la creació de diversos Beans utilitzats per altres classes.</p>
</div>
<h3 id="21-dades-dusuaris-per-a-autenticacio-i-autoritzacio-models">2.1. Dades d'Usuaris per a Autenticació i Autorització (Models)</h3>
<div class="admonition important">
<p class="admonition-title">Important</p>
<p>A partir d'ara, aquest exemple es basa en una pàgina web famosa <a href="https://www.bezkoder.com">https://www.bezkoder.com</a>. Expliquem tot el necessari de l'exemple que podeu veure <a href="https://www.bezkoder.com/spring-boot-jwt-authentication/">aquí</a>.</p>
</div>
<p>En aquesta secció prepararem la nostra aplicació per identificar usuaris amb diversos rols. Amb aquests rols, podrem concedir o no accés a diversos recursos.</p>
<h3 id="22-usuaris-rols">2.2. Usuaris &amp; Rols</h3>
<p>Per fer això, necessitem crear una classe <code>User</code>, per emmagatzemar aquesta informació a la nostra base de dades. Aquest usuari podria tenir una col·lecció de <em>rols</em>. Podem fer-ho amb una relació de molts a molts.</p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Java</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-5-1">1</a></span>
<span class="normal"><a href="#__codelineno-5-2">2</a></span>
<span class="normal"><a href="#__codelineno-5-3">3</a></span>
<span class="normal"><a href="#__codelineno-5-4">4</a></span>
<span class="normal"><a href="#__codelineno-5-5">5</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-5-1" name="__codelineno-5-1"></a><span class="kd">public</span><span class="w"> </span><span class="kd">enum</span><span class="w"> </span><span class="n">ERole</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-5-2" name="__codelineno-5-2"></a><span class="w">  </span><span class="n">ROLE_USER</span><span class="p">,</span>
<a id="__codelineno-5-3" name="__codelineno-5-3"></a><span class="w">  </span><span class="n">ROLE_MODERATOR</span><span class="p">,</span>
<a id="__codelineno-5-4" name="__codelineno-5-4"></a><span class="w">  </span><span class="n">ROLE_ADMIN</span>
<a id="__codelineno-5-5" name="__codelineno-5-5"></a><span class="p">}</span>
</code></pre></div></td></tr></table></div>
<p>basat en aquesta enumeració, farem una classe <code>Role</code> per emmagatzemar els rols que la nostra aplicació suportarà:</p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Java</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-6-1">1</a></span>
<span class="normal"><a href="#__codelineno-6-2">2</a></span>
<span class="normal"><a href="#__codelineno-6-3">3</a></span>
<span class="normal"><a href="#__codelineno-6-4">4</a></span>
<span class="normal"><a href="#__codelineno-6-5">5</a></span>
<span class="normal"><a href="#__codelineno-6-6">6</a></span>
<span class="normal"><a href="#__codelineno-6-7">7</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-6-1" name="__codelineno-6-1"></a><span class="nd">@Data</span>
<a id="__codelineno-6-2" name="__codelineno-6-2"></a><span class="nd">@Entity</span>
<a id="__codelineno-6-3" name="__codelineno-6-3"></a><span class="nd">@Table</span><span class="p">(</span><span class="n">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;roles&quot;</span><span class="p">)</span>
<a id="__codelineno-6-4" name="__codelineno-6-4"></a><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">Role</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-6-5" name="__codelineno-6-5"></a><span class="w">  </span><span class="kd">private</span><span class="w"> </span><span class="n">Integer</span><span class="w"> </span><span class="n">id</span><span class="p">;</span>
<a id="__codelineno-6-6" name="__codelineno-6-6"></a><span class="w">  </span><span class="kd">private</span><span class="w"> </span><span class="n">ERole</span><span class="w"> </span><span class="n">name</span><span class="p">;</span>
<a id="__codelineno-6-7" name="__codelineno-6-7"></a><span class="p">}</span>
</code></pre></div></td></tr></table></div>
<p>finalment, una classe <code>User</code> com la següent. Afegim noves anotacions de validació:</p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Java</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-7-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-7-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-7-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-7-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-7-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-7-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-7-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-7-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-7-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-7-10">10</a></span>
<span class="normal"><a href="#__codelineno-7-11">11</a></span>
<span class="normal"><a href="#__codelineno-7-12">12</a></span>
<span class="normal"><a href="#__codelineno-7-13">13</a></span>
<span class="normal"><a href="#__codelineno-7-14">14</a></span>
<span class="normal"><a href="#__codelineno-7-15">15</a></span>
<span class="normal"><a href="#__codelineno-7-16">16</a></span>
<span class="normal"><a href="#__codelineno-7-17">17</a></span>
<span class="normal"><a href="#__codelineno-7-18">18</a></span>
<span class="normal"><a href="#__codelineno-7-19">19</a></span>
<span class="normal"><a href="#__codelineno-7-20">20</a></span>
<span class="normal"><a href="#__codelineno-7-21">21</a></span>
<span class="normal"><a href="#__codelineno-7-22">22</a></span>
<span class="normal"><a href="#__codelineno-7-23">23</a></span>
<span class="normal"><a href="#__codelineno-7-24">24</a></span>
<span class="normal"><a href="#__codelineno-7-25">25</a></span>
<span class="normal"><a href="#__codelineno-7-26">26</a></span>
<span class="normal"><a href="#__codelineno-7-27">27</a></span>
<span class="normal"><a href="#__codelineno-7-28">28</a></span>
<span class="normal"><a href="#__codelineno-7-29">29</a></span>
<span class="normal"><a href="#__codelineno-7-30">30</a></span>
<span class="normal"><a href="#__codelineno-7-31">31</a></span>
<span class="normal"><a href="#__codelineno-7-32">32</a></span>
<span class="normal"><a href="#__codelineno-7-33">33</a></span>
<span class="normal"><a href="#__codelineno-7-34">34</a></span>
<span class="normal"><a href="#__codelineno-7-35">35</a></span>
<span class="normal"><a href="#__codelineno-7-36">36</a></span>
<span class="normal"><a href="#__codelineno-7-37">37</a></span>
<span class="normal"><a href="#__codelineno-7-38">38</a></span>
<span class="normal"><a href="#__codelineno-7-39">39</a></span>
<span class="normal"><a href="#__codelineno-7-40">40</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-7-1" name="__codelineno-7-1"></a><span class="nd">@Entity</span>
<a id="__codelineno-7-2" name="__codelineno-7-2"></a><span class="nd">@Table</span><span class="p">(</span><span class="n">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;users&quot;</span><span class="p">,</span><span class="w"> </span>
<a id="__codelineno-7-3" name="__codelineno-7-3"></a><span class="w">    </span><span class="n">uniqueConstraints</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"> </span>
<a id="__codelineno-7-4" name="__codelineno-7-4"></a><span class="w">      </span><span class="nd">@UniqueConstraint</span><span class="p">(</span><span class="n">columnNames</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;username&quot;</span><span class="p">),</span>
<a id="__codelineno-7-5" name="__codelineno-7-5"></a><span class="w">      </span><span class="nd">@UniqueConstraint</span><span class="p">(</span><span class="n">columnNames</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;email&quot;</span><span class="p">)</span><span class="w"> </span>
<a id="__codelineno-7-6" name="__codelineno-7-6"></a><span class="w">    </span><span class="p">})</span>
<a id="__codelineno-7-7" name="__codelineno-7-7"></a><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">User</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-7-8" name="__codelineno-7-8"></a><span class="w">  </span><span class="nd">@Id</span>
<a id="__codelineno-7-9" name="__codelineno-7-9"></a><span class="w">  </span><span class="nd">@GeneratedValue</span><span class="p">(</span><span class="n">strategy</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">GenerationType</span><span class="p">.</span><span class="na">IDENTITY</span><span class="p">)</span>
<a id="__codelineno-7-10" name="__codelineno-7-10"></a><span class="w">  </span><span class="kd">private</span><span class="w"> </span><span class="n">Long</span><span class="w"> </span><span class="n">id</span><span class="p">;</span>
<a id="__codelineno-7-11" name="__codelineno-7-11"></a>
<a id="__codelineno-7-12" name="__codelineno-7-12"></a><span class="w">  </span><span class="nd">@NotBlank</span>
<a id="__codelineno-7-13" name="__codelineno-7-13"></a><span class="w">  </span><span class="nd">@Size</span><span class="p">(</span><span class="n">max</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">20</span><span class="p">)</span>
<a id="__codelineno-7-14" name="__codelineno-7-14"></a><span class="w">  </span><span class="kd">private</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">username</span><span class="p">;</span>
<a id="__codelineno-7-15" name="__codelineno-7-15"></a>
<a id="__codelineno-7-16" name="__codelineno-7-16"></a><span class="w">  </span><span class="nd">@NotBlank</span>
<a id="__codelineno-7-17" name="__codelineno-7-17"></a><span class="w">  </span><span class="nd">@Size</span><span class="p">(</span><span class="n">max</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">50</span><span class="p">)</span>
<a id="__codelineno-7-18" name="__codelineno-7-18"></a><span class="w">  </span><span class="nd">@Email</span>
<a id="__codelineno-7-19" name="__codelineno-7-19"></a><span class="w">  </span><span class="kd">private</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">email</span><span class="p">;</span>
<a id="__codelineno-7-20" name="__codelineno-7-20"></a>
<a id="__codelineno-7-21" name="__codelineno-7-21"></a><span class="w">  </span><span class="nd">@NotBlank</span>
<a id="__codelineno-7-22" name="__codelineno-7-22"></a><span class="w">  </span><span class="nd">@Size</span><span class="p">(</span><span class="n">max</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">120</span><span class="p">)</span>
<a id="__codelineno-7-23" name="__codelineno-7-23"></a><span class="w">  </span><span class="kd">private</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">password</span><span class="p">;</span>
<a id="__codelineno-7-24" name="__codelineno-7-24"></a>
<a id="__codelineno-7-25" name="__codelineno-7-25"></a><span class="w">  </span><span class="nd">@ManyToMany</span><span class="p">(</span><span class="n">fetch</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">FetchType</span><span class="p">.</span><span class="na">LAZY</span><span class="p">)</span>
<a id="__codelineno-7-26" name="__codelineno-7-26"></a><span class="w">  </span><span class="nd">@JoinTable</span><span class="p">(</span><span class="w"> </span><span class="n">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;user_roles&quot;</span><span class="p">,</span><span class="w"> </span>
<a id="__codelineno-7-27" name="__codelineno-7-27"></a><span class="w">        </span><span class="n">joinColumns</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nd">@JoinColumn</span><span class="p">(</span><span class="n">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;user_id&quot;</span><span class="p">),</span><span class="w"> </span>
<a id="__codelineno-7-28" name="__codelineno-7-28"></a><span class="w">        </span><span class="n">inverseJoinColumns</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nd">@JoinColumn</span><span class="p">(</span><span class="n">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;role_id&quot;</span><span class="p">))</span>
<a id="__codelineno-7-29" name="__codelineno-7-29"></a><span class="w">  </span><span class="kd">private</span><span class="w"> </span><span class="n">Set</span><span class="o">&lt;</span><span class="n">Role</span><span class="o">&gt;</span><span class="w"> </span><span class="n">roles</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">HashSet</span><span class="o">&lt;&gt;</span><span class="p">();</span>
<a id="__codelineno-7-30" name="__codelineno-7-30"></a>
<a id="__codelineno-7-31" name="__codelineno-7-31"></a><span class="w">  </span><span class="kd">public</span><span class="w"> </span><span class="nf">User</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-7-32" name="__codelineno-7-32"></a><span class="w">  </span><span class="p">}</span>
<a id="__codelineno-7-33" name="__codelineno-7-33"></a>
<a id="__codelineno-7-34" name="__codelineno-7-34"></a><span class="w">  </span><span class="kd">public</span><span class="w"> </span><span class="nf">User</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">username</span><span class="p">,</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">email</span><span class="p">,</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">password</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-7-35" name="__codelineno-7-35"></a><span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="na">username</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">username</span><span class="p">;</span>
<a id="__codelineno-7-36" name="__codelineno-7-36"></a><span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="na">email</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">email</span><span class="p">;</span>
<a id="__codelineno-7-37" name="__codelineno-7-37"></a><span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="na">password</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">password</span><span class="p">;</span>
<a id="__codelineno-7-38" name="__codelineno-7-38"></a><span class="w">  </span><span class="p">}</span>
<a id="__codelineno-7-39" name="__codelineno-7-39"></a>
<a id="__codelineno-7-40" name="__codelineno-7-40"></a><span class="p">}</span>
</code></pre></div></td></tr></table></div>
<h3 id="23-repositori-dusuaris-i-rols">2.3. Repositori d'Usuaris i Rols</h3>
<p>Necessitem crear els nostres repositoris per a les últimes entitats, creant interfícies com normalment fem.</p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Java</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-8-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-8-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-8-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-8-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-8-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-8-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-8-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-8-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-8-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-8-10">10</a></span>
<span class="normal"><a href="#__codelineno-8-11">11</a></span>
<span class="normal"><a href="#__codelineno-8-12">12</a></span>
<span class="normal"><a href="#__codelineno-8-13">13</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-8-1" name="__codelineno-8-1"></a><span class="nd">@Repository</span>
<a id="__codelineno-8-2" name="__codelineno-8-2"></a><span class="kd">public</span><span class="w"> </span><span class="kd">interface</span> <span class="nc">RoleRepository</span><span class="w"> </span><span class="kd">extends</span><span class="w"> </span><span class="n">JpaRepository</span><span class="o">&lt;</span><span class="n">Role</span><span class="p">,</span><span class="w"> </span><span class="n">Long</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-8-3" name="__codelineno-8-3"></a><span class="w">  </span><span class="n">Optional</span><span class="o">&lt;</span><span class="n">Role</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">findByName</span><span class="p">(</span><span class="n">ERole</span><span class="w"> </span><span class="n">name</span><span class="p">);</span>
<a id="__codelineno-8-4" name="__codelineno-8-4"></a><span class="p">}</span>
<a id="__codelineno-8-5" name="__codelineno-8-5"></a>
<a id="__codelineno-8-6" name="__codelineno-8-6"></a><span class="nd">@Repository</span>
<a id="__codelineno-8-7" name="__codelineno-8-7"></a><span class="kd">public</span><span class="w"> </span><span class="kd">interface</span> <span class="nc">UserRepository</span><span class="w"> </span><span class="kd">extends</span><span class="w"> </span><span class="n">JpaRepository</span><span class="o">&lt;</span><span class="n">User</span><span class="p">,</span><span class="w"> </span><span class="n">Long</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-8-8" name="__codelineno-8-8"></a><span class="w">  </span><span class="n">Optional</span><span class="o">&lt;</span><span class="n">User</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">findByUsername</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">username</span><span class="p">);</span>
<a id="__codelineno-8-9" name="__codelineno-8-9"></a>
<a id="__codelineno-8-10" name="__codelineno-8-10"></a><span class="w">  </span><span class="n">Boolean</span><span class="w"> </span><span class="nf">existsByUsername</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">username</span><span class="p">);</span>
<a id="__codelineno-8-11" name="__codelineno-8-11"></a>
<a id="__codelineno-8-12" name="__codelineno-8-12"></a><span class="w">  </span><span class="n">Boolean</span><span class="w"> </span><span class="nf">existsByEmail</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">email</span><span class="p">);</span>
<a id="__codelineno-8-13" name="__codelineno-8-13"></a><span class="p">}</span>
</code></pre></div></td></tr></table></div>
<p>També afegim mètodes per comprovar l'existència de l'usuari per nom i correu electrònic, i mètodes per trobar per nom, tant <code>User</code> com <code>Role</code>.</p>
<h3 id="24-userdetails">2.4. UserDetails</h3>
<p>Spring necessita que algú implementi la interfície <code>UserDetails</code>, molt important perquè Spring Security utilitzarà un <code>UserDetails</code>. <code>UserDetails</code> conté la informació necessària per construir un objecte <code>Authentication</code> a partir de DAOs o altres fonts de dades de seguretat. Creem una classe, anomenada <code>UserDetailsImpl</code>, que:</p>
<ul>
<li>Ha de tenir els camps <code>username</code> i <code>password</code>, i els getters. Heu de respectar els noms, qualsevol canvi està prohibit. Aquests mètodes seran utilitzats per les classes d'autenticació.</li>
<li>Sobreescriure mètodes de <code>UserDetails</code>, per exemple <code>getAuthorities()</code> i diversos mètodes per controlar si l'usuari està bloquejat, caducat, etc.</li>
</ul>
<p>Classe completa:</p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Java</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-9-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-9-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-9-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-9-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-9-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-9-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-9-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-9-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-9-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-9-10">10</a></span>
<span class="normal"><a href="#__codelineno-9-11">11</a></span>
<span class="normal"><a href="#__codelineno-9-12">12</a></span>
<span class="normal"><a href="#__codelineno-9-13">13</a></span>
<span class="normal"><a href="#__codelineno-9-14">14</a></span>
<span class="normal"><a href="#__codelineno-9-15">15</a></span>
<span class="normal"><a href="#__codelineno-9-16">16</a></span>
<span class="normal"><a href="#__codelineno-9-17">17</a></span>
<span class="normal"><a href="#__codelineno-9-18">18</a></span>
<span class="normal"><a href="#__codelineno-9-19">19</a></span>
<span class="normal"><a href="#__codelineno-9-20">20</a></span>
<span class="normal"><a href="#__codelineno-9-21">21</a></span>
<span class="normal"><a href="#__codelineno-9-22">22</a></span>
<span class="normal"><a href="#__codelineno-9-23">23</a></span>
<span class="normal"><a href="#__codelineno-9-24">24</a></span>
<span class="normal"><a href="#__codelineno-9-25">25</a></span>
<span class="normal"><a href="#__codelineno-9-26">26</a></span>
<span class="normal"><a href="#__codelineno-9-27">27</a></span>
<span class="normal"><a href="#__codelineno-9-28">28</a></span>
<span class="normal"><a href="#__codelineno-9-29">29</a></span>
<span class="normal"><a href="#__codelineno-9-30">30</a></span>
<span class="normal"><a href="#__codelineno-9-31">31</a></span>
<span class="normal"><a href="#__codelineno-9-32">32</a></span>
<span class="normal"><a href="#__codelineno-9-33">33</a></span>
<span class="normal"><a href="#__codelineno-9-34">34</a></span>
<span class="normal"><a href="#__codelineno-9-35">35</a></span>
<span class="normal"><a href="#__codelineno-9-36">36</a></span>
<span class="normal"><a href="#__codelineno-9-37">37</a></span>
<span class="normal"><a href="#__codelineno-9-38">38</a></span>
<span class="normal"><a href="#__codelineno-9-39">39</a></span>
<span class="normal"><a href="#__codelineno-9-40">40</a></span>
<span class="normal"><a href="#__codelineno-9-41">41</a></span>
<span class="normal"><a href="#__codelineno-9-42">42</a></span>
<span class="normal"><a href="#__codelineno-9-43">43</a></span>
<span class="normal"><a href="#__codelineno-9-44">44</a></span>
<span class="normal"><a href="#__codelineno-9-45">45</a></span>
<span class="normal"><a href="#__codelineno-9-46">46</a></span>
<span class="normal"><a href="#__codelineno-9-47">47</a></span>
<span class="normal"><a href="#__codelineno-9-48">48</a></span>
<span class="normal"><a href="#__codelineno-9-49">49</a></span>
<span class="normal"><a href="#__codelineno-9-50">50</a></span>
<span class="normal"><a href="#__codelineno-9-51">51</a></span>
<span class="normal"><a href="#__codelineno-9-52">52</a></span>
<span class="normal"><a href="#__codelineno-9-53">53</a></span>
<span class="normal"><a href="#__codelineno-9-54">54</a></span>
<span class="normal"><a href="#__codelineno-9-55">55</a></span>
<span class="normal"><a href="#__codelineno-9-56">56</a></span>
<span class="normal"><a href="#__codelineno-9-57">57</a></span>
<span class="normal"><a href="#__codelineno-9-58">58</a></span>
<span class="normal"><a href="#__codelineno-9-59">59</a></span>
<span class="normal"><a href="#__codelineno-9-60">60</a></span>
<span class="normal"><a href="#__codelineno-9-61">61</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-9-1" name="__codelineno-9-1"></a><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">UserDetailsImpl</span><span class="w"> </span><span class="kd">implements</span><span class="w"> </span><span class="n">UserDetails</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-9-2" name="__codelineno-9-2"></a><span class="w">  </span><span class="kd">private</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">serialVersionUID</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1L</span><span class="p">;</span>
<a id="__codelineno-9-3" name="__codelineno-9-3"></a>
<a id="__codelineno-9-4" name="__codelineno-9-4"></a><span class="w">  </span><span class="kd">private</span><span class="w"> </span><span class="n">Long</span><span class="w"> </span><span class="n">id</span><span class="p">;</span>
<a id="__codelineno-9-5" name="__codelineno-9-5"></a><span class="w">  </span><span class="kd">private</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">username</span><span class="p">;</span>
<a id="__codelineno-9-6" name="__codelineno-9-6"></a><span class="w">  </span><span class="kd">private</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">email</span><span class="p">;</span>
<a id="__codelineno-9-7" name="__codelineno-9-7"></a>
<a id="__codelineno-9-8" name="__codelineno-9-8"></a><span class="w">  </span><span class="nd">@JsonIgnore</span>
<a id="__codelineno-9-9" name="__codelineno-9-9"></a><span class="w">  </span><span class="kd">private</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">password</span><span class="p">;</span>
<a id="__codelineno-9-10" name="__codelineno-9-10"></a>
<a id="__codelineno-9-11" name="__codelineno-9-11"></a><span class="w">  </span><span class="kd">private</span><span class="w"> </span><span class="n">Collection</span><span class="o">&lt;?</span><span class="w"> </span><span class="kd">extends</span><span class="w"> </span><span class="n">GrantedAuthority</span><span class="o">&gt;</span><span class="w"> </span><span class="n">authorities</span><span class="p">;</span>
<a id="__codelineno-9-12" name="__codelineno-9-12"></a>
<a id="__codelineno-9-13" name="__codelineno-9-13"></a><span class="w">  </span><span class="kd">public</span><span class="w"> </span><span class="nf">UserDetailsImpl</span><span class="p">(</span><span class="n">Long</span><span class="w"> </span><span class="n">id</span><span class="p">,</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">username</span><span class="p">,</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">email</span><span class="p">,</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">password</span><span class="p">,</span>
<a id="__codelineno-9-14" name="__codelineno-9-14"></a><span class="w">      </span><span class="n">Collection</span><span class="o">&lt;?</span><span class="w"> </span><span class="kd">extends</span><span class="w"> </span><span class="n">GrantedAuthority</span><span class="o">&gt;</span><span class="w"> </span><span class="n">authorities</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-9-15" name="__codelineno-9-15"></a><span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="na">id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">id</span><span class="p">;</span>
<a id="__codelineno-9-16" name="__codelineno-9-16"></a><span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="na">username</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">username</span><span class="p">;</span>
<a id="__codelineno-9-17" name="__codelineno-9-17"></a><span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="na">email</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">email</span><span class="p">;</span>
<a id="__codelineno-9-18" name="__codelineno-9-18"></a><span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="na">password</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">password</span><span class="p">;</span>
<a id="__codelineno-9-19" name="__codelineno-9-19"></a><span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="na">authorities</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">authorities</span><span class="p">;</span>
<a id="__codelineno-9-20" name="__codelineno-9-20"></a><span class="w">  </span><span class="p">}</span>
<a id="__codelineno-9-21" name="__codelineno-9-21"></a>
<a id="__codelineno-9-22" name="__codelineno-9-22"></a><span class="w">  </span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="n">UserDetailsImpl</span><span class="w"> </span><span class="nf">build</span><span class="p">(</span><span class="n">User</span><span class="w"> </span><span class="n">user</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-9-23" name="__codelineno-9-23"></a><span class="w">    </span><span class="n">List</span><span class="o">&lt;</span><span class="n">GrantedAuthority</span><span class="o">&gt;</span><span class="w"> </span><span class="n">authorities</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">user</span><span class="p">.</span><span class="na">getRoles</span><span class="p">().</span><span class="na">stream</span><span class="p">()</span>
<a id="__codelineno-9-24" name="__codelineno-9-24"></a><span class="w">        </span><span class="p">.</span><span class="na">map</span><span class="p">(</span><span class="n">role</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">SimpleGrantedAuthority</span><span class="p">(</span><span class="n">role</span><span class="p">.</span><span class="na">getName</span><span class="p">().</span><span class="na">name</span><span class="p">()))</span>
<a id="__codelineno-9-25" name="__codelineno-9-25"></a><span class="w">        </span><span class="p">.</span><span class="na">collect</span><span class="p">(</span><span class="n">Collectors</span><span class="p">.</span><span class="na">toList</span><span class="p">());</span>
<a id="__codelineno-9-26" name="__codelineno-9-26"></a>
<a id="__codelineno-9-27" name="__codelineno-9-27"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">UserDetailsImpl</span><span class="p">(</span>
<a id="__codelineno-9-28" name="__codelineno-9-28"></a><span class="w">        </span><span class="n">user</span><span class="p">.</span><span class="na">getId</span><span class="p">(),</span><span class="w"> </span>
<a id="__codelineno-9-29" name="__codelineno-9-29"></a><span class="w">        </span><span class="n">user</span><span class="p">.</span><span class="na">getUsername</span><span class="p">(),</span><span class="w"> </span>
<a id="__codelineno-9-30" name="__codelineno-9-30"></a><span class="w">        </span><span class="n">user</span><span class="p">.</span><span class="na">getEmail</span><span class="p">(),</span>
<a id="__codelineno-9-31" name="__codelineno-9-31"></a><span class="w">        </span><span class="n">user</span><span class="p">.</span><span class="na">getPassword</span><span class="p">(),</span><span class="w"> </span>
<a id="__codelineno-9-32" name="__codelineno-9-32"></a><span class="w">        </span><span class="n">authorities</span><span class="p">);</span>
<a id="__codelineno-9-33" name="__codelineno-9-33"></a><span class="w">  </span><span class="p">}</span>
<a id="__codelineno-9-34" name="__codelineno-9-34"></a>
<a id="__codelineno-9-35" name="__codelineno-9-35"></a><span class="w">  </span><span class="nd">@Override</span>
<a id="__codelineno-9-36" name="__codelineno-9-36"></a><span class="w">  </span><span class="kd">public</span><span class="w"> </span><span class="n">Collection</span><span class="o">&lt;?</span><span class="w"> </span><span class="kd">extends</span><span class="w"> </span><span class="n">GrantedAuthority</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">getAuthorities</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-9-37" name="__codelineno-9-37"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">authorities</span><span class="p">;</span>
<a id="__codelineno-9-38" name="__codelineno-9-38"></a><span class="w">  </span><span class="p">}</span>
<a id="__codelineno-9-39" name="__codelineno-9-39"></a>
<a id="__codelineno-9-40" name="__codelineno-9-40"></a>
<a id="__codelineno-9-41" name="__codelineno-9-41"></a><span class="w">  </span><span class="nd">@Override</span>
<a id="__codelineno-9-42" name="__codelineno-9-42"></a><span class="w">  </span><span class="kd">public</span><span class="w"> </span><span class="kt">boolean</span><span class="w"> </span><span class="nf">isAccountNonExpired</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-9-43" name="__codelineno-9-43"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span>
<a id="__codelineno-9-44" name="__codelineno-9-44"></a><span class="w">  </span><span class="p">}</span>
<a id="__codelineno-9-45" name="__codelineno-9-45"></a>
<a id="__codelineno-9-46" name="__codelineno-9-46"></a><span class="w">  </span><span class="nd">@Override</span>
<a id="__codelineno-9-47" name="__codelineno-9-47"></a><span class="w">  </span><span class="kd">public</span><span class="w"> </span><span class="kt">boolean</span><span class="w"> </span><span class="nf">isAccountNonLocked</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-9-48" name="__codelineno-9-48"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span>
<a id="__codelineno-9-49" name="__codelineno-9-49"></a><span class="w">  </span><span class="p">}</span>
<a id="__codelineno-9-50" name="__codelineno-9-50"></a>
<a id="__codelineno-9-51" name="__codelineno-9-51"></a><span class="w">  </span><span class="nd">@Override</span>
<a id="__codelineno-9-52" name="__codelineno-9-52"></a><span class="w">  </span><span class="kd">public</span><span class="w"> </span><span class="kt">boolean</span><span class="w"> </span><span class="nf">isCredentialsNonExpired</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-9-53" name="__codelineno-9-53"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span>
<a id="__codelineno-9-54" name="__codelineno-9-54"></a><span class="w">  </span><span class="p">}</span>
<a id="__codelineno-9-55" name="__codelineno-9-55"></a>
<a id="__codelineno-9-56" name="__codelineno-9-56"></a><span class="w">  </span><span class="nd">@Override</span>
<a id="__codelineno-9-57" name="__codelineno-9-57"></a><span class="w">  </span><span class="kd">public</span><span class="w"> </span><span class="kt">boolean</span><span class="w"> </span><span class="nf">isEnabled</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-9-58" name="__codelineno-9-58"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span>
<a id="__codelineno-9-59" name="__codelineno-9-59"></a><span class="w">  </span><span class="p">}</span>
<a id="__codelineno-9-60" name="__codelineno-9-60"></a>
<a id="__codelineno-9-61" name="__codelineno-9-61"></a><span class="p">}</span>
</code></pre></div></td></tr></table></div>
<p>Tingues en compte que:</p>
<ul>
<li>Utilitzem <code>private Collection&lt;? extends GrantedAuthority&gt; authorities;</code> per emmagatzemar les autoritats (és a dir, rols) en un format que és entès per Spring Security.</li>
<li>En lloc de crear un constructor, creem un <code>builder()</code>, que rep un <code>User</code>, extreu la informació d'aquest i transforma la <code>List&lt;Role&gt;</code> en autoritats, i després, el builder crida al constructor.</li>
</ul>
<p>En lloc de crear un <code>User</code> i <code>Role</code> <code>Service</code>, crearem un <code>UserDetailSeriveImpl</code> (que implementa <code>UserDetailService</code> de Spring), per tal de recuperar un <code>User</code> del repositori, i després retorna un <code>UserDetailImpl</code>, de la següent manera:</p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Java</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-10-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-10-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-10-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-10-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-10-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-10-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-10-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-10-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-10-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-10-10">10</a></span>
<span class="normal"><a href="#__codelineno-10-11">11</a></span>
<span class="normal"><a href="#__codelineno-10-12">12</a></span>
<span class="normal"><a href="#__codelineno-10-13">13</a></span>
<span class="normal"><a href="#__codelineno-10-14">14</a></span>
<span class="normal"><a href="#__codelineno-10-15">15</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-10-1" name="__codelineno-10-1"></a><span class="nd">@Service</span>
<a id="__codelineno-10-2" name="__codelineno-10-2"></a><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">UserDetailsServiceImpl</span><span class="w"> </span><span class="kd">implements</span><span class="w"> </span><span class="n">UserDetailsService</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-10-3" name="__codelineno-10-3"></a><span class="w">  </span><span class="nd">@Autowired</span>
<a id="__codelineno-10-4" name="__codelineno-10-4"></a><span class="w">  </span><span class="n">UserRepository</span><span class="w"> </span><span class="n">userRepository</span><span class="p">;</span>
<a id="__codelineno-10-5" name="__codelineno-10-5"></a>
<a id="__codelineno-10-6" name="__codelineno-10-6"></a><span class="w">  </span><span class="nd">@Override</span>
<a id="__codelineno-10-7" name="__codelineno-10-7"></a><span class="w">  </span><span class="nd">@Transactional</span>
<a id="__codelineno-10-8" name="__codelineno-10-8"></a><span class="w">  </span><span class="kd">public</span><span class="w"> </span><span class="n">UserDetails</span><span class="w"> </span><span class="nf">loadUserByUsername</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">username</span><span class="p">)</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">UsernameNotFoundException</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-10-9" name="__codelineno-10-9"></a><span class="w">    </span><span class="n">User</span><span class="w"> </span><span class="n">user</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">userRepository</span><span class="p">.</span><span class="na">findByUsername</span><span class="p">(</span><span class="n">username</span><span class="p">)</span>
<a id="__codelineno-10-10" name="__codelineno-10-10"></a><span class="w">        </span><span class="p">.</span><span class="na">orElseThrow</span><span class="p">(()</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">UsernameNotFoundException</span><span class="p">(</span><span class="s">&quot;User Not Found with username: &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">username</span><span class="p">));</span>
<a id="__codelineno-10-11" name="__codelineno-10-11"></a>
<a id="__codelineno-10-12" name="__codelineno-10-12"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">UserDetailsImpl</span><span class="p">.</span><span class="na">build</span><span class="p">(</span><span class="n">user</span><span class="p">);</span>
<a id="__codelineno-10-13" name="__codelineno-10-13"></a><span class="w">  </span><span class="p">}</span>
<a id="__codelineno-10-14" name="__codelineno-10-14"></a>
<a id="__codelineno-10-15" name="__codelineno-10-15"></a><span class="p">}</span>
</code></pre></div></td></tr></table></div>
<h3 id="25-carregues-de-dtos">2.5. Càrregues de DTO's</h3>
<p>En aquesta secció veurem les classes necessàries que emmagatzemen informació per a:</p>
<ul>
<li>Registrar un nou usuari, per rebre informació del client i emmagatzemar un nou usuari. Aquesta classe és <code>SignupRequest</code>.</li>
<li>Iniciar sessió d'un usuari, per accedir al nostre sistema. Aquesta classe és <code>LoginRequest</code>.</li>
<li><code>JwtResponse</code>, relacionada com a resposta a la sol·licitud d'inici de sessió. Aquesta resposta contindrà un <strong>Token JWT</strong>, utilitzat per autoritzar sol·licituds posteriors. Aquesta classe és <code>JwtResponse</code>.</li>
</ul>
<h3 id="26-signuprequest">2.6. SignupRequest</h3>
<p>Aquesta classe conté informació per registrar un nou usuari. Conté anotacions de validació.</p>
<p><div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Java</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-11-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-11-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-11-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-11-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-11-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-11-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-11-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-11-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-11-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-11-10">10</a></span>
<span class="normal"><a href="#__codelineno-11-11">11</a></span>
<span class="normal"><a href="#__codelineno-11-12">12</a></span>
<span class="normal"><a href="#__codelineno-11-13">13</a></span>
<span class="normal"><a href="#__codelineno-11-14">14</a></span>
<span class="normal"><a href="#__codelineno-11-15">15</a></span>
<span class="normal"><a href="#__codelineno-11-16">16</a></span>
<span class="normal"><a href="#__codelineno-11-17">17</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-11-1" name="__codelineno-11-1"></a><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">SignupRequest</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-11-2" name="__codelineno-11-2"></a><span class="w">  </span><span class="nd">@NotBlank</span>
<a id="__codelineno-11-3" name="__codelineno-11-3"></a><span class="w">  </span><span class="nd">@Size</span><span class="p">(</span><span class="n">min</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="n">max</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">20</span><span class="p">)</span>
<a id="__codelineno-11-4" name="__codelineno-11-4"></a><span class="w">  </span><span class="kd">private</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">username</span><span class="p">;</span>
<a id="__codelineno-11-5" name="__codelineno-11-5"></a>
<a id="__codelineno-11-6" name="__codelineno-11-6"></a><span class="w">  </span><span class="nd">@NotBlank</span>
<a id="__codelineno-11-7" name="__codelineno-11-7"></a><span class="w">  </span><span class="nd">@Size</span><span class="p">(</span><span class="n">max</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">50</span><span class="p">)</span>
<a id="__codelineno-11-8" name="__codelineno-11-8"></a><span class="w">  </span><span class="nd">@Email</span>
<a id="__codelineno-11-9" name="__codelineno-11-9"></a><span class="w">  </span><span class="kd">private</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">email</span><span class="p">;</span>
<a id="__codelineno-11-10" name="__codelineno-11-10"></a>
<a id="__codelineno-11-11" name="__codelineno-11-11"></a><span class="w">  </span><span class="kd">private</span><span class="w"> </span><span class="n">Set</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span><span class="w"> </span><span class="n">role</span><span class="p">;</span>
<a id="__codelineno-11-12" name="__codelineno-11-12"></a>
<a id="__codelineno-11-13" name="__codelineno-11-13"></a><span class="w">  </span><span class="nd">@NotBlank</span>
<a id="__codelineno-11-14" name="__codelineno-11-14"></a><span class="w">  </span><span class="nd">@Size</span><span class="p">(</span><span class="n">min</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">6</span><span class="p">,</span><span class="w"> </span><span class="n">max</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">40</span><span class="p">)</span>
<a id="__codelineno-11-15" name="__codelineno-11-15"></a><span class="w">  </span><span class="kd">private</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">password</span><span class="p">;</span>
<a id="__codelineno-11-16" name="__codelineno-11-16"></a>
<a id="__codelineno-11-17" name="__codelineno-11-17"></a><span class="w">  </span><span class="c1">// get and set</span>
</code></pre></div></td></tr></table></div>
Per enviar aquesta informació, l'objecte json rebut serà semblant a:</p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">JSON</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-12-1">1</a></span>
<span class="normal"><a href="#__codelineno-12-2">2</a></span>
<span class="normal"><a href="#__codelineno-12-3">3</a></span>
<span class="normal"><a href="#__codelineno-12-4">4</a></span>
<span class="normal"><a href="#__codelineno-12-5">5</a></span>
<span class="normal"><a href="#__codelineno-12-6">6</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-12-1" name="__codelineno-12-1"></a><span class="p">{</span>
<a id="__codelineno-12-2" name="__codelineno-12-2"></a><span class="w">    </span><span class="nt">&quot;username&quot;</span><span class="p">:</span><span class="s2">&quot;joange&quot;</span><span class="p">,</span>
<a id="__codelineno-12-3" name="__codelineno-12-3"></a><span class="w">    </span><span class="nt">&quot;email&quot;</span><span class="p">:</span><span class="s2">&quot;jg.camarenaestruch@edu.gva.es&quot;</span><span class="p">,</span>
<a id="__codelineno-12-4" name="__codelineno-12-4"></a><span class="w">    </span><span class="nt">&quot;password&quot;</span><span class="p">:</span><span class="s2">&quot;123456&quot;</span><span class="p">,</span>
<a id="__codelineno-12-5" name="__codelineno-12-5"></a><span class="w">    </span><span class="nt">&quot;role&quot;</span><span class="p">:[</span><span class="s2">&quot;admin&quot;</span><span class="p">,</span><span class="s2">&quot;user&quot;</span><span class="p">]</span>
<a id="__codelineno-12-6" name="__codelineno-12-6"></a><span class="p">}</span>
</code></pre></div></td></tr></table></div>
<h3 id="27-loginrequest">2.7. LoginRequest</h3>
<p>Molt senzilla:</p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Java</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-13-1">1</a></span>
<span class="normal"><a href="#__codelineno-13-2">2</a></span>
<span class="normal"><a href="#__codelineno-13-3">3</a></span>
<span class="normal"><a href="#__codelineno-13-4">4</a></span>
<span class="normal"><a href="#__codelineno-13-5">5</a></span>
<span class="normal"><a href="#__codelineno-13-6">6</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-13-1" name="__codelineno-13-1"></a><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">LoginRequest</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-13-2" name="__codelineno-13-2"></a><span class="w">    </span><span class="nd">@NotBlank</span>
<a id="__codelineno-13-3" name="__codelineno-13-3"></a><span class="w">  </span><span class="kd">private</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">username</span><span class="p">;</span>
<a id="__codelineno-13-4" name="__codelineno-13-4"></a>
<a id="__codelineno-13-5" name="__codelineno-13-5"></a><span class="w">    </span><span class="nd">@NotBlank</span>
<a id="__codelineno-13-6" name="__codelineno-13-6"></a><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">password</span><span class="p">;</span>
</code></pre></div></td></tr></table></div>
<p>i l'objecte json associat serà:</p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">JSON</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-14-1">1</a></span>
<span class="normal"><a href="#__codelineno-14-2">2</a></span>
<span class="normal"><a href="#__codelineno-14-3">3</a></span>
<span class="normal"><a href="#__codelineno-14-4">4</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-14-1" name="__codelineno-14-1"></a><span class="p">{</span>
<a id="__codelineno-14-2" name="__codelineno-14-2"></a><span class="w">    </span><span class="nt">&quot;username&quot;</span><span class="p">:</span><span class="s2">&quot;joange&quot;</span><span class="p">,</span>
<a id="__codelineno-14-3" name="__codelineno-14-3"></a><span class="w">    </span><span class="nt">&quot;password&quot;</span><span class="p">:</span><span class="s2">&quot;123456&quot;</span>
<a id="__codelineno-14-4" name="__codelineno-14-4"></a><span class="p">}</span>
</code></pre></div></td></tr></table></div>
<div class="admonition note">
<p class="admonition-title">Atenció</p>
<p>En aquesta classe podem marcar els camps com a obligatoris, amb l'anotació <code>@NotBlank</code> de <code>javax.validation.constraints.NotBlank</code>. Has d'afegir:
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">XML</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-15-1">1</a></span>
<span class="normal"><a href="#__codelineno-15-2">2</a></span>
<span class="normal"><a href="#__codelineno-15-3">3</a></span>
<span class="normal"><a href="#__codelineno-15-4">4</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-15-1" name="__codelineno-15-1"></a><span class="w">    </span><span class="nt">&lt;dependency&gt;</span>
<a id="__codelineno-15-2" name="__codelineno-15-2"></a><span class="w">        </span><span class="nt">&lt;groupId&gt;</span>org.springframework.boot<span class="nt">&lt;/groupId&gt;</span>
<a id="__codelineno-15-3" name="__codelineno-15-3"></a><span class="w">        </span><span class="nt">&lt;artifactId&gt;</span>spring-boot-starter-validation<span class="nt">&lt;/artifactId&gt;</span>
<a id="__codelineno-15-4" name="__codelineno-15-4"></a><span class="w">    </span><span class="nt">&lt;/dependency&gt;</span>
</code></pre></div></td></tr></table></div></p>
</div>
<h3 id="28-jwtresponse">2.8. JwtResponse</h3>
<p>Aquesta classe DTO és la classe que es retorna com a sol·licitud de <em>login</em>. Ha de contenir poca informació sobre el nostre usuari i el més important, un token JWT. Aquest token s'utilitzarà per autoritzar-nos, com estudiarem a la següent secció.</p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Java</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-16-1">1</a></span>
<span class="normal"><a href="#__codelineno-16-2">2</a></span>
<span class="normal"><a href="#__codelineno-16-3">3</a></span>
<span class="normal"><a href="#__codelineno-16-4">4</a></span>
<span class="normal"><a href="#__codelineno-16-5">5</a></span>
<span class="normal"><a href="#__codelineno-16-6">6</a></span>
<span class="normal"><a href="#__codelineno-16-7">7</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-16-1" name="__codelineno-16-1"></a><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">JwtResponse</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-16-2" name="__codelineno-16-2"></a><span class="w">  </span><span class="kd">private</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">token</span><span class="p">;</span>
<a id="__codelineno-16-3" name="__codelineno-16-3"></a><span class="w">  </span><span class="kd">private</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;Bearer&quot;</span><span class="p">;</span>
<a id="__codelineno-16-4" name="__codelineno-16-4"></a><span class="w">  </span><span class="kd">private</span><span class="w"> </span><span class="n">Long</span><span class="w"> </span><span class="n">id</span><span class="p">;</span>
<a id="__codelineno-16-5" name="__codelineno-16-5"></a><span class="w">  </span><span class="kd">private</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">username</span><span class="p">;</span>
<a id="__codelineno-16-6" name="__codelineno-16-6"></a><span class="w">  </span><span class="kd">private</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">email</span><span class="p">;</span>
<a id="__codelineno-16-7" name="__codelineno-16-7"></a><span class="w">  </span><span class="kd">private</span><span class="w"> </span><span class="n">List</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span><span class="w"> </span><span class="n">roles</span><span class="p">;</span>
</code></pre></div></td></tr></table></div>
<p>Tingues en compte que:</p>
<ul>
<li>Els camps d'aquesta classe es poblaran a partir de la classe <code>User</code>, com un DTO.</li>
<li>Hem canviat el format del rol, de la classe <code>Role</code> a <code>String</code>, amb una millor gestió en els clients.</li>
<li>El <code>String token</code> és on s'emmagatzema el token JWT. De fet, un token és una cadena de text, com mostrarem ara.</li>
</ul>
<h2 id="3-tokens-jwt">3. Tokens JWT</h2>
<h3 id="31-que-es-un-token">3.1. Què és un token?</h3>
<p>JSON Web Tokens (JWT) s'han introduït com un mètode de securitzar la comunicació segura entre dues parts. Es va introduir amb l'especificació RFC 7519 per l'Internet Engineering Task Force (IETF).
Tot i que podem utilitzar <code>JWT</code> amb qualsevol tipus de mètode de comunicació, avui en dia, JWT és molt popular per gestionar l'<strong>autenticació</strong> i l'<strong>autorització</strong> sobre HTTP.</p>
<p>Primer, necessitaràs conèixer algunes característiques de HTTP:</p>
<ul>
<li>HTTP és un protocol <em>sense estat</em>, el que significa que una sol·licitud HTTP no manté l'estat. El servidor no és conscient de cap sol·licitud anterior enviada pel mateix client.</li>
<li>Les sol·licituds HTTP haurien de ser <em>autònomes</em>. Han d'incloure informació sobre sol·licituds anteriors que l'usuari ha fet en la mateixa sol·licitud.</li>
</ul>
<p>Hi ha algunes maneres de fer això, però la manera més popular és establir un <strong>session_id</strong>, que és una referència a la informació de l'usuari:</p>
<ul>
<li>El servidor emmagatzemarà aquest ID de sessió en memòria o en una base de dades. El client enviarà cada sol·licitud amb aquest ID de sessió.</li>
<li>El servidor pot obtenir informació sobre el client utilitzant aquesta referència.</li>
<li>Normalment, aquest ID de sessió s'envia a l'usuari com una <strong>cookie</strong>.</li>
</ul>
<p>Aquí tens el diagrama de com funciona l'autenticació basada en sessions.</p>
<center>![authentication-and-authorization-in-expressjs-using-jwt-1](./img/authentication-and-authorization-in-expressjs-using-jwt-1.png){width=95%}</center>

<p>D'altra banda, amb JWT, quan el client envia una sol·licitud d'autenticació al servidor, aquest enviarà un <strong>token</strong> JSON al client, que inclou tota la informació sobre l'usuari juntament amb la resposta.</p>
<p>El client enviarà aquest token amb <strong>totes</strong> les sol·licituds posteriors. Per tant, el servidor no haurà d'emmagatzemar cap informació sobre la sessió. Però hi ha un problema amb aquest enfocament. Qualsevol pot enviar una sol·licitud falsa amb un token JSON fals i fer-se passar per algú que no és.</p>
<p>Per exemple, suposem que després de l'autenticació, el servidor retorna un objecte JSON al client amb el nom d'usuari i el temps d'expiració. Així, com que l'objecte JSON és llegible, qualsevol pot editar aquesta informació i enviar una sol·licitud amb ella. El problema és que no hi ha manera de validar aquesta sol·licitud.</p>
<p>Aquí és on entra en joc la <strong>signatura testimoni</strong>. Així que en lloc d'enviar només un token JSON normal, el servidor enviarà un token signat, que pot verificar que la informació no ha canviat.</p>
<center>![authentication-and-authorization-in-expressjs-using-jwt-2](./img/authentication-and-authorization-in-expressjs-using-jwt-2.png){width=95%}</center>

<h3 id="32-estructura-dun-jwt">3.2. Estructura d'un JWT</h3>
<p>Parlem de l'estructura d'un JWT a través d'un token d'exemple:</p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">JSON</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-17-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-17-1" name="__codelineno-17-1"></a><span class="err">eyJhbGciOiJIUzI</span><span class="mi">1</span><span class="err">NiIsI</span><span class="kc">n</span><span class="err">R</span><span class="mi">5</span><span class="err">cCI</span><span class="mi">6</span><span class="err">IkpXVCJ</span><span class="mf">9.e</span><span class="err">yJzdWIiOiIxMjM</span><span class="mi">0</span><span class="err">NTY</span><span class="mi">3</span><span class="err">ODkwIiwibmF</span><span class="kc">t</span><span class="err">ZSI</span><span class="mi">6</span><span class="err">IkpvaG</span><span class="mi">4</span><span class="err">gRG</span><span class="mi">9</span><span class="err">lIiwiaWF</span><span class="mi">0</span><span class="err">IjoxNTE</span><span class="mi">2</span><span class="err">MjM</span><span class="mi">5</span><span class="err">MDIy</span><span class="kc">f</span><span class="err">Q.S</span><span class="kc">fl</span><span class="err">KxwRJSMeKKF</span><span class="mi">2</span><span class="err">QT</span><span class="mi">4</span><span class="kc">f</span><span class="err">wpMeJ</span><span class="kc">f</span><span class="mi">36</span><span class="err">POk</span><span class="mi">6</span><span class="err">yJV_adQssw</span><span class="mi">5</span><span class="err">c</span>
</code></pre></div></td></tr></table></div>
<p>Com podeu veure, hi ha tres seccions en aquest JWT, cadascuna separada per un punt.</p>
<div class="admonition note">
<p class="admonition-title">Nota</p>
</div>
<p>La codificació <code>Base64</code> és una manera d'assegurar que les dades no es corrompin, ja que no comprimeixen ni xifren les dades, sinó que simplement les codifiquen d'una manera que la majoria dels sistemes poden entendre. Podeu llegir qualsevol text codificat en Base64 simplement descodificant-lo.</p>
<p>La primera secció del JWT és un <strong>header</strong>, que és una cadena codificada en Base64. Si descodifiqueu el header, es veuria així:</p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">JSON</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-18-1">1</a></span>
<span class="normal"><a href="#__codelineno-18-2">2</a></span>
<span class="normal"><a href="#__codelineno-18-3">3</a></span>
<span class="normal"><a href="#__codelineno-18-4">4</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-18-1" name="__codelineno-18-1"></a><span class="p">{</span>
<a id="__codelineno-18-2" name="__codelineno-18-2"></a><span class="w">   </span><span class="nt">&quot;alg&quot;</span><span class="p">:</span><span class="s2">&quot;HS256&quot;</span><span class="p">,</span>
<a id="__codelineno-18-3" name="__codelineno-18-3"></a><span class="w">   </span><span class="nt">&quot;typ&quot;</span><span class="p">:</span><span class="s2">&quot;JWT&quot;</span>
<a id="__codelineno-18-4" name="__codelineno-18-4"></a><span class="p">}</span>
</code></pre></div></td></tr></table></div>
<p>La secció del header conté l'algoritme de hash, que es va utilitzar per generar la signatura del token i el tipus.</p>
<p>La segona secció és el <strong>payload</strong> que conté l'objecte JSON que es va enviar de tornada a l'usuari. Com que només està codificat en Base64, qualsevol pot descodificar-lo fàcilment. És obligatori no incloure dades sensibles en els JWT, com ara contrasenyes o informació personal identificable.</p>
<p>Normalment, el cos del JWT es veurà així, tot i que no necessàriament s'aplica:</p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">JSON</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-19-1">1</a></span>
<span class="normal"><a href="#__codelineno-19-2">2</a></span>
<span class="normal"><a href="#__codelineno-19-3">3</a></span>
<span class="normal"><a href="#__codelineno-19-4">4</a></span>
<span class="normal"><a href="#__codelineno-19-5">5</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-19-1" name="__codelineno-19-1"></a><span class="p">{</span>
<a id="__codelineno-19-2" name="__codelineno-19-2"></a><span class="w">   </span><span class="nt">&quot;sub&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;1234567890&quot;</span><span class="p">,</span>
<a id="__codelineno-19-3" name="__codelineno-19-3"></a><span class="w">   </span><span class="nt">&quot;name&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;John Doe&quot;</span><span class="p">,</span>
<a id="__codelineno-19-4" name="__codelineno-19-4"></a><span class="w">   </span><span class="nt">&quot;iat&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">1516239022</span>
<a id="__codelineno-19-5" name="__codelineno-19-5"></a><span class="p">}</span>
</code></pre></div></td></tr></table></div>
<div class="admonition note">
<p class="admonition-title">Nota</p>
</div>
<p>La majoria de les vegades, la propietat <code>sub</code> contindrà l'ID de l'usuari, la propietat <code>iat</code> (<em>issued at</em>), abreujada com <code>emès a</code>, és el segell de temps d'emissió del token. També podeu veure algunes propietats comunes, com ara <code>eat</code> o <code>exp</code>, que és el temps d'expiració del token.</p>
<p>Totes aquestes propietats són els <strong>claims</strong> del token, la informació.</p>
<p>La secció final és la signatura del token. Aquesta es genera fent un hash de la cadena creada amb les dues seccions anteriors i una contrasenya secreta, utilitzant l'algoritme esmentat a la secció del header.</p>
<p>Podeu visitar <a href="https://www.javainuse.com/jwtgenerator">https://www.javainuse.com/jwtgenerator</a> i <a href="https://jwt.io">https://jwt.io</a> per generar tokens i provar amb diverses dades, secrets i hashes.</p>
<center>![authentication-and-authorization-in-expressjs-using-jwt-3](./img/authentication-and-authorization-in-expressjs-using-jwt-3.png){width=95%}</center>

<h3 id="33-jwt-library-class">3.3. JWT Library class</h3>
<p>Afegirem al <code>pom.xml</code> les següents dependències:</p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">XML</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-20-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-20-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-20-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-20-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-20-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-20-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-20-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-20-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-20-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-20-10">10</a></span>
<span class="normal"><a href="#__codelineno-20-11">11</a></span>
<span class="normal"><a href="#__codelineno-20-12">12</a></span>
<span class="normal"><a href="#__codelineno-20-13">13</a></span>
<span class="normal"><a href="#__codelineno-20-14">14</a></span>
<span class="normal"><a href="#__codelineno-20-15">15</a></span>
<span class="normal"><a href="#__codelineno-20-16">16</a></span>
<span class="normal"><a href="#__codelineno-20-17">17</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-20-1" name="__codelineno-20-1"></a><span class="nt">&lt;dependency&gt;</span>
<a id="__codelineno-20-2" name="__codelineno-20-2"></a><span class="w">  </span><span class="nt">&lt;groupId&gt;</span>io.jsonwebtoken<span class="nt">&lt;/groupId&gt;</span>
<a id="__codelineno-20-3" name="__codelineno-20-3"></a><span class="w">  </span><span class="nt">&lt;artifactId&gt;</span>jjwt-api<span class="nt">&lt;/artifactId&gt;</span>
<a id="__codelineno-20-4" name="__codelineno-20-4"></a><span class="w">  </span><span class="nt">&lt;version&gt;</span>0.10.7<span class="nt">&lt;/version&gt;</span>
<a id="__codelineno-20-5" name="__codelineno-20-5"></a><span class="nt">&lt;/dependency&gt;</span>
<a id="__codelineno-20-6" name="__codelineno-20-6"></a><span class="nt">&lt;dependency&gt;</span>
<a id="__codelineno-20-7" name="__codelineno-20-7"></a><span class="w">  </span><span class="nt">&lt;groupId&gt;</span>io.jsonwebtoken<span class="nt">&lt;/groupId&gt;</span>
<a id="__codelineno-20-8" name="__codelineno-20-8"></a><span class="w">  </span><span class="nt">&lt;artifactId&gt;</span>jjwt-impl<span class="nt">&lt;/artifactId&gt;</span>
<a id="__codelineno-20-9" name="__codelineno-20-9"></a><span class="w">  </span><span class="nt">&lt;version&gt;</span>0.10.7<span class="nt">&lt;/version&gt;</span>
<a id="__codelineno-20-10" name="__codelineno-20-10"></a><span class="w">  </span><span class="nt">&lt;scope&gt;</span>runtime<span class="nt">&lt;/scope&gt;</span>
<a id="__codelineno-20-11" name="__codelineno-20-11"></a><span class="nt">&lt;/dependency&gt;</span>
<a id="__codelineno-20-12" name="__codelineno-20-12"></a><span class="nt">&lt;dependency&gt;</span>
<a id="__codelineno-20-13" name="__codelineno-20-13"></a><span class="w">  </span><span class="nt">&lt;groupId&gt;</span>io.jsonwebtoken<span class="nt">&lt;/groupId&gt;</span>
<a id="__codelineno-20-14" name="__codelineno-20-14"></a><span class="w">  </span><span class="nt">&lt;artifactId&gt;</span>jjwt-jackson<span class="nt">&lt;/artifactId&gt;</span>
<a id="__codelineno-20-15" name="__codelineno-20-15"></a><span class="w">  </span><span class="nt">&lt;version&gt;</span>0.10.7<span class="nt">&lt;/version&gt;</span>
<a id="__codelineno-20-16" name="__codelineno-20-16"></a><span class="w">  </span><span class="nt">&lt;scope&gt;</span>runtime<span class="nt">&lt;/scope&gt;</span>
<a id="__codelineno-20-17" name="__codelineno-20-17"></a><span class="nt">&lt;/dependency&gt;</span>
</code></pre></div></td></tr></table></div>
<p>Aquesta classe és la que genera i comprova la integritat dels tokens. Anem a mostrar aquesta classe i quins elements necessita. Aquesta classe serà una classe de biblioteca amb mètodes per crear tokens, validar-los i extreure informació d'ells. Podem trobar aquesta classe amb noms com <code>JWTUtils</code> o <code>JWTTokenProvider</code>. L'esquelet d'aquesta classe és el següent:</p>
<ul>
<li>Càrrega o definició de constants del token</li>
<li>Mètode per generar JWT a partir d'un objecte <code>Authentication</code></li>
<li>Mètodes per obtenir informació del token</li>
<li>Mètode per validar el token (signatura)</li>
</ul>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Java</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-21-1">1</a></span>
<span class="normal"><a href="#__codelineno-21-2">2</a></span>
<span class="normal"><a href="#__codelineno-21-3">3</a></span>
<span class="normal"><a href="#__codelineno-21-4">4</a></span>
<span class="normal"><a href="#__codelineno-21-5">5</a></span>
<span class="normal"><a href="#__codelineno-21-6">6</a></span>
<span class="normal"><a href="#__codelineno-21-7">7</a></span>
<span class="normal"><a href="#__codelineno-21-8">8</a></span>
<span class="normal"><a href="#__codelineno-21-9">9</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-21-1" name="__codelineno-21-1"></a><span class="c1">// constants and secrets</span>
<a id="__codelineno-21-2" name="__codelineno-21-2"></a>
<a id="__codelineno-21-3" name="__codelineno-21-3"></a><span class="w">  </span><span class="kd">public</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="nf">generateJwtToken</span><span class="p">(</span><span class="n">Authentication</span><span class="w"> </span><span class="n">authentication</span><span class="p">);</span>
<a id="__codelineno-21-4" name="__codelineno-21-4"></a>
<a id="__codelineno-21-5" name="__codelineno-21-5"></a><span class="w">  </span><span class="kd">public</span><span class="w"> </span><span class="kt">boolean</span><span class="w"> </span><span class="nf">validateJwtToken</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">authToken</span><span class="p">);</span>
<a id="__codelineno-21-6" name="__codelineno-21-6"></a>
<a id="__codelineno-21-7" name="__codelineno-21-7"></a><span class="w">  </span><span class="kd">public</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="nf">getUserNameFromJwtToken</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">token</span><span class="p">);</span>
<a id="__codelineno-21-8" name="__codelineno-21-8"></a>
<a id="__codelineno-21-9" name="__codelineno-21-9"></a><span class="w">  </span><span class="c1">// another methods.</span>
</code></pre></div></td></tr></table></div>
<h3 id="34-generar-tokens">3.4. Generar Tokens</h3>
<p>Vegem cada mètode. Primer, necessitem un objecte <code>Authentication</code>. Hem de saber que aquest objecte representa un altre token (no el nostre JWT) amb les credencials de l'objecte que volem identificar.</p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Java</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-22-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-22-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-22-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-22-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-22-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-22-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-22-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-22-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-22-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-22-10">10</a></span>
<span class="normal"><a href="#__codelineno-22-11">11</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-22-1" name="__codelineno-22-1"></a><span class="kd">public</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="nf">generateJwtToken</span><span class="p">(</span><span class="n">Authentication</span><span class="w"> </span><span class="n">authentication</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-22-2" name="__codelineno-22-2"></a>
<a id="__codelineno-22-3" name="__codelineno-22-3"></a><span class="w">    </span><span class="n">UserDetailsImpl</span><span class="w"> </span><span class="n">userPrincipal</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">UserDetailsImpl</span><span class="p">)</span><span class="w"> </span><span class="n">authentication</span><span class="p">.</span><span class="na">getPrincipal</span><span class="p">();</span>
<a id="__codelineno-22-4" name="__codelineno-22-4"></a>
<a id="__codelineno-22-5" name="__codelineno-22-5"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">Jwts</span><span class="p">.</span><span class="na">builder</span><span class="p">()</span>
<a id="__codelineno-22-6" name="__codelineno-22-6"></a><span class="w">        </span><span class="p">.</span><span class="na">setSubject</span><span class="p">((</span><span class="n">userPrincipal</span><span class="p">.</span><span class="na">getUsername</span><span class="p">()))</span>
<a id="__codelineno-22-7" name="__codelineno-22-7"></a><span class="w">        </span><span class="p">.</span><span class="na">setIssuedAt</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">Date</span><span class="p">())</span>
<a id="__codelineno-22-8" name="__codelineno-22-8"></a><span class="w">        </span><span class="p">.</span><span class="na">setExpiration</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">Date</span><span class="p">((</span><span class="k">new</span><span class="w"> </span><span class="n">Date</span><span class="p">()).</span><span class="na">getTime</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">jwtExpirationMs</span><span class="p">))</span>
<a id="__codelineno-22-9" name="__codelineno-22-9"></a><span class="w">        </span><span class="p">.</span><span class="na">signWith</span><span class="p">(</span><span class="n">SignatureAlgorithm</span><span class="p">.</span><span class="na">HS512</span><span class="p">,</span><span class="w"> </span><span class="n">jwtSecret</span><span class="p">)</span>
<a id="__codelineno-22-10" name="__codelineno-22-10"></a><span class="w">        </span><span class="p">.</span><span class="na">compact</span><span class="p">();</span>
<a id="__codelineno-22-11" name="__codelineno-22-11"></a><span class="w">  </span><span class="p">}</span>
</code></pre></div></td></tr></table></div>
<p>Veiem que:</p>
<ul>
<li>Rebem un objecte <code>Authentication</code>, en el qual hem guardat un <code>UserDetailsImpl</code>. Com totes les implementacions de detalls d'usuari, podem obtenir el nom d'usuari, i l'utilitzem per establir el subjecte del token.</li>
<li>Establim <code>IAT</code> al moment actual.</li>
<li>Establim el temps d'expiració.</li>
<li>Establim l'algoritme de xifrat i la paraula secreta, i el token està llest per...</li>
<li>El mètode <code>compact()</code> crea i transforma el token a String.</li>
</ul>
<div class="admonition note">
<p class="admonition-title">Nota</p>
</div>
<p>El <code>jwtSecret</code> és la contrasenya que necessitem. És una bona idea emmagatzemar-la dins de <code>application.properties</code> i recuperar-la a una variable, com <code>jwtExpiration</code>. Podem utilitzar l'anotació <code>@Value</code>:</p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Java</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-23-1">1</a></span>
<span class="normal"><a href="#__codelineno-23-2">2</a></span>
<span class="normal"><a href="#__codelineno-23-3">3</a></span>
<span class="normal"><a href="#__codelineno-23-4">4</a></span>
<span class="normal"><a href="#__codelineno-23-5">5</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-23-1" name="__codelineno-23-1"></a><span class="w">  </span><span class="nd">@Value</span><span class="p">(</span><span class="s">&quot;${app.jwtSecret}&quot;</span><span class="p">)</span>
<a id="__codelineno-23-2" name="__codelineno-23-2"></a><span class="w">  </span><span class="kd">private</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">jwtSecret</span><span class="p">;</span>
<a id="__codelineno-23-3" name="__codelineno-23-3"></a>
<a id="__codelineno-23-4" name="__codelineno-23-4"></a><span class="w">  </span><span class="nd">@Value</span><span class="p">(</span><span class="s">&quot;${app.jwtExpirationMs}&quot;</span><span class="p">)</span>
<a id="__codelineno-23-5" name="__codelineno-23-5"></a><span class="w">  </span><span class="kd">private</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">jwtExpirationMs</span><span class="p">;</span>
</code></pre></div></td></tr></table></div>
<h3 id="35-validacio-de-tokens">3.5. Validació de Tokens</h3>
<p>Molt fàcil:</p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Java</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-24-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-24-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-24-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-24-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-24-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-24-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-24-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-24-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-24-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-24-10">10</a></span>
<span class="normal"><a href="#__codelineno-24-11">11</a></span>
<span class="normal"><a href="#__codelineno-24-12">12</a></span>
<span class="normal"><a href="#__codelineno-24-13">13</a></span>
<span class="normal"><a href="#__codelineno-24-14">14</a></span>
<span class="normal"><a href="#__codelineno-24-15">15</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-24-1" name="__codelineno-24-1"></a><span class="kd">public</span><span class="w"> </span><span class="kt">boolean</span><span class="w"> </span><span class="nf">validateJwtToken</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">authToken</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-24-2" name="__codelineno-24-2"></a><span class="w">    </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-24-3" name="__codelineno-24-3"></a><span class="w">      </span><span class="n">Jwts</span><span class="p">.</span><span class="na">parser</span><span class="p">().</span><span class="na">setSigningKey</span><span class="p">(</span><span class="n">jwtSecret</span><span class="p">).</span><span class="na">parseClaimsJws</span><span class="p">(</span><span class="n">authToken</span><span class="p">);</span>
<a id="__codelineno-24-4" name="__codelineno-24-4"></a><span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span>
<a id="__codelineno-24-5" name="__codelineno-24-5"></a><span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">SignatureException</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-24-6" name="__codelineno-24-6"></a><span class="w">      </span><span class="n">logger</span><span class="p">.</span><span class="na">error</span><span class="p">(</span><span class="s">&quot;Invalid JWT signature: {}&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">e</span><span class="p">.</span><span class="na">getMessage</span><span class="p">());</span>
<a id="__codelineno-24-7" name="__codelineno-24-7"></a><span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">MalformedJwtException</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-24-8" name="__codelineno-24-8"></a><span class="w">      </span><span class="n">logger</span><span class="p">.</span><span class="na">error</span><span class="p">(</span><span class="s">&quot;Invalid JWT token: {}&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">e</span><span class="p">.</span><span class="na">getMessage</span><span class="p">());</span>
<a id="__codelineno-24-9" name="__codelineno-24-9"></a><span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">ExpiredJwtException</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-24-10" name="__codelineno-24-10"></a><span class="w">      </span><span class="n">logger</span><span class="p">.</span><span class="na">error</span><span class="p">(</span><span class="s">&quot;JWT token is expired: {}&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">e</span><span class="p">.</span><span class="na">getMessage</span><span class="p">());</span>
<a id="__codelineno-24-11" name="__codelineno-24-11"></a><span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">UnsupportedJwtException</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-24-12" name="__codelineno-24-12"></a><span class="w">      </span><span class="n">logger</span><span class="p">.</span><span class="na">error</span><span class="p">(</span><span class="s">&quot;JWT token is unsupported: {}&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">e</span><span class="p">.</span><span class="na">getMessage</span><span class="p">());</span>
<a id="__codelineno-24-13" name="__codelineno-24-13"></a><span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">IllegalArgumentException</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-24-14" name="__codelineno-24-14"></a><span class="w">      </span><span class="n">logger</span><span class="p">.</span><span class="na">error</span><span class="p">(</span><span class="s">&quot;JWT claims string is empty: {}&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">e</span><span class="p">.</span><span class="na">getMessage</span><span class="p">());</span>
<a id="__codelineno-24-15" name="__codelineno-24-15"></a><span class="w">    </span><span class="p">}</span>
</code></pre></div></td></tr></table></div>
<p>En aquest mètode comprovem si és un token vàlid. Utilitzem <code>parseClaimsJws(String token)</code>, després d'assignar la contrasenya secreta per obtenir els claims. Si hi ha algun problema amb la integritat del token, podria aparèixer una excepció. Obtenim els claims dins d'un bloc <code>try-catch</code> i informem si passa alguna cosa. Retornarem <code>true</code> si no es captura cap excepció.</p>
<div class="admonition note">
<p class="admonition-title">Nota</p>
</div>
<p>Recorda que els <em>claims</em> són el contingut del payload del token. No necessitem els claims en aquest mètode, només comprovar si tot està bé.</p>
<h2 id="4-authentication-controller">4. Authentication Controller</h2>
<p>Ara que també sabem com crear tokens i l'estructura de <code>User</code> a la nostra base de dades, és hora d'exposar el nostre camí per registrar i iniciar sessió d'usuaris. Per tant, només són obligatoris dos mètodes. La classe podria ser alguna cosa així:</p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Java</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-25-1">1</a></span>
<span class="normal"><a href="#__codelineno-25-2">2</a></span>
<span class="normal"><a href="#__codelineno-25-3">3</a></span>
<span class="normal"><a href="#__codelineno-25-4">4</a></span>
<span class="normal"><a href="#__codelineno-25-5">5</a></span>
<span class="normal"><a href="#__codelineno-25-6">6</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-25-1" name="__codelineno-25-1"></a><span class="nd">@CrossOrigin</span><span class="p">(</span><span class="n">origins</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;*&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">maxAge</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">3600</span><span class="p">)</span>
<a id="__codelineno-25-2" name="__codelineno-25-2"></a><span class="nd">@RestController</span>
<a id="__codelineno-25-3" name="__codelineno-25-3"></a><span class="nd">@RequestMapping</span><span class="p">(</span><span class="s">&quot;/api/auth&quot;</span><span class="p">)</span>
<a id="__codelineno-25-4" name="__codelineno-25-4"></a><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">AuthController</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-25-5" name="__codelineno-25-5"></a><span class="w">    </span><span class="p">...</span>
<a id="__codelineno-25-6" name="__codelineno-25-6"></a><span class="p">}</span>
</code></pre></div></td></tr></table></div>
<ul>
<li>L'anotació <code>@CrossOrigin</code> permet sol·licituds de cross-origin en classes de controlador específiques i/o mètodes de controlador. Es processa si es configura un <code>HandlerMapping</code> apropiat. El Cross-Origin Resource Sharing (<strong>CORS</strong>) és un concepte de seguretat que permet restringir els recursos implementats en navegadors web. Evita que el codi JavaScript produeixi o consumeixi sol·licituds contra un origen diferent. Per exemple, la vostra aplicació web s'està executant al port 8080 i mitjançant JavaScript esteu intentant consumir serveis web RESTful des del port 9090. En aquestes situacions, us trobareu amb el problema de seguretat de Cross-Origin Resource Sharing als vostres navegadors web.</li>
<li><code>@RequestMapping("/api/auth")</code> indica que tots els controladors estan dins del camí <code>/api/auth</code>.</li>
</ul>
<p>Vegem-los, però abans d'estudiar els mètodes, aquesta classe té aquestes variables necessàries:</p>
<ul>
<li><code>@Autowired AuthenticationManager authenticationManager;</code> → s'utilitza per crear un token d'<code>Authentication</code>, utilitzat pel context de seguretat de Spring i pel generador de tokens.</li>
<li><code>@Autowired UserRepository userRepository;</code> → s'utilitza per accedir i desar usuaris.</li>
<li><code>@Autowired RoleRepository roleRepository;</code> → per comprovar si els rols que arriben a la sol·licitud són vàlids.</li>
<li><code>@Autowired PasswordEncoder encoder;</code> → s'utilitza per encriptar la contrasenya de l'usuari.</li>
<li><code>@Autowired JwtUtils jwtUtils;</code> → s'utilitza per crear tokens JWT.</li>
</ul>
<p>Ara que hem presentat els actors, anem a la funció.</p>
<h3 id="41-signup-nou-usuari">4.1. Signup (nou usuari)</h3>
<p>El mètode encarregat de crear nous usuaris rebrà un <code>SignupRequest</code> amb aquestes dades:</p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">JSON</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-26-1">1</a></span>
<span class="normal"><a href="#__codelineno-26-2">2</a></span>
<span class="normal"><a href="#__codelineno-26-3">3</a></span>
<span class="normal"><a href="#__codelineno-26-4">4</a></span>
<span class="normal"><a href="#__codelineno-26-5">5</a></span>
<span class="normal"><a href="#__codelineno-26-6">6</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-26-1" name="__codelineno-26-1"></a><span class="p">{</span>
<a id="__codelineno-26-2" name="__codelineno-26-2"></a><span class="w">    </span><span class="nt">&quot;username&quot;</span><span class="p">:</span><span class="s2">&quot;joange&quot;</span><span class="p">,</span>
<a id="__codelineno-26-3" name="__codelineno-26-3"></a><span class="w">    </span><span class="nt">&quot;email&quot;</span><span class="p">:</span><span class="s2">&quot;jg.camarenaestruch@edu.gva.es&quot;</span><span class="p">,</span>
<a id="__codelineno-26-4" name="__codelineno-26-4"></a><span class="w">    </span><span class="nt">&quot;password&quot;</span><span class="p">:</span><span class="s2">&quot;123456&quot;</span><span class="p">,</span>
<a id="__codelineno-26-5" name="__codelineno-26-5"></a><span class="w">    </span><span class="nt">&quot;role&quot;</span><span class="p">:[</span><span class="s2">&quot;admin&quot;</span><span class="p">,</span><span class="s2">&quot;user&quot;</span><span class="p">]</span>
<a id="__codelineno-26-6" name="__codelineno-26-6"></a><span class="p">}</span>
</code></pre></div></td></tr></table></div>
<p>el cos del mètode és el següent, i vegem-ho per blocs:</p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Java</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-27-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-27-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-27-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-27-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-27-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-27-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-27-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-27-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-27-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-27-10">10</a></span>
<span class="normal"><a href="#__codelineno-27-11">11</a></span>
<span class="normal"><a href="#__codelineno-27-12">12</a></span>
<span class="normal"><a href="#__codelineno-27-13">13</a></span>
<span class="normal"><a href="#__codelineno-27-14">14</a></span>
<span class="normal"><a href="#__codelineno-27-15">15</a></span>
<span class="normal"><a href="#__codelineno-27-16">16</a></span>
<span class="normal"><a href="#__codelineno-27-17">17</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-27-1" name="__codelineno-27-1"></a><span class="nd">@PostMapping</span><span class="p">(</span><span class="s">&quot;/signup&quot;</span><span class="p">)</span>
<a id="__codelineno-27-2" name="__codelineno-27-2"></a><span class="w">  </span><span class="kd">public</span><span class="w"> </span><span class="n">ResponseEntity</span><span class="o">&lt;?&gt;</span><span class="w"> </span><span class="nf">registerUser</span><span class="p">(</span><span class="nd">@Valid</span><span class="w"> </span><span class="nd">@RequestBody</span><span class="w"> </span><span class="n">SignupRequest</span><span class="w"> </span><span class="n">signUpRequest</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-27-3" name="__codelineno-27-3"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">userRepository</span><span class="p">.</span><span class="na">existsByUsername</span><span class="p">(</span><span class="n">signUpRequest</span><span class="p">.</span><span class="na">getUsername</span><span class="p">()))</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-27-4" name="__codelineno-27-4"></a><span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="n">ResponseEntity</span>
<a id="__codelineno-27-5" name="__codelineno-27-5"></a><span class="w">          </span><span class="p">.</span><span class="na">badRequest</span><span class="p">()</span>
<a id="__codelineno-27-6" name="__codelineno-27-6"></a><span class="w">          </span><span class="p">.</span><span class="na">body</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">MessageResponse</span><span class="p">(</span><span class="s">&quot;Error: Username is already taken!&quot;</span><span class="p">));</span>
<a id="__codelineno-27-7" name="__codelineno-27-7"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-27-8" name="__codelineno-27-8"></a>
<a id="__codelineno-27-9" name="__codelineno-27-9"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">userRepository</span><span class="p">.</span><span class="na">existsByEmail</span><span class="p">(</span><span class="n">signUpRequest</span><span class="p">.</span><span class="na">getEmail</span><span class="p">()))</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-27-10" name="__codelineno-27-10"></a><span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="n">ResponseEntity</span>
<a id="__codelineno-27-11" name="__codelineno-27-11"></a><span class="w">          </span><span class="p">.</span><span class="na">badRequest</span><span class="p">()</span>
<a id="__codelineno-27-12" name="__codelineno-27-12"></a><span class="w">          </span><span class="p">.</span><span class="na">body</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">MessageResponse</span><span class="p">(</span><span class="s">&quot;Error: Email is already in use!&quot;</span><span class="p">));</span>
<a id="__codelineno-27-13" name="__codelineno-27-13"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-27-14" name="__codelineno-27-14"></a><span class="w">    </span><span class="c1">// Create new user&#39;s account</span>
<a id="__codelineno-27-15" name="__codelineno-27-15"></a><span class="w">    </span><span class="n">User</span><span class="w"> </span><span class="n">user</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">User</span><span class="p">(</span><span class="n">signUpRequest</span><span class="p">.</span><span class="na">getUsername</span><span class="p">(),</span><span class="w"> </span>
<a id="__codelineno-27-16" name="__codelineno-27-16"></a><span class="w">               </span><span class="n">signUpRequest</span><span class="p">.</span><span class="na">getEmail</span><span class="p">(),</span>
<a id="__codelineno-27-17" name="__codelineno-27-17"></a><span class="w">               </span><span class="n">encoder</span><span class="p">.</span><span class="na">encode</span><span class="p">(</span><span class="n">signUpRequest</span><span class="p">.</span><span class="na">getPassword</span><span class="p">()));</span>
</code></pre></div></td></tr></table></div>
<p>En aquesta primera part:</p>
<ul>
<li>Comprovem si existeix algun usuari amb el mateix nom d'usuari o correu electrònic, consultant el nostre repositori. Si apareix algun error, retornarem un <code>ResponseEntity</code> com a <em>bad request</em> amb un missatge descriptiu.</li>
<li>Finalment, creem un nou usuari amb nom d'usuari, correu electrònic i una contrasenya encriptada.</li>
</ul>
<p>El següent bloc és responsable d'obtenir els rols (emmagatzemats en un JSONArray de cadenes) i transformar-los en un <code>Set&lt;Role&gt;</code>.</p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Java</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-28-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-28-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-28-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-28-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-28-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-28-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-28-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-28-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-28-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-28-10">10</a></span>
<span class="normal"><a href="#__codelineno-28-11">11</a></span>
<span class="normal"><a href="#__codelineno-28-12">12</a></span>
<span class="normal"><a href="#__codelineno-28-13">13</a></span>
<span class="normal"><a href="#__codelineno-28-14">14</a></span>
<span class="normal"><a href="#__codelineno-28-15">15</a></span>
<span class="normal"><a href="#__codelineno-28-16">16</a></span>
<span class="normal"><a href="#__codelineno-28-17">17</a></span>
<span class="normal"><a href="#__codelineno-28-18">18</a></span>
<span class="normal"><a href="#__codelineno-28-19">19</a></span>
<span class="normal"><a href="#__codelineno-28-20">20</a></span>
<span class="normal"><a href="#__codelineno-28-21">21</a></span>
<span class="normal"><a href="#__codelineno-28-22">22</a></span>
<span class="normal"><a href="#__codelineno-28-23">23</a></span>
<span class="normal"><a href="#__codelineno-28-24">24</a></span>
<span class="normal"><a href="#__codelineno-28-25">25</a></span>
<span class="normal"><a href="#__codelineno-28-26">26</a></span>
<span class="normal"><a href="#__codelineno-28-27">27</a></span>
<span class="normal"><a href="#__codelineno-28-28">28</a></span>
<span class="normal"><a href="#__codelineno-28-29">29</a></span>
<span class="normal"><a href="#__codelineno-28-30">30</a></span>
<span class="normal"><a href="#__codelineno-28-31">31</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-28-1" name="__codelineno-28-1"></a><span class="w">    </span><span class="n">Set</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span><span class="w"> </span><span class="n">strRoles</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">signUpRequest</span><span class="p">.</span><span class="na">getRole</span><span class="p">();</span>
<a id="__codelineno-28-2" name="__codelineno-28-2"></a><span class="w">    </span><span class="n">Set</span><span class="o">&lt;</span><span class="n">Role</span><span class="o">&gt;</span><span class="w"> </span><span class="n">roles</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">HashSet</span><span class="o">&lt;&gt;</span><span class="p">();</span>
<a id="__codelineno-28-3" name="__codelineno-28-3"></a>
<a id="__codelineno-28-4" name="__codelineno-28-4"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">strRoles</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-28-5" name="__codelineno-28-5"></a><span class="w">      </span><span class="n">Role</span><span class="w"> </span><span class="n">userRole</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">roleRepository</span><span class="p">.</span><span class="na">findByName</span><span class="p">(</span><span class="n">ERole</span><span class="p">.</span><span class="na">ROLE_USER</span><span class="p">)</span>
<a id="__codelineno-28-6" name="__codelineno-28-6"></a><span class="w">          </span><span class="p">.</span><span class="na">orElseThrow</span><span class="p">(()</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">RuntimeException</span><span class="p">(</span><span class="s">&quot;Error: Role is not found.&quot;</span><span class="p">));</span>
<a id="__codelineno-28-7" name="__codelineno-28-7"></a><span class="w">      </span><span class="n">roles</span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="n">userRole</span><span class="p">);</span>
<a id="__codelineno-28-8" name="__codelineno-28-8"></a><span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-28-9" name="__codelineno-28-9"></a><span class="w">      </span><span class="n">strRoles</span><span class="p">.</span><span class="na">forEach</span><span class="p">(</span><span class="n">role</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-28-10" name="__codelineno-28-10"></a><span class="w">        </span><span class="k">switch</span><span class="w"> </span><span class="p">(</span><span class="n">role</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-28-11" name="__codelineno-28-11"></a><span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="s">&quot;admin&quot;</span><span class="p">:</span>
<a id="__codelineno-28-12" name="__codelineno-28-12"></a><span class="w">          </span><span class="n">Role</span><span class="w"> </span><span class="n">adminRole</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">roleRepository</span><span class="p">.</span><span class="na">findByName</span><span class="p">(</span><span class="n">ERole</span><span class="p">.</span><span class="na">ROLE_ADMIN</span><span class="p">)</span>
<a id="__codelineno-28-13" name="__codelineno-28-13"></a><span class="w">              </span><span class="p">.</span><span class="na">orElseThrow</span><span class="p">(()</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">RuntimeException</span><span class="p">(</span><span class="s">&quot;Error: Role is not found.&quot;</span><span class="p">));</span>
<a id="__codelineno-28-14" name="__codelineno-28-14"></a><span class="w">          </span><span class="n">roles</span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="n">adminRole</span><span class="p">);</span>
<a id="__codelineno-28-15" name="__codelineno-28-15"></a>
<a id="__codelineno-28-16" name="__codelineno-28-16"></a><span class="w">          </span><span class="k">break</span><span class="p">;</span>
<a id="__codelineno-28-17" name="__codelineno-28-17"></a><span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="s">&quot;mod&quot;</span><span class="p">:</span>
<a id="__codelineno-28-18" name="__codelineno-28-18"></a><span class="w">          </span><span class="n">Role</span><span class="w"> </span><span class="n">modRole</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">roleRepository</span><span class="p">.</span><span class="na">findByName</span><span class="p">(</span><span class="n">ERole</span><span class="p">.</span><span class="na">ROLE_MODERATOR</span><span class="p">)</span>
<a id="__codelineno-28-19" name="__codelineno-28-19"></a><span class="w">              </span><span class="p">.</span><span class="na">orElseThrow</span><span class="p">(()</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">RuntimeException</span><span class="p">(</span><span class="s">&quot;Error: Role is not found.&quot;</span><span class="p">));</span>
<a id="__codelineno-28-20" name="__codelineno-28-20"></a><span class="w">          </span><span class="n">roles</span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="n">modRole</span><span class="p">);</span>
<a id="__codelineno-28-21" name="__codelineno-28-21"></a>
<a id="__codelineno-28-22" name="__codelineno-28-22"></a><span class="w">          </span><span class="k">break</span><span class="p">;</span>
<a id="__codelineno-28-23" name="__codelineno-28-23"></a><span class="w">        </span><span class="k">default</span><span class="p">:</span>
<a id="__codelineno-28-24" name="__codelineno-28-24"></a><span class="w">          </span><span class="n">Role</span><span class="w"> </span><span class="n">userRole</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">roleRepository</span><span class="p">.</span><span class="na">findByName</span><span class="p">(</span><span class="n">ERole</span><span class="p">.</span><span class="na">ROLE_USER</span><span class="p">)</span>
<a id="__codelineno-28-25" name="__codelineno-28-25"></a><span class="w">              </span><span class="p">.</span><span class="na">orElseThrow</span><span class="p">(()</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">RuntimeException</span><span class="p">(</span><span class="s">&quot;Error: Role is not found.&quot;</span><span class="p">));</span>
<a id="__codelineno-28-26" name="__codelineno-28-26"></a><span class="w">          </span><span class="n">roles</span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="n">userRole</span><span class="p">);</span>
<a id="__codelineno-28-27" name="__codelineno-28-27"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-28-28" name="__codelineno-28-28"></a><span class="w">      </span><span class="p">});</span>
<a id="__codelineno-28-29" name="__codelineno-28-29"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-28-30" name="__codelineno-28-30"></a>
<a id="__codelineno-28-31" name="__codelineno-28-31"></a><span class="w">    </span><span class="n">user</span><span class="p">.</span><span class="na">setRoles</span><span class="p">(</span><span class="n">roles</span><span class="p">);</span>
</code></pre></div></td></tr></table></div>
<p>Vegem-ho:</p>
<ul>
<li>Primer comprovem si el conjunt de rols està buit. Si és cert, establim un nou <code>Role</code> amb <code>ERole.ROLE_USER</code> per defecte.</li>
<li>En cas contrari, hem de recórrer tots els rols que obtenim, comprovant cada rol a la base de dades i creant l'objecte <code>Role</code> corresponent.</li>
</ul>
<p>Finalment, assignem el <code>Set&lt;Role&gt;</code> a l'usuari creat en el primer bloc, i en el tercer bloc només necessitem emmagatzemar el nou usuari amb <code>UserRepository</code> i enviar una resposta d'ok al client.</p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Java</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-29-1">1</a></span>
<span class="normal"><a href="#__codelineno-29-2">2</a></span>
<span class="normal"><a href="#__codelineno-29-3">3</a></span>
<span class="normal"><a href="#__codelineno-29-4">4</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-29-1" name="__codelineno-29-1"></a><span class="w">    </span><span class="n">userRepository</span><span class="p">.</span><span class="na">save</span><span class="p">(</span><span class="n">user</span><span class="p">);</span>
<a id="__codelineno-29-2" name="__codelineno-29-2"></a>
<a id="__codelineno-29-3" name="__codelineno-29-3"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">ResponseEntity</span><span class="p">.</span><span class="na">ok</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">MessageResponse</span><span class="p">(</span><span class="s">&quot;User registered successfully!&quot;</span><span class="p">));</span>
<a id="__codelineno-29-4" name="__codelineno-29-4"></a><span class="w">  </span><span class="p">}</span>
</code></pre></div></td></tr></table></div>
<h3 id="42-signin-validar-se-o-accedir">4.2. Signin (Validar-se o accedir)</h3>
<div class="admonition note">
<p class="admonition-title">Nota</p>
<p>En valencià:</p>
<ul>
<li>Signin: registrarse, accedir al login.</li>
<li>Signup: inscribirse, donar-se d'alta. La primera vegada</li>
</ul>
</div>
<p>Aquest controlador s'utilitza per iniciar sessió d'un usuari a la nostra aplicació. Com hem estudiat, el DTO que rebem en el <code>HTTP_POST</code> és la classe <code>LoginRequest</code>, com aquesta:</p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">JSON</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-30-1">1</a></span>
<span class="normal"><a href="#__codelineno-30-2">2</a></span>
<span class="normal"><a href="#__codelineno-30-3">3</a></span>
<span class="normal"><a href="#__codelineno-30-4">4</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-30-1" name="__codelineno-30-1"></a><span class="p">{</span>
<a id="__codelineno-30-2" name="__codelineno-30-2"></a><span class="w">    </span><span class="nt">&quot;username&quot;</span><span class="p">:</span><span class="s2">&quot;joange&quot;</span><span class="p">,</span>
<a id="__codelineno-30-3" name="__codelineno-30-3"></a><span class="w">    </span><span class="nt">&quot;password&quot;</span><span class="p">:</span><span class="s2">&quot;123456&quot;</span>
<a id="__codelineno-30-4" name="__codelineno-30-4"></a><span class="p">}</span>
</code></pre></div></td></tr></table></div>
<p>El mètode encarregat serà:</p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Java</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-31-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-31-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-31-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-31-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-31-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-31-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-31-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-31-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-31-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-31-10">10</a></span>
<span class="normal"><a href="#__codelineno-31-11">11</a></span>
<span class="normal"><a href="#__codelineno-31-12">12</a></span>
<span class="normal"><a href="#__codelineno-31-13">13</a></span>
<span class="normal"><a href="#__codelineno-31-14">14</a></span>
<span class="normal"><a href="#__codelineno-31-15">15</a></span>
<span class="normal"><a href="#__codelineno-31-16">16</a></span>
<span class="normal"><a href="#__codelineno-31-17">17</a></span>
<span class="normal"><a href="#__codelineno-31-18">18</a></span>
<span class="normal"><a href="#__codelineno-31-19">19</a></span>
<span class="normal"><a href="#__codelineno-31-20">20</a></span>
<span class="normal"><a href="#__codelineno-31-21">21</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-31-1" name="__codelineno-31-1"></a><span class="nd">@PostMapping</span><span class="p">(</span><span class="s">&quot;/signin&quot;</span><span class="p">)</span>
<a id="__codelineno-31-2" name="__codelineno-31-2"></a><span class="w">  </span><span class="kd">public</span><span class="w"> </span><span class="n">ResponseEntity</span><span class="o">&lt;?&gt;</span><span class="w"> </span><span class="nf">authenticateUser</span><span class="p">(</span><span class="nd">@Valid</span><span class="w"> </span><span class="nd">@RequestBody</span><span class="w"> </span><span class="n">LoginRequest</span><span class="w"> </span><span class="n">loginRequest</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-31-3" name="__codelineno-31-3"></a>
<a id="__codelineno-31-4" name="__codelineno-31-4"></a><span class="w">    </span><span class="n">Authentication</span><span class="w"> </span><span class="n">authentication</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">authenticationManager</span><span class="p">.</span><span class="na">authenticate</span><span class="p">(</span>
<a id="__codelineno-31-5" name="__codelineno-31-5"></a><span class="w">        </span><span class="k">new</span><span class="w"> </span><span class="n">UsernamePasswordAuthenticationToken</span><span class="p">(</span><span class="n">loginRequest</span><span class="p">.</span><span class="na">getUsername</span><span class="p">(),</span><span class="w"> </span><span class="n">loginRequest</span><span class="p">.</span><span class="na">getPassword</span><span class="p">()));</span>
<a id="__codelineno-31-6" name="__codelineno-31-6"></a>
<a id="__codelineno-31-7" name="__codelineno-31-7"></a><span class="w">    </span><span class="n">SecurityContextHolder</span><span class="p">.</span><span class="na">getContext</span><span class="p">().</span><span class="na">setAuthentication</span><span class="p">(</span><span class="n">authentication</span><span class="p">);</span>
<a id="__codelineno-31-8" name="__codelineno-31-8"></a><span class="w">    </span><span class="n">String</span><span class="w"> </span><span class="n">jwt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">jwtUtils</span><span class="p">.</span><span class="na">generateJwtToken</span><span class="p">(</span><span class="n">authentication</span><span class="p">);</span>
<a id="__codelineno-31-9" name="__codelineno-31-9"></a>
<a id="__codelineno-31-10" name="__codelineno-31-10"></a><span class="w">    </span><span class="n">UserDetailsImpl</span><span class="w"> </span><span class="n">userDetails</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">UserDetailsImpl</span><span class="p">)</span><span class="w"> </span><span class="n">authentication</span><span class="p">.</span><span class="na">getPrincipal</span><span class="p">();</span><span class="w">  </span>
<a id="__codelineno-31-11" name="__codelineno-31-11"></a>
<a id="__codelineno-31-12" name="__codelineno-31-12"></a><span class="w">    </span><span class="n">List</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span><span class="w"> </span><span class="n">roles</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">userDetails</span><span class="p">.</span><span class="na">getAuthorities</span><span class="p">().</span><span class="na">stream</span><span class="p">()</span>
<a id="__codelineno-31-13" name="__codelineno-31-13"></a><span class="w">        </span><span class="p">.</span><span class="na">map</span><span class="p">(</span><span class="n">item</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">item</span><span class="p">.</span><span class="na">getAuthority</span><span class="p">())</span>
<a id="__codelineno-31-14" name="__codelineno-31-14"></a><span class="w">        </span><span class="p">.</span><span class="na">collect</span><span class="p">(</span><span class="n">Collectors</span><span class="p">.</span><span class="na">toList</span><span class="p">());</span>
<a id="__codelineno-31-15" name="__codelineno-31-15"></a>
<a id="__codelineno-31-16" name="__codelineno-31-16"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">ResponseEntity</span><span class="p">.</span><span class="na">ok</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">JwtResponse</span><span class="p">(</span><span class="n">jwt</span><span class="p">,</span><span class="w"> </span>
<a id="__codelineno-31-17" name="__codelineno-31-17"></a><span class="w">                         </span><span class="n">userDetails</span><span class="p">.</span><span class="na">getId</span><span class="p">(),</span><span class="w"> </span>
<a id="__codelineno-31-18" name="__codelineno-31-18"></a><span class="w">                         </span><span class="n">userDetails</span><span class="p">.</span><span class="na">getUsername</span><span class="p">(),</span><span class="w"> </span>
<a id="__codelineno-31-19" name="__codelineno-31-19"></a><span class="w">                         </span><span class="n">userDetails</span><span class="p">.</span><span class="na">getEmail</span><span class="p">(),</span><span class="w"> </span>
<a id="__codelineno-31-20" name="__codelineno-31-20"></a><span class="w">                         </span><span class="n">roles</span><span class="p">));</span>
<a id="__codelineno-31-21" name="__codelineno-31-21"></a><span class="w">  </span><span class="p">}</span>
</code></pre></div></td></tr></table></div>
<p>Tingues en compte:</p>
<ul>
<li>L'anotació <code>@Valid</code> comprova que l'objecte JSON coincideixi amb la classe <code>LoginRequest</code> (mira les anotacions d'aquesta classe).</li>
<li>Creem un token d'<code>Authentication</code> (aquest no és el token JWT !!!) amb el nom d'usuari i la contrasenya rebuts. La contrasenya encara no està encriptada.</li>
<li>L'últim token d'<code>Authentication</code> es configura al <code>SecurityContextHolder</code>, un objecte que conté un mínim de seguretat a nivell de fil. En aquest pas és quan el subsistema de seguretat de Spring funciona, demanant a <code>UserDetailService</code> un usuari amb aquest nom d'usuari i contrasenya a la nostra base de dades, i es guarda en un Bean <code>UserDetails</code> a la memòria. Si alguna credencial és incorrecta, es llançarà una excepció, que serà gestionada pel nostre sistema (ho estudiarem més endavant).</li>
<li>Amb aquest token (autenticació) generem el nostre token. Recorda que dins de <code>jwtUtils</code>, només obtenim el nom d'usuari per generar el subjecte del nostre token.</li>
<li>Obtenim l'objecte <code>UserDetails</code> amb el mètode <code>getPrincipal()</code>, i</li>
<li>Transformem la llista d'autoritats en una llista de cadenes (has estudiat com mapar llistes? I filtrar? I reduir?).</li>
<li>Finalment, creem i retornem un <code>ResponseEntity</code>, amb l'http_Status <strong>ok</strong>, amb un <code>JwtResponse</code> dins. Token més atributs. Un exemple de <code>JWTrespone</code> és:</li>
</ul>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">JSON</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-32-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-32-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-32-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-32-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-32-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-32-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-32-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-32-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-32-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-32-10">10</a></span>
<span class="normal"><a href="#__codelineno-32-11">11</a></span>
<span class="normal"><a href="#__codelineno-32-12">12</a></span>
<span class="normal"><a href="#__codelineno-32-13">13</a></span>
<span class="normal"><a href="#__codelineno-32-14">14</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-32-1" name="__codelineno-32-1"></a><span class="p">{</span>
<a id="__codelineno-32-2" name="__codelineno-32-2"></a><span class="w">    </span><span class="nt">&quot;id&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span>
<a id="__codelineno-32-3" name="__codelineno-32-3"></a><span class="w">    </span><span class="nt">&quot;username&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;joange&quot;</span><span class="p">,</span>
<a id="__codelineno-32-4" name="__codelineno-32-4"></a><span class="w">    </span><span class="nt">&quot;email&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;joange.sales@edu.gva.es&quot;</span><span class="p">,</span>
<a id="__codelineno-32-5" name="__codelineno-32-5"></a><span class="w">    </span><span class="nt">&quot;roles&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
<a id="__codelineno-32-6" name="__codelineno-32-6"></a><span class="w">        </span><span class="s2">&quot;ROLE_USER&quot;</span><span class="p">,</span>
<a id="__codelineno-32-7" name="__codelineno-32-7"></a><span class="w">        </span><span class="s2">&quot;ROLE_ADMIN&quot;</span>
<a id="__codelineno-32-8" name="__codelineno-32-8"></a><span class="w">    </span><span class="p">],</span>
<a id="__codelineno-32-9" name="__codelineno-32-9"></a><span class="w">    </span><span class="nt">&quot;accessToken&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;eyJhbGciOiJIUzUxMiJ9.</span>
<a id="__codelineno-32-10" name="__codelineno-32-10"></a><span class="s2">    eyJzdWIiOiJqb2FuZ2UiLCJpYXQiOjE2NzM2MjY1OTYsImV4cCI6MTY3MzcxMjk5Nn0.</span>
<a id="__codelineno-32-11" name="__codelineno-32-11"></a><span class="s2">    6yMcAYYvHsQ4XKmmT6tr0PmkpJKfPusxnMVHDmIl4WJQ_KtaY08vbt27KdvJHkWCZPO</span>
<a id="__codelineno-32-12" name="__codelineno-32-12"></a><span class="s2">    4dA2a2HtnAq13vMKAPw&quot;</span><span class="p">,</span>
<a id="__codelineno-32-13" name="__codelineno-32-13"></a><span class="w">    </span><span class="nt">&quot;tokenType&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;Bearer&quot;</span>
<a id="__codelineno-32-14" name="__codelineno-32-14"></a><span class="p">}</span>
</code></pre></div></td></tr></table></div>
<div class="admonition note">
<p class="admonition-title">Atenció</p>
<p>L'últim token té salts de línia addicionals per evitar sortir del marge del paper, és una cadena completa.</p>
</div>
<p>Si el nom d'usuari no es troba a la base de dades, la nostra aplicació crea la següent resposta:</p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">JSON</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-33-1">1</a></span>
<span class="normal"><a href="#__codelineno-33-2">2</a></span>
<span class="normal"><a href="#__codelineno-33-3">3</a></span>
<span class="normal"><a href="#__codelineno-33-4">4</a></span>
<span class="normal"><a href="#__codelineno-33-5">5</a></span>
<span class="normal"><a href="#__codelineno-33-6">6</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-33-1" name="__codelineno-33-1"></a><span class="p">{</span>
<a id="__codelineno-33-2" name="__codelineno-33-2"></a><span class="w">    </span><span class="nt">&quot;path&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;/api/auth/signin&quot;</span><span class="p">,</span>
<a id="__codelineno-33-3" name="__codelineno-33-3"></a><span class="w">    </span><span class="nt">&quot;error&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;Unauthorized&quot;</span><span class="p">,</span>
<a id="__codelineno-33-4" name="__codelineno-33-4"></a><span class="w">    </span><span class="nt">&quot;message&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;Bad credentials&quot;</span><span class="p">,</span>
<a id="__codelineno-33-5" name="__codelineno-33-5"></a><span class="w">    </span><span class="nt">&quot;status&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">401</span>
<a id="__codelineno-33-6" name="__codelineno-33-6"></a><span class="p">}</span>
</code></pre></div></td></tr></table></div>
<h2 id="5-tokens-en-funcionament">5. Tokens en funcionament</h2>
<p>Ara que el registre d'usuaris i l'inici de sessió estan implementats, fem una pregunta, <em>Què fa l'aplicació client amb el JWTResponse que ha rebut després del procés d'inici de sessió</em>? Les dades de l'usuari normalment s'utilitzen per a la interfície (nom complet, avatar, etc.). Però què passa amb els tokens?</p>
<p>La resposta, com estudiarem més endavant, és emmagatzemar-lo, i després enviar-lo al servidor en cada sol·licitud com a mètode d'Autenticació i Autorització.</p>
<h3 id="51-enviant-tokens">5.1. Enviant tokens</h3>
<p>Per enviar un token, necessitem adjuntar-lo a la secció <code>Header</code>, creant un paràmetre <code>Authorization</code> amb el valor <code>Bearer token_recieved</code>, com podeu veure en aquesta captura de pantalla de Postman:</p>
<center>![Send_JWT](./img/Send_JWT.png){width=95%}</center>

<div class="admonition important">
<p class="admonition-title">Important</p>
<p>Recorda: la paraula <code>Bearer</code> més un <em>espai en blanc</em> més tot el token rebut (com a <code>String</code>)</p>
</div>
<p>D'acord, així doncs, l'aplicació client ens enviarà el token a través de la sol·licitud, però, com fa el nostre servidor per obtenir i comprovar el token? La resposta és que hem de dir-ho en forma de filtre.</p>
<h2 id="6-configuracio-de-seguretat">6. Configuració de Seguretat</h2>
<p>La classe que configura la seguretat és <code>WebSecurityConfig</code>. Anem a explicar-la per blocs de nou. Aquesta classe està composta per un conjunt de Beans que s'utilitzaran en tot el projecte (recorda la injecció de codi). Explicarem només el necessari.</p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Java</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-34-1">1</a></span>
<span class="normal"><a href="#__codelineno-34-2">2</a></span>
<span class="normal"><a href="#__codelineno-34-3">3</a></span>
<span class="normal"><a href="#__codelineno-34-4">4</a></span>
<span class="normal"><a href="#__codelineno-34-5">5</a></span>
<span class="normal"><a href="#__codelineno-34-6">6</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-34-1" name="__codelineno-34-1"></a><span class="nd">@Configuration</span>
<a id="__codelineno-34-2" name="__codelineno-34-2"></a><span class="nd">@EnableGlobalMethodSecurity</span><span class="p">(</span>
<a id="__codelineno-34-3" name="__codelineno-34-3"></a><span class="w">    </span><span class="n">prePostEnabled</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">)</span>
<a id="__codelineno-34-4" name="__codelineno-34-4"></a><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">WebSecurityConfig</span><span class="w"> </span><span class="p">{</span><span class="w"> </span>
<a id="__codelineno-34-5" name="__codelineno-34-5"></a>
<a id="__codelineno-34-6" name="__codelineno-34-6"></a><span class="p">}</span>
</code></pre></div></td></tr></table></div>
<p>Aquesta anotació <code>@Configuration</code> indica a Spring que ha de carregar aquesta classe. També permet que Spring utilitzi anotacions de filtres pre i post (ho estudiarem més endavant).</p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Java</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-35-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-35-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-35-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-35-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-35-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-35-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-35-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-35-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-35-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-35-10">10</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-35-1" name="__codelineno-35-1"></a><span class="w">  </span><span class="nd">@Autowired</span>
<a id="__codelineno-35-2" name="__codelineno-35-2"></a><span class="w">  </span><span class="n">UserDetailsServiceImpl</span><span class="w"> </span><span class="n">userDetailsService</span><span class="p">;</span>
<a id="__codelineno-35-3" name="__codelineno-35-3"></a>
<a id="__codelineno-35-4" name="__codelineno-35-4"></a><span class="w">  </span><span class="nd">@Autowired</span>
<a id="__codelineno-35-5" name="__codelineno-35-5"></a><span class="w">  </span><span class="kd">private</span><span class="w"> </span><span class="n">AuthEntryPointJwt</span><span class="w"> </span><span class="n">unauthorizedHandler</span><span class="p">;</span>
<a id="__codelineno-35-6" name="__codelineno-35-6"></a>
<a id="__codelineno-35-7" name="__codelineno-35-7"></a><span class="w">  </span><span class="nd">@Bean</span>
<a id="__codelineno-35-8" name="__codelineno-35-8"></a><span class="w">  </span><span class="kd">public</span><span class="w"> </span><span class="n">AuthTokenFilter</span><span class="w"> </span><span class="nf">authenticationJwtTokenFilter</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-35-9" name="__codelineno-35-9"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">AuthTokenFilter</span><span class="p">();</span>
<a id="__codelineno-35-10" name="__codelineno-35-10"></a><span class="w">  </span><span class="p">}</span>
</code></pre></div></td></tr></table></div>
<p>Aquests beans s'explicaran més endavant. En poques paraules, són responsables de gestionar errors com a manejador d'excepcions i de com aplicar cadenes de filtres per autenticar usuaris.</p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Java</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-36-1">1</a></span>
<span class="normal"><a href="#__codelineno-36-2">2</a></span>
<span class="normal"><a href="#__codelineno-36-3">3</a></span>
<span class="normal"><a href="#__codelineno-36-4">4</a></span>
<span class="normal"><a href="#__codelineno-36-5">5</a></span>
<span class="normal"><a href="#__codelineno-36-6">6</a></span>
<span class="normal"><a href="#__codelineno-36-7">7</a></span>
<span class="normal"><a href="#__codelineno-36-8">8</a></span>
<span class="normal"><a href="#__codelineno-36-9">9</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-36-1" name="__codelineno-36-1"></a><span class="w">  </span><span class="nd">@Bean</span>
<a id="__codelineno-36-2" name="__codelineno-36-2"></a><span class="w">  </span><span class="kd">public</span><span class="w"> </span><span class="n">DaoAuthenticationProvider</span><span class="w"> </span><span class="nf">authenticationProvider</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-36-3" name="__codelineno-36-3"></a><span class="w">      </span><span class="n">DaoAuthenticationProvider</span><span class="w"> </span><span class="n">authProvider</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">DaoAuthenticationProvider</span><span class="p">();</span>
<a id="__codelineno-36-4" name="__codelineno-36-4"></a>
<a id="__codelineno-36-5" name="__codelineno-36-5"></a><span class="w">      </span><span class="n">authProvider</span><span class="p">.</span><span class="na">setUserDetailsService</span><span class="p">(</span><span class="n">userDetailsService</span><span class="p">);</span>
<a id="__codelineno-36-6" name="__codelineno-36-6"></a><span class="w">      </span><span class="n">authProvider</span><span class="p">.</span><span class="na">setPasswordEncoder</span><span class="p">(</span><span class="n">passwordEncoder</span><span class="p">());</span>
<a id="__codelineno-36-7" name="__codelineno-36-7"></a>
<a id="__codelineno-36-8" name="__codelineno-36-8"></a><span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="n">authProvider</span><span class="p">;</span>
<a id="__codelineno-36-9" name="__codelineno-36-9"></a><span class="w">  </span><span class="p">}</span>
</code></pre></div></td></tr></table></div>
<p>Aquest Bean utilitza el <code>UserDetailService</code> i el <code>PasswordEncoder</code> per fer el procés d'autenticació. Això significa accedir a la base de dades i comprovar l'usuari i la contrasenya (amb el mateix encoder que utilitzem per emmagatzemar usuaris). Els següents Beans creen l'<code>AuthenticationManager</code> i l'encoder.</p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Java</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-37-1">1</a></span>
<span class="normal"><a href="#__codelineno-37-2">2</a></span>
<span class="normal"><a href="#__codelineno-37-3">3</a></span>
<span class="normal"><a href="#__codelineno-37-4">4</a></span>
<span class="normal"><a href="#__codelineno-37-5">5</a></span>
<span class="normal"><a href="#__codelineno-37-6">6</a></span>
<span class="normal"><a href="#__codelineno-37-7">7</a></span>
<span class="normal"><a href="#__codelineno-37-8">8</a></span>
<span class="normal"><a href="#__codelineno-37-9">9</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-37-1" name="__codelineno-37-1"></a><span class="w">  </span><span class="nd">@Bean</span>
<a id="__codelineno-37-2" name="__codelineno-37-2"></a><span class="w">  </span><span class="kd">public</span><span class="w"> </span><span class="n">AuthenticationManager</span><span class="w"> </span><span class="nf">authenticationManager</span><span class="p">(</span><span class="n">AuthenticationConfiguration</span><span class="w"> </span><span class="n">authConfig</span><span class="p">)</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">Exception</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-37-3" name="__codelineno-37-3"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">authConfig</span><span class="p">.</span><span class="na">getAuthenticationManager</span><span class="p">();</span>
<a id="__codelineno-37-4" name="__codelineno-37-4"></a><span class="w">  </span><span class="p">}</span>
<a id="__codelineno-37-5" name="__codelineno-37-5"></a>
<a id="__codelineno-37-6" name="__codelineno-37-6"></a><span class="w">  </span><span class="nd">@Bean</span>
<a id="__codelineno-37-7" name="__codelineno-37-7"></a><span class="w">  </span><span class="kd">public</span><span class="w"> </span><span class="n">PasswordEncoder</span><span class="w"> </span><span class="nf">passwordEncoder</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-37-8" name="__codelineno-37-8"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">BCryptPasswordEncoder</span><span class="p">();</span>
<a id="__codelineno-37-9" name="__codelineno-37-9"></a><span class="w">  </span><span class="p">}</span>
</code></pre></div></td></tr></table></div>
<p>I finalment, una de les configuracions més importants (i difícils d'entendre), la cadena de filtres de seguretat. Les cadenes de filtres són codi que posem al mig entre el client i el servidor. Aquests filtres intercepten la sol·licitud, l'analitzen i després, depenent del resultat del filtre, simplement passen el control al servidor o envien una resposta al client. Aquest filtre podria canviar la sol·licitud, afegint o eliminant informació que serà utilitzada pel servidor.</p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Java</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-38-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-38-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-38-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-38-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-38-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-38-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-38-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-38-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-38-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-38-10">10</a></span>
<span class="normal"><a href="#__codelineno-38-11">11</a></span>
<span class="normal"><a href="#__codelineno-38-12">12</a></span>
<span class="normal"><a href="#__codelineno-38-13">13</a></span>
<span class="normal"><a href="#__codelineno-38-14">14</a></span>
<span class="normal"><a href="#__codelineno-38-15">15</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-38-1" name="__codelineno-38-1"></a><span class="w">  </span><span class="nd">@Bean</span>
<a id="__codelineno-38-2" name="__codelineno-38-2"></a><span class="w">  </span><span class="kd">public</span><span class="w"> </span><span class="n">SecurityFilterChain</span><span class="w"> </span><span class="nf">filterChain</span><span class="p">(</span><span class="n">HttpSecurity</span><span class="w"> </span><span class="n">http</span><span class="p">)</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">Exception</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-38-3" name="__codelineno-38-3"></a><span class="w">    </span><span class="n">http</span><span class="p">.</span><span class="na">cors</span><span class="p">().</span><span class="na">and</span><span class="p">().</span><span class="na">csrf</span><span class="p">().</span><span class="na">disable</span><span class="p">()</span>
<a id="__codelineno-38-4" name="__codelineno-38-4"></a><span class="w">        </span><span class="p">.</span><span class="na">exceptionHandling</span><span class="p">().</span><span class="na">authenticationEntryPoint</span><span class="p">(</span><span class="n">unauthorizedHandler</span><span class="p">).</span><span class="na">and</span><span class="p">()</span>
<a id="__codelineno-38-5" name="__codelineno-38-5"></a><span class="w">        </span><span class="p">.</span><span class="na">sessionManagement</span><span class="p">().</span><span class="na">sessionCreationPolicy</span><span class="p">(</span><span class="n">SessionCreationPolicy</span><span class="p">.</span><span class="na">STATELESS</span><span class="p">).</span><span class="na">and</span><span class="p">()</span>
<a id="__codelineno-38-6" name="__codelineno-38-6"></a><span class="w">        </span><span class="p">.</span><span class="na">authorizeRequests</span><span class="p">().</span><span class="na">antMatchers</span><span class="p">(</span><span class="s">&quot;/api/auth/**&quot;</span><span class="p">).</span><span class="na">permitAll</span><span class="p">()</span>
<a id="__codelineno-38-7" name="__codelineno-38-7"></a><span class="w">        </span><span class="p">.</span><span class="na">antMatchers</span><span class="p">(</span><span class="s">&quot;/api/test/**&quot;</span><span class="p">).</span><span class="na">permitAll</span><span class="p">()</span>
<a id="__codelineno-38-8" name="__codelineno-38-8"></a><span class="w">        </span><span class="p">.</span><span class="na">anyRequest</span><span class="p">().</span><span class="na">authenticated</span><span class="p">();</span>
<a id="__codelineno-38-9" name="__codelineno-38-9"></a>
<a id="__codelineno-38-10" name="__codelineno-38-10"></a><span class="w">    </span><span class="n">http</span><span class="p">.</span><span class="na">authenticationProvider</span><span class="p">(</span><span class="n">authenticationProvider</span><span class="p">());</span>
<a id="__codelineno-38-11" name="__codelineno-38-11"></a>
<a id="__codelineno-38-12" name="__codelineno-38-12"></a><span class="w">    </span><span class="n">http</span><span class="p">.</span><span class="na">addFilterBefore</span><span class="p">(</span><span class="n">authenticationJwtTokenFilter</span><span class="p">(),</span><span class="w"> </span><span class="n">UsernamePasswordAuthenticationFilter</span><span class="p">.</span><span class="na">class</span><span class="p">);</span>
<a id="__codelineno-38-13" name="__codelineno-38-13"></a>
<a id="__codelineno-38-14" name="__codelineno-38-14"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">http</span><span class="p">.</span><span class="na">build</span><span class="p">();</span>
<a id="__codelineno-38-15" name="__codelineno-38-15"></a><span class="w">  </span><span class="p">}</span>
</code></pre></div></td></tr></table></div>
<p>Tingueu en compte que:</p>
<ul>
<li>Habilitem CORS (Cross-Origin Requests) i deshabilitem CSRF (Cross Site Request Forgery)</li>
<li>Establim l'authenticationEntryPoint</li>
<li>Permetem l'accés a tots els camins a <code>/api/auth/**</code></li>
<li>Permetem l'accés a tots els camins a <code>/api/test/**</code></li>
<li>Qualsevol altra sol·licitud necessitarà ser autenticada</li>
</ul>
<p>Finalment, afegim el filtre abans i el proveïdor d'autenticació.</p>
<p>En una visió relaxada, per entendre-ho, els filtres es combinen amb anotacions que indiquen on i quan hem de comprovar l'Autenticació i l'Autorització.</p>
<center>![FilterChain](./img/FilterChain.png){width=95%}</center>

<h3 id="61-authtokenfilter">6.1. AuthTokenFilter</h3>
<p>Aquesta classe conté el procés del token rebut dels clients. Ha d'implementar <code>OncePerRequestFilter</code> i sobreescriure <code>doFilterInternal()</code>.</p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Java</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-39-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-39-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-39-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-39-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-39-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-39-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-39-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-39-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-39-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-39-10">10</a></span>
<span class="normal"><a href="#__codelineno-39-11">11</a></span>
<span class="normal"><a href="#__codelineno-39-12">12</a></span>
<span class="normal"><a href="#__codelineno-39-13">13</a></span>
<span class="normal"><a href="#__codelineno-39-14">14</a></span>
<span class="normal"><a href="#__codelineno-39-15">15</a></span>
<span class="normal"><a href="#__codelineno-39-16">16</a></span>
<span class="normal"><a href="#__codelineno-39-17">17</a></span>
<span class="normal"><a href="#__codelineno-39-18">18</a></span>
<span class="normal"><a href="#__codelineno-39-19">19</a></span>
<span class="normal"><a href="#__codelineno-39-20">20</a></span>
<span class="normal"><a href="#__codelineno-39-21">21</a></span>
<span class="normal"><a href="#__codelineno-39-22">22</a></span>
<span class="normal"><a href="#__codelineno-39-23">23</a></span>
<span class="normal"><a href="#__codelineno-39-24">24</a></span>
<span class="normal"><a href="#__codelineno-39-25">25</a></span>
<span class="normal"><a href="#__codelineno-39-26">26</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-39-1" name="__codelineno-39-1"></a><span class="nd">@Override</span>
<a id="__codelineno-39-2" name="__codelineno-39-2"></a><span class="w">  </span><span class="kd">protected</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">doFilterInternal</span><span class="p">(</span>
<a id="__codelineno-39-3" name="__codelineno-39-3"></a><span class="w">    </span><span class="n">HttpServletRequest</span><span class="w"> </span><span class="n">request</span><span class="p">,</span><span class="w"> </span>
<a id="__codelineno-39-4" name="__codelineno-39-4"></a><span class="w">    </span><span class="n">HttpServletResponse</span><span class="w"> </span><span class="n">response</span><span class="p">,</span><span class="w"> </span>
<a id="__codelineno-39-5" name="__codelineno-39-5"></a><span class="w">    </span><span class="n">FilterChain</span><span class="w"> </span><span class="n">filterChain</span><span class="p">)</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">ServletException</span><span class="p">,</span><span class="w"> </span><span class="n">IOException</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-39-6" name="__codelineno-39-6"></a><span class="w">    </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-39-7" name="__codelineno-39-7"></a><span class="w">      </span><span class="n">String</span><span class="w"> </span><span class="n">jwt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">parseJwt</span><span class="p">(</span><span class="n">request</span><span class="p">);</span>
<a id="__codelineno-39-8" name="__codelineno-39-8"></a><span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">jwt</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">jwtUtils</span><span class="p">.</span><span class="na">validateJwtToken</span><span class="p">(</span><span class="n">jwt</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-39-9" name="__codelineno-39-9"></a><span class="w">        </span><span class="n">String</span><span class="w"> </span><span class="n">username</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">jwtUtils</span><span class="p">.</span><span class="na">getUserNameFromJwtToken</span><span class="p">(</span><span class="n">jwt</span><span class="p">);</span>
<a id="__codelineno-39-10" name="__codelineno-39-10"></a>
<a id="__codelineno-39-11" name="__codelineno-39-11"></a><span class="w">        </span><span class="n">UserDetails</span><span class="w"> </span><span class="n">userDetails</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">userDetailsService</span><span class="p">.</span><span class="na">loadUserByUsername</span><span class="p">(</span><span class="n">username</span><span class="p">);</span>
<a id="__codelineno-39-12" name="__codelineno-39-12"></a><span class="w">        </span><span class="n">UsernamePasswordAuthenticationToken</span><span class="w"> </span><span class="n">authentication</span><span class="w"> </span><span class="o">=</span>
<a id="__codelineno-39-13" name="__codelineno-39-13"></a><span class="w">            </span><span class="k">new</span><span class="w"> </span><span class="n">UsernamePasswordAuthenticationToken</span><span class="p">(</span>
<a id="__codelineno-39-14" name="__codelineno-39-14"></a><span class="w">                </span><span class="n">userDetails</span><span class="p">,</span>
<a id="__codelineno-39-15" name="__codelineno-39-15"></a><span class="w">                </span><span class="kc">null</span><span class="p">,</span>
<a id="__codelineno-39-16" name="__codelineno-39-16"></a><span class="w">                </span><span class="n">userDetails</span><span class="p">.</span><span class="na">getAuthorities</span><span class="p">());</span>
<a id="__codelineno-39-17" name="__codelineno-39-17"></a><span class="w">        </span><span class="n">authentication</span><span class="p">.</span><span class="na">setDetails</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">WebAuthenticationDetailsSource</span><span class="p">().</span><span class="na">buildDetails</span><span class="p">(</span><span class="n">request</span><span class="p">));</span>
<a id="__codelineno-39-18" name="__codelineno-39-18"></a>
<a id="__codelineno-39-19" name="__codelineno-39-19"></a><span class="w">        </span><span class="n">SecurityContextHolder</span><span class="p">.</span><span class="na">getContext</span><span class="p">().</span><span class="na">setAuthentication</span><span class="p">(</span><span class="n">authentication</span><span class="p">);</span>
<a id="__codelineno-39-20" name="__codelineno-39-20"></a><span class="w">      </span><span class="p">}</span>
<a id="__codelineno-39-21" name="__codelineno-39-21"></a><span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">Exception</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-39-22" name="__codelineno-39-22"></a><span class="w">      </span><span class="n">logger</span><span class="p">.</span><span class="na">error</span><span class="p">(</span><span class="s">&quot;Cannot set user authentication: {}&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">e</span><span class="p">);</span>
<a id="__codelineno-39-23" name="__codelineno-39-23"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-39-24" name="__codelineno-39-24"></a>
<a id="__codelineno-39-25" name="__codelineno-39-25"></a><span class="w">    </span><span class="n">filterChain</span><span class="p">.</span><span class="na">doFilter</span><span class="p">(</span><span class="n">request</span><span class="p">,</span><span class="w"> </span><span class="n">response</span><span class="p">);</span>
<a id="__codelineno-39-26" name="__codelineno-39-26"></a><span class="w">  </span><span class="p">}</span>
</code></pre></div></td></tr></table></div>
<p>En paraules nostres, aquest mètode s'executarà quan es faci una sol·licitud i:</p>
<ul>
<li>Extreu el token de la sol·licitud, retornant només la informació rellevant (elimina <code>Bearer</code>).</li>
<li>Comprova que el token sigui vàlid, i:</li>
<li>Extreu el nom d'usuari (està en el payload del token) i</li>
<li>Obté aquest <code>UserDetails</code> i crea un <code>UsernamePasswordAuthenticationToken</code> per ser injectat a la resta de la sol·licitud-resposta, òbviament amb autoritats.</li>
<li>Finalment, continua amb el següent filtre, si existeix, cridant <code>filterChain.doFilter(req,res)</code>. Si no hi ha cap filtre, el dispatcher passa el control al controlador sol·licitat.</li>
</ul>
<h3 id="62-authentrypoint">6.2. AuthEntryPoint</h3>
<p>Aquesta classe conté codi que s'executarà quan aparegui una excepció. Aleshores, crea un cos genèric dins de la resposta i estableix una resposta precisa per al client.</p>
<h2 id="7-controller-authorization">7. Controller Authorization</h2>
<p>Només ens queda dir quina sol·licitud necessita ser autoritzada. Recorda que amb altres classes preparem l'autenticació, <strong>Qui ets?</strong>. Ara necessitem preguntar <strong>Què pots fer?</strong></p>
<p>Com marquem en la nostra <code>filterChain</code>, afegim <code>addFilterBefore</code> per comprovar els rols. Però, <em>on hem de dir els rols que capturen cada sol·licitud</em>? La resposta és fàcil: els controladors. Vegem un controlador de prova amb filtre d'autorització:</p>
<p><div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Java</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-40-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-40-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-40-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-40-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-40-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-40-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-40-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-40-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-40-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-40-10">10</a></span>
<span class="normal"><a href="#__codelineno-40-11">11</a></span>
<span class="normal"><a href="#__codelineno-40-12">12</a></span>
<span class="normal"><a href="#__codelineno-40-13">13</a></span>
<span class="normal"><a href="#__codelineno-40-14">14</a></span>
<span class="normal"><a href="#__codelineno-40-15">15</a></span>
<span class="normal"><a href="#__codelineno-40-16">16</a></span>
<span class="normal"><a href="#__codelineno-40-17">17</a></span>
<span class="normal"><a href="#__codelineno-40-18">18</a></span>
<span class="normal"><a href="#__codelineno-40-19">19</a></span>
<span class="normal"><a href="#__codelineno-40-20">20</a></span>
<span class="normal"><a href="#__codelineno-40-21">21</a></span>
<span class="normal"><a href="#__codelineno-40-22">22</a></span>
<span class="normal"><a href="#__codelineno-40-23">23</a></span>
<span class="normal"><a href="#__codelineno-40-24">24</a></span>
<span class="normal"><a href="#__codelineno-40-25">25</a></span>
<span class="normal"><a href="#__codelineno-40-26">26</a></span>
<span class="normal"><a href="#__codelineno-40-27">27</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-40-1" name="__codelineno-40-1"></a><span class="nd">@CrossOrigin</span><span class="p">(</span><span class="n">origins</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;*&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">maxAge</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">3600</span><span class="p">)</span>
<a id="__codelineno-40-2" name="__codelineno-40-2"></a><span class="nd">@RestController</span>
<a id="__codelineno-40-3" name="__codelineno-40-3"></a><span class="nd">@RequestMapping</span><span class="p">(</span><span class="s">&quot;/api/test&quot;</span><span class="p">)</span>
<a id="__codelineno-40-4" name="__codelineno-40-4"></a><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">TestController</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-40-5" name="__codelineno-40-5"></a><span class="w">  </span><span class="nd">@GetMapping</span><span class="p">(</span><span class="s">&quot;/all&quot;</span><span class="p">)</span>
<a id="__codelineno-40-6" name="__codelineno-40-6"></a><span class="w">  </span><span class="kd">public</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="nf">allAccess</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-40-7" name="__codelineno-40-7"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="s">&quot;Public Content.&quot;</span><span class="p">;</span>
<a id="__codelineno-40-8" name="__codelineno-40-8"></a><span class="w">  </span><span class="p">}</span>
<a id="__codelineno-40-9" name="__codelineno-40-9"></a>
<a id="__codelineno-40-10" name="__codelineno-40-10"></a><span class="w">  </span><span class="nd">@GetMapping</span><span class="p">(</span><span class="s">&quot;/user&quot;</span><span class="p">)</span>
<a id="__codelineno-40-11" name="__codelineno-40-11"></a><span class="w">  </span><span class="nd">@PreAuthorize</span><span class="p">(</span><span class="s">&quot;hasRole(&#39;USER&#39;) or hasRole(&#39;MODERATOR&#39;) or hasRole(&#39;ADMIN&#39;)&quot;</span><span class="p">)</span>
<a id="__codelineno-40-12" name="__codelineno-40-12"></a><span class="w">  </span><span class="kd">public</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="nf">userAccess</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-40-13" name="__codelineno-40-13"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="s">&quot;User Content.&quot;</span><span class="p">;</span>
<a id="__codelineno-40-14" name="__codelineno-40-14"></a><span class="w">  </span><span class="p">}</span>
<a id="__codelineno-40-15" name="__codelineno-40-15"></a>
<a id="__codelineno-40-16" name="__codelineno-40-16"></a><span class="w">  </span><span class="nd">@GetMapping</span><span class="p">(</span><span class="s">&quot;/mod&quot;</span><span class="p">)</span>
<a id="__codelineno-40-17" name="__codelineno-40-17"></a><span class="w">  </span><span class="nd">@PreAuthorize</span><span class="p">(</span><span class="s">&quot;hasRole(&#39;MODERATOR&#39;)&quot;</span><span class="p">)</span>
<a id="__codelineno-40-18" name="__codelineno-40-18"></a><span class="w">  </span><span class="kd">public</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="nf">moderatorAccess</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-40-19" name="__codelineno-40-19"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="s">&quot;Moderator Board.&quot;</span><span class="p">;</span>
<a id="__codelineno-40-20" name="__codelineno-40-20"></a><span class="w">  </span><span class="p">}</span>
<a id="__codelineno-40-21" name="__codelineno-40-21"></a>
<a id="__codelineno-40-22" name="__codelineno-40-22"></a><span class="w">  </span><span class="nd">@GetMapping</span><span class="p">(</span><span class="s">&quot;/admin&quot;</span><span class="p">)</span>
<a id="__codelineno-40-23" name="__codelineno-40-23"></a><span class="w">  </span><span class="nd">@PreAuthorize</span><span class="p">(</span><span class="s">&quot;hasRole(&#39;ADMIN&#39;)&quot;</span><span class="p">)</span>
<a id="__codelineno-40-24" name="__codelineno-40-24"></a><span class="w">  </span><span class="kd">public</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="nf">adminAccess</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-40-25" name="__codelineno-40-25"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="s">&quot;Admin Board.&quot;</span><span class="p">;</span>
<a id="__codelineno-40-26" name="__codelineno-40-26"></a><span class="w">  </span><span class="p">}</span>
<a id="__codelineno-40-27" name="__codelineno-40-27"></a><span class="p">}</span>
</code></pre></div></td></tr></table></div>
Si:</p>
<ul>
<li>No apareix cap anotació: tots els rols poden fer aquesta sol·licitud</li>
<li><code>@PreAuthorize("hasRole('role')")</code> → Aquesta anotació indica el rol que està autoritzat per fer aquesta sol·licitud. Pots combinar més d'un rol amb <code>or</code></li>
</ul>
<h2 id="8-exercici-com-fer-servir-aquest-projecte">8. Exercici. Com fer servir aquest projecte?</h2>
<p>Probablement tindràs ja una API implementada i funcionant de manera no segura. Ara tens la tasca de <strong>fusionar</strong> amb aquest projecte per tal d'autoritzar certes operacions sols a usuaris registrats. És una tasca llarga (que no complicada), però el resultat final serà molt gratificant.</p>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      
      <script id="__config" type="application/json">{"annotate": null, "base": "../..", "features": ["content.code.copy", "content.code.select", "content.code.annotate"], "search": "../../assets/javascripts/workers/search.7a47a382.min.js", "tags": null, "translations": {"clipboard.copied": "Copiat al porta-retalls", "clipboard.copy": "C\u00f2pia al porta-retalls", "search.result.more.one": "1 m\u00e9s en aquesta p\u00e0gina", "search.result.more.other": "# m\u00e9s en aquesta p\u00e0gina", "search.result.none": "Cap document coincideix", "search.result.one": "1 document coincident", "search.result.other": "# documents coincidents", "search.result.placeholder": "Escriu per a comen\u00e7ar a cercar", "search.result.term.missing": "Desaparegut", "select.version": "Selecciona la versi\u00f3"}, "version": null}</script>
    
    
      <script src="../../assets/javascripts/bundle.e71a0d61.min.js"></script>
      
        <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
      
    
  </body>
</html>