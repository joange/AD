
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      
        <link rel="prev" href="../3_API_Rest/">
      
      
        <link rel="next" href="../5_Spring_Hateoas/">
      
      
      <link rel="icon" href="../../../assets/jaume.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.5.42">
    
    
      
        <title>4. Security - Accés a Dades</title>
      
    
    
      <link rel="stylesheet" href="../../../assets/stylesheets/main.0253249f.min.css">
      
        
        <link rel="stylesheet" href="../../../assets/stylesheets/palette.06af60db.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("../../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="deep-purple" data-md-color-accent="indigo">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#1-https" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../../" title="Accés a Dades" class="md-header__button md-logo" aria-label="Accés a Dades" data-md-component="logo">
      
  <img src="../../../assets/jaume.png" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Accés a Dades
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              4. Security
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="default" data-md-color-primary="deep-purple" data-md-color-accent="indigo"  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_0">
    
      <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_1" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a4 4 0 0 0-4 4 4 4 0 0 0 4 4 4 4 0 0 0 4-4 4 4 0 0 0-4-4m0 10a6 6 0 0 1-6-6 6 6 0 0 1 6-6 6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="slate" data-md-color-primary="brown" data-md-color-accent="indigo"  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_1">
    
      <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_0" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 18c-.89 0-1.74-.2-2.5-.55C11.56 16.5 13 14.42 13 12s-1.44-4.5-3.5-5.45C10.26 6.2 11.11 6 12 6a6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg>
      </label>
    
  
</form>
      
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
      <div class="md-header__option">
  <div class="md-select">
    
    <button class="md-header__button md-icon" aria-label="Select language">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="m12.87 15.07-2.54-2.51.03-.03A17.5 17.5 0 0 0 14.07 6H17V4h-7V2H8v2H1v2h11.17C11.5 7.92 10.44 9.75 9 11.35 8.07 10.32 7.3 9.19 6.69 8h-2c.73 1.63 1.73 3.17 2.98 4.56l-5.09 5.02L4 19l5-5 3.11 3.11zM18.5 10h-2L12 22h2l1.12-3h4.75L21 22h2zm-2.62 7 1.62-4.33L19.12 17z"/></svg>
    </button>
    <div class="md-select__inner">
      <ul class="md-select__list">
        
          <li class="md-select__item">
            <a href="./" hreflang="en" class="md-select__link">
              English
            </a>
          </li>
        
          <li class="md-select__item">
            <a href="../../../UD5_Spring/4_Spring_Security/" hreflang="ca" class="md-select__link">
              Valencià
            </a>
          </li>
        
      </ul>
    </div>
  </div>
</div>
    
    
      <label class="md-header__button md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../../" title="Accés a Dades" class="md-nav__button md-logo" aria-label="Accés a Dades" data-md-component="logo">
      
  <img src="../../../assets/jaume.png" alt="logo">

    </a>
    Accés a Dades
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Data Access
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2" >
        
          
          <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Unit 1. Files
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            Unit 1. Files
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../UD1_Files/1_File_System/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    1. File System
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../UD1_Files/2_Reading_and_writing_files/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2. Reading and Writing Files
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../UD1_Files/3_XML_Files/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    3. Working with XML Files
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../UD1_Files/4_JSON_Files/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    4. Working with JSON Files
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../UD1_Files/5_CSV/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    5. Arxius separats per comes. CSV
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3" >
        
          
          <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Unit 2. Connectors
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            Unit 2. Connectors
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../UD2_Connectors/1_Object_relational_impedance_mismatch/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    1. Object-relational impedance mismatch
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../UD2_Connectors/2_Connectors/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2. Connectors
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../UD2_Connectors/3_Connecting/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    3. Connecting to the database
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../UD2_Connectors/4_Resultset/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    4. Query results
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../UD2_Connectors/5_Metadata/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    5. Metadata
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../UD2_Connectors/6_CRUD/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    6. CRUD Operations
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../UD2_Connectors/7_Row_to_Object/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    7. From rows to objects
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4" >
        
          
          <label class="md-nav__link" for="__nav_4" id="__nav_4_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Unit 3. Hibernate
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4">
            <span class="md-nav__icon md-icon"></span>
            Unit 3. Hibernate
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../UD3_Hibernate/1_Mapping/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    1.Object mapping
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../UD3_Hibernate/2_Hibernate/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2. Introduction to Hibernate
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../UD3_Hibernate/3_Entities_Beans/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    3. Entities
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../UD3_Hibernate/4_Relationships/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    4. Relationships
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../UD3_Hibernate/5_HQL/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    5. Queries
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5" >
        
          
          <label class="md-nav__link" for="__nav_5" id="__nav_5_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Unit 4. OO Databases
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5">
            <span class="md-nav__icon md-icon"></span>
            Unit 4. OO Databases
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../UD4_BDOO/1_Introduction/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    1. Introduction to OO Databases
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../UD4_BDOO/2_ORDB/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2. Objet-Relational Databases
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../UD4_BDOO/3_OODB/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    3. Object-Oriented Databases
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_6" checked>
        
          
          <label class="md-nav__link" for="__nav_6" id="__nav_6_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Unit 5. Spring
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_6_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_6">
            <span class="md-nav__icon md-icon"></span>
            Unit 5. Spring
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../1_Data_Access_Services/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    1. Data Access Services
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../2_Spring_SpringBoot/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2. Introduction to Spring
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../3_API_Rest/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    3. Creating API's REST
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  <span class="md-ellipsis">
    4. Security
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  <span class="md-ellipsis">
    4. Security
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#1-https" class="md-nav__link">
    <span class="md-ellipsis">
      1. HTTPS
    </span>
  </a>
  
    <nav class="md-nav" aria-label="1. HTTPS">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#11-certificate" class="md-nav__link">
    <span class="md-ellipsis">
      1.1. Certificate
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#12-configure-spring" class="md-nav__link">
    <span class="md-ellipsis">
      1.2. Configure Spring
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#2-spring-security" class="md-nav__link">
    <span class="md-ellipsis">
      2. Spring Security
    </span>
  </a>
  
    <nav class="md-nav" aria-label="2. Spring Security">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#21-users-data-for-authentication-and-authorization-models" class="md-nav__link">
    <span class="md-ellipsis">
      2.1. Users Data for Authentication and Authorization (Models)
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#22-user-roles" class="md-nav__link">
    <span class="md-ellipsis">
      2.2. User &amp; Roles
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#23-user-roles-repository" class="md-nav__link">
    <span class="md-ellipsis">
      2.3. User &amp; Roles Repository
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#24-userdetails" class="md-nav__link">
    <span class="md-ellipsis">
      2.4. UserDetails
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#25-payloads-dtos" class="md-nav__link">
    <span class="md-ellipsis">
      2.5. Payloads DTO's
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#26-signuprequest" class="md-nav__link">
    <span class="md-ellipsis">
      2.6. SignupRequest
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#27-loginrequest" class="md-nav__link">
    <span class="md-ellipsis">
      2.7. LoginRequest
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#28-jwtresponse" class="md-nav__link">
    <span class="md-ellipsis">
      2.8. JwtResponse
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#3-tokens-jwt" class="md-nav__link">
    <span class="md-ellipsis">
      3. Tokens JWT
    </span>
  </a>
  
    <nav class="md-nav" aria-label="3. Tokens JWT">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#31-what-is-a-token" class="md-nav__link">
    <span class="md-ellipsis">
      3.1. What is a token?
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#32-structure-of-jwt" class="md-nav__link">
    <span class="md-ellipsis">
      3.2. Structure of JWT
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#33-jwt-library-class" class="md-nav__link">
    <span class="md-ellipsis">
      3.3. JWT Library class
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#34-token-generation" class="md-nav__link">
    <span class="md-ellipsis">
      3.4. Token generation
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#35-token-validation" class="md-nav__link">
    <span class="md-ellipsis">
      3.5. Token validation
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#4-authentication-controller" class="md-nav__link">
    <span class="md-ellipsis">
      4. Authentication Controller
    </span>
  </a>
  
    <nav class="md-nav" aria-label="4. Authentication Controller">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#41-signup-new-user" class="md-nav__link">
    <span class="md-ellipsis">
      4.1. Signup (new user)
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#42-signin-register-or-signin" class="md-nav__link">
    <span class="md-ellipsis">
      4.2. Signin (register or signin)
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#5-tokens-working" class="md-nav__link">
    <span class="md-ellipsis">
      5. Tokens working
    </span>
  </a>
  
    <nav class="md-nav" aria-label="5. Tokens working">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#51-sending-tokens" class="md-nav__link">
    <span class="md-ellipsis">
      5.1. Sending tokens
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#6-security-config" class="md-nav__link">
    <span class="md-ellipsis">
      6. Security Config
    </span>
  </a>
  
    <nav class="md-nav" aria-label="6. Security Config">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#61-authtokenfilter" class="md-nav__link">
    <span class="md-ellipsis">
      6.1. AuthTokenFilter
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#62-authentrypoint" class="md-nav__link">
    <span class="md-ellipsis">
      6.2. AuthEntryPoint
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#7-controller-authorization" class="md-nav__link">
    <span class="md-ellipsis">
      7. Controller Authorization
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#8-exercise-how-to-use-this-project" class="md-nav__link">
    <span class="md-ellipsis">
      8. Exercise. How to use this project?
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../5_Spring_Hateoas/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    5. Spring Hateoas
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../6_Postman_Swagger/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    6. Test. Postman and Swagger
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_7" >
        
          
          <label class="md-nav__link" for="__nav_7" id="__nav_7_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Unit 6. MongoDB
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_7_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_7">
            <span class="md-nav__icon md-icon"></span>
            Unit 6. MongoDB
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../UD6_MongoDB/1_NoSQL/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    1. NoSQL databases
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../UD6_MongoDB/2_MongoDB/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2. MongoDB
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../UD6_MongoDB/3_ShellOperations/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    3. Working with MongoDB: Basic shell operations
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../UD6_MongoDB/4_Queries/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    4. Mongo Queries
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../UD6_MongoDB/5_Mongo_Java/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    5. MongoDB and Java
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../UD6_MongoDB/6_Spring_MongoDB/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    6. Spring Data MongoDB y API REST
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_8" >
        
          
          <label class="md-nav__link" for="__nav_8" id="__nav_8_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Practices
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_8_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_8">
            <span class="md-nav__icon md-icon"></span>
            Practices
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../Practiques/APAC1/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Practice 1
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../license/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    License
  </span>
  

      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#1-https" class="md-nav__link">
    <span class="md-ellipsis">
      1. HTTPS
    </span>
  </a>
  
    <nav class="md-nav" aria-label="1. HTTPS">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#11-certificate" class="md-nav__link">
    <span class="md-ellipsis">
      1.1. Certificate
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#12-configure-spring" class="md-nav__link">
    <span class="md-ellipsis">
      1.2. Configure Spring
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#2-spring-security" class="md-nav__link">
    <span class="md-ellipsis">
      2. Spring Security
    </span>
  </a>
  
    <nav class="md-nav" aria-label="2. Spring Security">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#21-users-data-for-authentication-and-authorization-models" class="md-nav__link">
    <span class="md-ellipsis">
      2.1. Users Data for Authentication and Authorization (Models)
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#22-user-roles" class="md-nav__link">
    <span class="md-ellipsis">
      2.2. User &amp; Roles
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#23-user-roles-repository" class="md-nav__link">
    <span class="md-ellipsis">
      2.3. User &amp; Roles Repository
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#24-userdetails" class="md-nav__link">
    <span class="md-ellipsis">
      2.4. UserDetails
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#25-payloads-dtos" class="md-nav__link">
    <span class="md-ellipsis">
      2.5. Payloads DTO's
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#26-signuprequest" class="md-nav__link">
    <span class="md-ellipsis">
      2.6. SignupRequest
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#27-loginrequest" class="md-nav__link">
    <span class="md-ellipsis">
      2.7. LoginRequest
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#28-jwtresponse" class="md-nav__link">
    <span class="md-ellipsis">
      2.8. JwtResponse
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#3-tokens-jwt" class="md-nav__link">
    <span class="md-ellipsis">
      3. Tokens JWT
    </span>
  </a>
  
    <nav class="md-nav" aria-label="3. Tokens JWT">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#31-what-is-a-token" class="md-nav__link">
    <span class="md-ellipsis">
      3.1. What is a token?
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#32-structure-of-jwt" class="md-nav__link">
    <span class="md-ellipsis">
      3.2. Structure of JWT
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#33-jwt-library-class" class="md-nav__link">
    <span class="md-ellipsis">
      3.3. JWT Library class
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#34-token-generation" class="md-nav__link">
    <span class="md-ellipsis">
      3.4. Token generation
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#35-token-validation" class="md-nav__link">
    <span class="md-ellipsis">
      3.5. Token validation
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#4-authentication-controller" class="md-nav__link">
    <span class="md-ellipsis">
      4. Authentication Controller
    </span>
  </a>
  
    <nav class="md-nav" aria-label="4. Authentication Controller">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#41-signup-new-user" class="md-nav__link">
    <span class="md-ellipsis">
      4.1. Signup (new user)
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#42-signin-register-or-signin" class="md-nav__link">
    <span class="md-ellipsis">
      4.2. Signin (register or signin)
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#5-tokens-working" class="md-nav__link">
    <span class="md-ellipsis">
      5. Tokens working
    </span>
  </a>
  
    <nav class="md-nav" aria-label="5. Tokens working">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#51-sending-tokens" class="md-nav__link">
    <span class="md-ellipsis">
      5.1. Sending tokens
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#6-security-config" class="md-nav__link">
    <span class="md-ellipsis">
      6. Security Config
    </span>
  </a>
  
    <nav class="md-nav" aria-label="6. Security Config">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#61-authtokenfilter" class="md-nav__link">
    <span class="md-ellipsis">
      6.1. AuthTokenFilter
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#62-authentrypoint" class="md-nav__link">
    <span class="md-ellipsis">
      6.2. AuthEntryPoint
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#7-controller-authorization" class="md-nav__link">
    <span class="md-ellipsis">
      7. Controller Authorization
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#8-exercise-how-to-use-this-project" class="md-nav__link">
    <span class="md-ellipsis">
      8. Exercise. How to use this project?
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  


  <h1>4. Security</h1>

<h2 id="1-https">1. HTTPS</h2>
<p>Nowadays, we need to add all we can do to secure our applications. We are going to study about tokens in order to authorize and authenticate our request, but we need an extra layer, https.</p>
<p>In this webpage <a href="https://tiptopsecurity.com/how-does-https-work-rsa-encryption-explained/">https://tiptopsecurity.com/how-does-https-work-rsa-encryption-explained/</a> you can find how https works</p>
<h3 id="11-certificate">1.1. Certificate</h3>
<p>Firstly, we need to generate certificates, or buy it. We will use <code>keytool</code> tool included with java development kit in order to generate. This command generates a pair (public and private) certificate.</p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Bash</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-1">1</a></span>
<span class="normal"><a href="#__codelineno-0-2">2</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1"></a>keytool<span class="w"> </span>-genkeypair<span class="w"> </span>-alias<span class="w"> </span>joange<span class="w"> </span>-keyalg<span class="w"> </span>RSA<span class="w"> </span>-keysize<span class="w"> </span><span class="m">2048</span>
<a id="__codelineno-0-2" name="__codelineno-0-2"></a>-storetype<span class="w"> </span>PKCS12<span class="w"> </span>-keystore<span class="w"> </span>jgce.p12<span class="w"> </span>-validity<span class="w"> </span><span class="m">3650</span>
</code></pre></div></td></tr></table></div>
<p>After running this command, we must answer about who we are, as follows:</p>
<p><center><img alt="keytool" src="../../../UD5_Spring/img/keytool.png" width="95%" /></center></p>
<h3 id="12-configure-spring">1.2. Configure Spring</h3>
<p>Once the process has finished, we must add the certificate inside our project. For instance inside <code>/resources/keystore</code>. Finally, we must load the certificate and enable SSL, simply adding this lines on <code>application.properties</code>:</p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Bash</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-1-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-1-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-1-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-1-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-1-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-1-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-1-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-1-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-1-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-1-10">10</a></span>
<span class="normal"><a href="#__codelineno-1-11">11</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-1-1" name="__codelineno-1-1"></a><span class="c1"># The format used for the keystore.</span>
<a id="__codelineno-1-2" name="__codelineno-1-2"></a>server.ssl.key-store-type<span class="o">=</span>PKCS12
<a id="__codelineno-1-3" name="__codelineno-1-3"></a><span class="c1"># The path to the keystore containing the certificate</span>
<a id="__codelineno-1-4" name="__codelineno-1-4"></a>server.ssl.key-store<span class="o">=</span>classpath:keystore/jgce.p12
<a id="__codelineno-1-5" name="__codelineno-1-5"></a><span class="c1"># The password used to generate the certificate</span>
<a id="__codelineno-1-6" name="__codelineno-1-6"></a>server.ssl.key-store-password<span class="o">=</span>joangeca
<a id="__codelineno-1-7" name="__codelineno-1-7"></a><span class="c1"># The alias mapped to the certificate</span>
<a id="__codelineno-1-8" name="__codelineno-1-8"></a>server.ssl.key-alias<span class="o">=</span>joange
<a id="__codelineno-1-9" name="__codelineno-1-9"></a>
<a id="__codelineno-1-10" name="__codelineno-1-10"></a><span class="c1"># Use HTTPS instead of HTTP</span>
<a id="__codelineno-1-11" name="__codelineno-1-11"></a>server.ssl.enabled<span class="o">=</span><span class="nb">true</span>
</code></pre></div></td></tr></table></div>
<p><center><img alt="HTTPS_Spring_Project" src="../../../UD5_Spring/img/HTTPS_Spring_Project.png" width="95%" /></center></p>
<p>And it is all, when Spring starts we will see that is working with <code>https</code> protocol:</p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Bash</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-2-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-2-1" name="__codelineno-2-1"></a><span class="m">2023</span>-01-13<span class="w"> </span><span class="m">08</span>:29:37.267<span class="w">  </span>INFO<span class="w"> </span><span class="m">83291</span><span class="w"> </span>---<span class="w"> </span><span class="o">[</span><span class="w">           </span>main<span class="o">]</span><span class="w"> </span>o.s.b.w.embedded.tomcat.TomcatWebServer<span class="w">  </span>:<span class="w"> </span>Tomcat<span class="w"> </span>initialized<span class="w"> </span>with<span class="w"> </span>port<span class="o">(</span>s<span class="o">)</span>:<span class="w"> </span><span class="m">9091</span><span class="w"> </span><span class="o">(</span>https<span class="o">)</span>
</code></pre></div></td></tr></table></div>
<p><center><img alt="HTTPS_Working" src="../../../UD5_Spring/img/HTTPS_Working.png" width="95%" /></center></p>
<p>and in the request probably browsers will not trust with our certificate (we must add a confidence exception):</p>
<p><center><img alt="Certificate" src="../../../UD5_Spring/img/Certificate.png" width="95%" /></center></p>
<h2 id="2-spring-security">2. Spring Security</h2>
<p>Spring Security is an umbrella project that group all mechanisms referent to security. We need to add:</p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">XML</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-3-1">1</a></span>
<span class="normal"><a href="#__codelineno-3-2">2</a></span>
<span class="normal"><a href="#__codelineno-3-3">3</a></span>
<span class="normal"><a href="#__codelineno-3-4">4</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-3-1" name="__codelineno-3-1"></a><span class="nt">&lt;dependency&gt;</span>
<a id="__codelineno-3-2" name="__codelineno-3-2"></a><span class="nt">&lt;groupId&gt;</span>org.springframework.boot<span class="nt">&lt;/groupId&gt;</span>
<a id="__codelineno-3-3" name="__codelineno-3-3"></a><span class="nt">&lt;artifactId&gt;</span>spring-boot-starter-security<span class="nt">&lt;/artifactId&gt;</span><span class="w"> </span>
<a id="__codelineno-3-4" name="__codelineno-3-4"></a><span class="nt">&lt;/dependency&gt;</span>
</code></pre></div></td></tr></table></div>
<p>and magically:</p>
<ul>
<li>The default configuration is enabled, through a filter, called <code>SpringSecurityFilterChain</code>.</li>
<li>A bean of type <code>UserDetailsService</code> is created with a user named user and a random password that is printed by the console.</li>
<li>The filter is registered in the servlet container for all requests.</li>
</ul>
<p>Although you have not configured much, it has many consequences:</p>
<ul>
<li>Requires authentication to interact with our application</li>
<li>Generates a default login form.</li>
<li>Generates a logout mechanism</li>
<li>Protect password storage with <code>BCrypt</code>.</li>
<li>Provides against CSRF attacks, Session Fixation, Clickjacking...</li>
</ul>
<p>We can create a configuration class, with this content:</p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Java</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-4-1">1</a></span>
<span class="normal"><a href="#__codelineno-4-2">2</a></span>
<span class="normal"><a href="#__codelineno-4-3">3</a></span>
<span class="normal"><a href="#__codelineno-4-4">4</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-4-1" name="__codelineno-4-1"></a><span class="nd">@Configuration</span>
<a id="__codelineno-4-2" name="__codelineno-4-2"></a><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">SecurityConfig</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-4-3" name="__codelineno-4-3"></a>
<a id="__codelineno-4-4" name="__codelineno-4-4"></a><span class="p">}</span>
</code></pre></div></td></tr></table></div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>We will come back to this class to add more configurations. Most interesting is method configure, and creation of several Beans used by another classes.</p>
</div>
<h3 id="21-users-data-for-authentication-and-authorization-models">2.1. Users Data for Authentication and Authorization (Models)</h3>
<div class="admonition important">
<p class="admonition-title">Important</p>
<p>From now, this sample is based from a famous webpage <a href="https://www.bezkoder.com">https://www.bezkoder.com</a>. We explain all necessary from the sample who you can view <a href="https://www.bezkoder.com/spring-boot-jwt-authentication/">here</a>.</p>
</div>
<p>In this section we are going to prepare our application to identify users, with several roles. With these roles, we could grant access or not to several resources.</p>
<h3 id="22-user-roles">2.2. User &amp; Roles</h3>
<p>To do this, we net to create a <code>User</code> class, to store this information in our database. This user could have a collection of <em>roles</em>. We can do it with a many-to-many relationship.</p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Java</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-5-1">1</a></span>
<span class="normal"><a href="#__codelineno-5-2">2</a></span>
<span class="normal"><a href="#__codelineno-5-3">3</a></span>
<span class="normal"><a href="#__codelineno-5-4">4</a></span>
<span class="normal"><a href="#__codelineno-5-5">5</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-5-1" name="__codelineno-5-1"></a><span class="kd">public</span><span class="w"> </span><span class="kd">enum</span><span class="w"> </span><span class="n">ERole</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-5-2" name="__codelineno-5-2"></a><span class="w">  </span><span class="n">ROLE_USER</span><span class="p">,</span>
<a id="__codelineno-5-3" name="__codelineno-5-3"></a><span class="w">  </span><span class="n">ROLE_MODERATOR</span><span class="p">,</span>
<a id="__codelineno-5-4" name="__codelineno-5-4"></a><span class="w">  </span><span class="n">ROLE_ADMIN</span>
<a id="__codelineno-5-5" name="__codelineno-5-5"></a><span class="p">}</span>
</code></pre></div></td></tr></table></div>
<p>based on this enumeration, we will do a <code>Role</code> class to store the roles that our application will support:</p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Java</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-6-1">1</a></span>
<span class="normal"><a href="#__codelineno-6-2">2</a></span>
<span class="normal"><a href="#__codelineno-6-3">3</a></span>
<span class="normal"><a href="#__codelineno-6-4">4</a></span>
<span class="normal"><a href="#__codelineno-6-5">5</a></span>
<span class="normal"><a href="#__codelineno-6-6">6</a></span>
<span class="normal"><a href="#__codelineno-6-7">7</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-6-1" name="__codelineno-6-1"></a><span class="nd">@Data</span>
<a id="__codelineno-6-2" name="__codelineno-6-2"></a><span class="nd">@Entity</span>
<a id="__codelineno-6-3" name="__codelineno-6-3"></a><span class="nd">@Table</span><span class="p">(</span><span class="n">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;roles&quot;</span><span class="p">)</span>
<a id="__codelineno-6-4" name="__codelineno-6-4"></a><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">Role</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-6-5" name="__codelineno-6-5"></a><span class="w">  </span><span class="kd">private</span><span class="w"> </span><span class="n">Integer</span><span class="w"> </span><span class="n">id</span><span class="p">;</span>
<a id="__codelineno-6-6" name="__codelineno-6-6"></a><span class="w">  </span><span class="kd">private</span><span class="w"> </span><span class="n">ERole</span><span class="w"> </span><span class="n">name</span><span class="p">;</span>
<a id="__codelineno-6-7" name="__codelineno-6-7"></a><span class="p">}</span>
</code></pre></div></td></tr></table></div>
<p>finally, then a <code>User</code> class as follows. We add new annotations of validation:</p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Java</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-7-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-7-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-7-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-7-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-7-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-7-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-7-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-7-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-7-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-7-10">10</a></span>
<span class="normal"><a href="#__codelineno-7-11">11</a></span>
<span class="normal"><a href="#__codelineno-7-12">12</a></span>
<span class="normal"><a href="#__codelineno-7-13">13</a></span>
<span class="normal"><a href="#__codelineno-7-14">14</a></span>
<span class="normal"><a href="#__codelineno-7-15">15</a></span>
<span class="normal"><a href="#__codelineno-7-16">16</a></span>
<span class="normal"><a href="#__codelineno-7-17">17</a></span>
<span class="normal"><a href="#__codelineno-7-18">18</a></span>
<span class="normal"><a href="#__codelineno-7-19">19</a></span>
<span class="normal"><a href="#__codelineno-7-20">20</a></span>
<span class="normal"><a href="#__codelineno-7-21">21</a></span>
<span class="normal"><a href="#__codelineno-7-22">22</a></span>
<span class="normal"><a href="#__codelineno-7-23">23</a></span>
<span class="normal"><a href="#__codelineno-7-24">24</a></span>
<span class="normal"><a href="#__codelineno-7-25">25</a></span>
<span class="normal"><a href="#__codelineno-7-26">26</a></span>
<span class="normal"><a href="#__codelineno-7-27">27</a></span>
<span class="normal"><a href="#__codelineno-7-28">28</a></span>
<span class="normal"><a href="#__codelineno-7-29">29</a></span>
<span class="normal"><a href="#__codelineno-7-30">30</a></span>
<span class="normal"><a href="#__codelineno-7-31">31</a></span>
<span class="normal"><a href="#__codelineno-7-32">32</a></span>
<span class="normal"><a href="#__codelineno-7-33">33</a></span>
<span class="normal"><a href="#__codelineno-7-34">34</a></span>
<span class="normal"><a href="#__codelineno-7-35">35</a></span>
<span class="normal"><a href="#__codelineno-7-36">36</a></span>
<span class="normal"><a href="#__codelineno-7-37">37</a></span>
<span class="normal"><a href="#__codelineno-7-38">38</a></span>
<span class="normal"><a href="#__codelineno-7-39">39</a></span>
<span class="normal"><a href="#__codelineno-7-40">40</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-7-1" name="__codelineno-7-1"></a><span class="nd">@Entity</span>
<a id="__codelineno-7-2" name="__codelineno-7-2"></a><span class="nd">@Table</span><span class="p">(</span><span class="n">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;users&quot;</span><span class="p">,</span><span class="w"> </span>
<a id="__codelineno-7-3" name="__codelineno-7-3"></a><span class="w">    </span><span class="n">uniqueConstraints</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"> </span>
<a id="__codelineno-7-4" name="__codelineno-7-4"></a><span class="w">      </span><span class="nd">@UniqueConstraint</span><span class="p">(</span><span class="n">columnNames</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;username&quot;</span><span class="p">),</span>
<a id="__codelineno-7-5" name="__codelineno-7-5"></a><span class="w">      </span><span class="nd">@UniqueConstraint</span><span class="p">(</span><span class="n">columnNames</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;email&quot;</span><span class="p">)</span><span class="w"> </span>
<a id="__codelineno-7-6" name="__codelineno-7-6"></a><span class="w">    </span><span class="p">})</span>
<a id="__codelineno-7-7" name="__codelineno-7-7"></a><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">User</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-7-8" name="__codelineno-7-8"></a><span class="w">  </span><span class="nd">@Id</span>
<a id="__codelineno-7-9" name="__codelineno-7-9"></a><span class="w">  </span><span class="nd">@GeneratedValue</span><span class="p">(</span><span class="n">strategy</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">GenerationType</span><span class="p">.</span><span class="na">IDENTITY</span><span class="p">)</span>
<a id="__codelineno-7-10" name="__codelineno-7-10"></a><span class="w">  </span><span class="kd">private</span><span class="w"> </span><span class="n">Long</span><span class="w"> </span><span class="n">id</span><span class="p">;</span>
<a id="__codelineno-7-11" name="__codelineno-7-11"></a>
<a id="__codelineno-7-12" name="__codelineno-7-12"></a><span class="w">  </span><span class="nd">@NotBlank</span>
<a id="__codelineno-7-13" name="__codelineno-7-13"></a><span class="w">  </span><span class="nd">@Size</span><span class="p">(</span><span class="n">max</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">20</span><span class="p">)</span>
<a id="__codelineno-7-14" name="__codelineno-7-14"></a><span class="w">  </span><span class="kd">private</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">username</span><span class="p">;</span>
<a id="__codelineno-7-15" name="__codelineno-7-15"></a>
<a id="__codelineno-7-16" name="__codelineno-7-16"></a><span class="w">  </span><span class="nd">@NotBlank</span>
<a id="__codelineno-7-17" name="__codelineno-7-17"></a><span class="w">  </span><span class="nd">@Size</span><span class="p">(</span><span class="n">max</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">50</span><span class="p">)</span>
<a id="__codelineno-7-18" name="__codelineno-7-18"></a><span class="w">  </span><span class="nd">@Email</span>
<a id="__codelineno-7-19" name="__codelineno-7-19"></a><span class="w">  </span><span class="kd">private</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">email</span><span class="p">;</span>
<a id="__codelineno-7-20" name="__codelineno-7-20"></a>
<a id="__codelineno-7-21" name="__codelineno-7-21"></a><span class="w">  </span><span class="nd">@NotBlank</span>
<a id="__codelineno-7-22" name="__codelineno-7-22"></a><span class="w">  </span><span class="nd">@Size</span><span class="p">(</span><span class="n">max</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">120</span><span class="p">)</span>
<a id="__codelineno-7-23" name="__codelineno-7-23"></a><span class="w">  </span><span class="kd">private</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">password</span><span class="p">;</span>
<a id="__codelineno-7-24" name="__codelineno-7-24"></a>
<a id="__codelineno-7-25" name="__codelineno-7-25"></a><span class="w">  </span><span class="nd">@ManyToMany</span><span class="p">(</span><span class="n">fetch</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">FetchType</span><span class="p">.</span><span class="na">LAZY</span><span class="p">)</span>
<a id="__codelineno-7-26" name="__codelineno-7-26"></a><span class="w">  </span><span class="nd">@JoinTable</span><span class="p">(</span><span class="w"> </span><span class="n">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;user_roles&quot;</span><span class="p">,</span><span class="w"> </span>
<a id="__codelineno-7-27" name="__codelineno-7-27"></a><span class="w">        </span><span class="n">joinColumns</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nd">@JoinColumn</span><span class="p">(</span><span class="n">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;user_id&quot;</span><span class="p">),</span><span class="w"> </span>
<a id="__codelineno-7-28" name="__codelineno-7-28"></a><span class="w">        </span><span class="n">inverseJoinColumns</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nd">@JoinColumn</span><span class="p">(</span><span class="n">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;role_id&quot;</span><span class="p">))</span>
<a id="__codelineno-7-29" name="__codelineno-7-29"></a><span class="w">  </span><span class="kd">private</span><span class="w"> </span><span class="n">Set</span><span class="o">&lt;</span><span class="n">Role</span><span class="o">&gt;</span><span class="w"> </span><span class="n">roles</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">HashSet</span><span class="o">&lt;&gt;</span><span class="p">();</span>
<a id="__codelineno-7-30" name="__codelineno-7-30"></a>
<a id="__codelineno-7-31" name="__codelineno-7-31"></a><span class="w">  </span><span class="kd">public</span><span class="w"> </span><span class="nf">User</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-7-32" name="__codelineno-7-32"></a><span class="w">  </span><span class="p">}</span>
<a id="__codelineno-7-33" name="__codelineno-7-33"></a>
<a id="__codelineno-7-34" name="__codelineno-7-34"></a><span class="w">  </span><span class="kd">public</span><span class="w"> </span><span class="nf">User</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">username</span><span class="p">,</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">email</span><span class="p">,</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">password</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-7-35" name="__codelineno-7-35"></a><span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="na">username</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">username</span><span class="p">;</span>
<a id="__codelineno-7-36" name="__codelineno-7-36"></a><span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="na">email</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">email</span><span class="p">;</span>
<a id="__codelineno-7-37" name="__codelineno-7-37"></a><span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="na">password</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">password</span><span class="p">;</span>
<a id="__codelineno-7-38" name="__codelineno-7-38"></a><span class="w">  </span><span class="p">}</span>
<a id="__codelineno-7-39" name="__codelineno-7-39"></a>
<a id="__codelineno-7-40" name="__codelineno-7-40"></a><span class="p">}</span>
</code></pre></div></td></tr></table></div>
<h3 id="23-user-roles-repository">2.3. User &amp; Roles Repository</h3>
<p>We need to create our repos about last entities, creating interfaces like we normally create.</p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Java</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-8-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-8-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-8-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-8-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-8-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-8-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-8-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-8-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-8-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-8-10">10</a></span>
<span class="normal"><a href="#__codelineno-8-11">11</a></span>
<span class="normal"><a href="#__codelineno-8-12">12</a></span>
<span class="normal"><a href="#__codelineno-8-13">13</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-8-1" name="__codelineno-8-1"></a><span class="nd">@Repository</span>
<a id="__codelineno-8-2" name="__codelineno-8-2"></a><span class="kd">public</span><span class="w"> </span><span class="kd">interface</span> <span class="nc">RoleRepository</span><span class="w"> </span><span class="kd">extends</span><span class="w"> </span><span class="n">JpaRepository</span><span class="o">&lt;</span><span class="n">Role</span><span class="p">,</span><span class="w"> </span><span class="n">Long</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-8-3" name="__codelineno-8-3"></a><span class="w">  </span><span class="n">Optional</span><span class="o">&lt;</span><span class="n">Role</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">findByName</span><span class="p">(</span><span class="n">ERole</span><span class="w"> </span><span class="n">name</span><span class="p">);</span>
<a id="__codelineno-8-4" name="__codelineno-8-4"></a><span class="p">}</span>
<a id="__codelineno-8-5" name="__codelineno-8-5"></a>
<a id="__codelineno-8-6" name="__codelineno-8-6"></a><span class="nd">@Repository</span>
<a id="__codelineno-8-7" name="__codelineno-8-7"></a><span class="kd">public</span><span class="w"> </span><span class="kd">interface</span> <span class="nc">UserRepository</span><span class="w"> </span><span class="kd">extends</span><span class="w"> </span><span class="n">JpaRepository</span><span class="o">&lt;</span><span class="n">User</span><span class="p">,</span><span class="w"> </span><span class="n">Long</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-8-8" name="__codelineno-8-8"></a><span class="w">  </span><span class="n">Optional</span><span class="o">&lt;</span><span class="n">User</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">findByUsername</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">username</span><span class="p">);</span>
<a id="__codelineno-8-9" name="__codelineno-8-9"></a>
<a id="__codelineno-8-10" name="__codelineno-8-10"></a><span class="w">  </span><span class="n">Boolean</span><span class="w"> </span><span class="nf">existsByUsername</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">username</span><span class="p">);</span>
<a id="__codelineno-8-11" name="__codelineno-8-11"></a>
<a id="__codelineno-8-12" name="__codelineno-8-12"></a><span class="w">  </span><span class="n">Boolean</span><span class="w"> </span><span class="nf">existsByEmail</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">email</span><span class="p">);</span>
<a id="__codelineno-8-13" name="__codelineno-8-13"></a><span class="p">}</span>
</code></pre></div></td></tr></table></div>
<p>We also add methods to check User existance by name and email, and methods to find by name, either <code>User</code> and <code>Role</code></p>
<h3 id="24-userdetails">2.4. UserDetails</h3>
<p>Spring needs that someone implements <code>UserDetails</code> interface, very important because Spring Security will use a <code>UserDetails</code>. <code>UserDetails</code> contains necessary information to build an <code>Authentication</code> object from DAOs or other source of security data. We create a class, called <code>UserDetailsImpl</code>, who:</p>
<ul>
<li>Must have <code>username</code> and <code>passsord</code> fields, and getters. You must respect names, any changes is prohibited. These methods will be used by authentication classes.</li>
<li>Override methods from <code>UserDetails</code>, for instance <code>getAuthorities()</code> and several methods to control if the user is blocked, expired, etc.</li>
</ul>
<p>Full class:</p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Java</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-9-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-9-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-9-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-9-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-9-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-9-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-9-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-9-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-9-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-9-10">10</a></span>
<span class="normal"><a href="#__codelineno-9-11">11</a></span>
<span class="normal"><a href="#__codelineno-9-12">12</a></span>
<span class="normal"><a href="#__codelineno-9-13">13</a></span>
<span class="normal"><a href="#__codelineno-9-14">14</a></span>
<span class="normal"><a href="#__codelineno-9-15">15</a></span>
<span class="normal"><a href="#__codelineno-9-16">16</a></span>
<span class="normal"><a href="#__codelineno-9-17">17</a></span>
<span class="normal"><a href="#__codelineno-9-18">18</a></span>
<span class="normal"><a href="#__codelineno-9-19">19</a></span>
<span class="normal"><a href="#__codelineno-9-20">20</a></span>
<span class="normal"><a href="#__codelineno-9-21">21</a></span>
<span class="normal"><a href="#__codelineno-9-22">22</a></span>
<span class="normal"><a href="#__codelineno-9-23">23</a></span>
<span class="normal"><a href="#__codelineno-9-24">24</a></span>
<span class="normal"><a href="#__codelineno-9-25">25</a></span>
<span class="normal"><a href="#__codelineno-9-26">26</a></span>
<span class="normal"><a href="#__codelineno-9-27">27</a></span>
<span class="normal"><a href="#__codelineno-9-28">28</a></span>
<span class="normal"><a href="#__codelineno-9-29">29</a></span>
<span class="normal"><a href="#__codelineno-9-30">30</a></span>
<span class="normal"><a href="#__codelineno-9-31">31</a></span>
<span class="normal"><a href="#__codelineno-9-32">32</a></span>
<span class="normal"><a href="#__codelineno-9-33">33</a></span>
<span class="normal"><a href="#__codelineno-9-34">34</a></span>
<span class="normal"><a href="#__codelineno-9-35">35</a></span>
<span class="normal"><a href="#__codelineno-9-36">36</a></span>
<span class="normal"><a href="#__codelineno-9-37">37</a></span>
<span class="normal"><a href="#__codelineno-9-38">38</a></span>
<span class="normal"><a href="#__codelineno-9-39">39</a></span>
<span class="normal"><a href="#__codelineno-9-40">40</a></span>
<span class="normal"><a href="#__codelineno-9-41">41</a></span>
<span class="normal"><a href="#__codelineno-9-42">42</a></span>
<span class="normal"><a href="#__codelineno-9-43">43</a></span>
<span class="normal"><a href="#__codelineno-9-44">44</a></span>
<span class="normal"><a href="#__codelineno-9-45">45</a></span>
<span class="normal"><a href="#__codelineno-9-46">46</a></span>
<span class="normal"><a href="#__codelineno-9-47">47</a></span>
<span class="normal"><a href="#__codelineno-9-48">48</a></span>
<span class="normal"><a href="#__codelineno-9-49">49</a></span>
<span class="normal"><a href="#__codelineno-9-50">50</a></span>
<span class="normal"><a href="#__codelineno-9-51">51</a></span>
<span class="normal"><a href="#__codelineno-9-52">52</a></span>
<span class="normal"><a href="#__codelineno-9-53">53</a></span>
<span class="normal"><a href="#__codelineno-9-54">54</a></span>
<span class="normal"><a href="#__codelineno-9-55">55</a></span>
<span class="normal"><a href="#__codelineno-9-56">56</a></span>
<span class="normal"><a href="#__codelineno-9-57">57</a></span>
<span class="normal"><a href="#__codelineno-9-58">58</a></span>
<span class="normal"><a href="#__codelineno-9-59">59</a></span>
<span class="normal"><a href="#__codelineno-9-60">60</a></span>
<span class="normal"><a href="#__codelineno-9-61">61</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-9-1" name="__codelineno-9-1"></a><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">UserDetailsImpl</span><span class="w"> </span><span class="kd">implements</span><span class="w"> </span><span class="n">UserDetails</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-9-2" name="__codelineno-9-2"></a><span class="w">  </span><span class="kd">private</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">serialVersionUID</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1L</span><span class="p">;</span>
<a id="__codelineno-9-3" name="__codelineno-9-3"></a>
<a id="__codelineno-9-4" name="__codelineno-9-4"></a><span class="w">  </span><span class="kd">private</span><span class="w"> </span><span class="n">Long</span><span class="w"> </span><span class="n">id</span><span class="p">;</span>
<a id="__codelineno-9-5" name="__codelineno-9-5"></a><span class="w">  </span><span class="kd">private</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">username</span><span class="p">;</span>
<a id="__codelineno-9-6" name="__codelineno-9-6"></a><span class="w">  </span><span class="kd">private</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">email</span><span class="p">;</span>
<a id="__codelineno-9-7" name="__codelineno-9-7"></a>
<a id="__codelineno-9-8" name="__codelineno-9-8"></a><span class="w">  </span><span class="nd">@JsonIgnore</span>
<a id="__codelineno-9-9" name="__codelineno-9-9"></a><span class="w">  </span><span class="kd">private</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">password</span><span class="p">;</span>
<a id="__codelineno-9-10" name="__codelineno-9-10"></a>
<a id="__codelineno-9-11" name="__codelineno-9-11"></a><span class="w">  </span><span class="kd">private</span><span class="w"> </span><span class="n">Collection</span><span class="o">&lt;?</span><span class="w"> </span><span class="kd">extends</span><span class="w"> </span><span class="n">GrantedAuthority</span><span class="o">&gt;</span><span class="w"> </span><span class="n">authorities</span><span class="p">;</span>
<a id="__codelineno-9-12" name="__codelineno-9-12"></a>
<a id="__codelineno-9-13" name="__codelineno-9-13"></a><span class="w">  </span><span class="kd">public</span><span class="w"> </span><span class="nf">UserDetailsImpl</span><span class="p">(</span><span class="n">Long</span><span class="w"> </span><span class="n">id</span><span class="p">,</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">username</span><span class="p">,</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">email</span><span class="p">,</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">password</span><span class="p">,</span>
<a id="__codelineno-9-14" name="__codelineno-9-14"></a><span class="w">      </span><span class="n">Collection</span><span class="o">&lt;?</span><span class="w"> </span><span class="kd">extends</span><span class="w"> </span><span class="n">GrantedAuthority</span><span class="o">&gt;</span><span class="w"> </span><span class="n">authorities</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-9-15" name="__codelineno-9-15"></a><span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="na">id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">id</span><span class="p">;</span>
<a id="__codelineno-9-16" name="__codelineno-9-16"></a><span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="na">username</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">username</span><span class="p">;</span>
<a id="__codelineno-9-17" name="__codelineno-9-17"></a><span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="na">email</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">email</span><span class="p">;</span>
<a id="__codelineno-9-18" name="__codelineno-9-18"></a><span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="na">password</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">password</span><span class="p">;</span>
<a id="__codelineno-9-19" name="__codelineno-9-19"></a><span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="na">authorities</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">authorities</span><span class="p">;</span>
<a id="__codelineno-9-20" name="__codelineno-9-20"></a><span class="w">  </span><span class="p">}</span>
<a id="__codelineno-9-21" name="__codelineno-9-21"></a>
<a id="__codelineno-9-22" name="__codelineno-9-22"></a><span class="w">  </span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="n">UserDetailsImpl</span><span class="w"> </span><span class="nf">build</span><span class="p">(</span><span class="n">User</span><span class="w"> </span><span class="n">user</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-9-23" name="__codelineno-9-23"></a><span class="w">    </span><span class="n">List</span><span class="o">&lt;</span><span class="n">GrantedAuthority</span><span class="o">&gt;</span><span class="w"> </span><span class="n">authorities</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">user</span><span class="p">.</span><span class="na">getRoles</span><span class="p">().</span><span class="na">stream</span><span class="p">()</span>
<a id="__codelineno-9-24" name="__codelineno-9-24"></a><span class="w">        </span><span class="p">.</span><span class="na">map</span><span class="p">(</span><span class="n">role</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">SimpleGrantedAuthority</span><span class="p">(</span><span class="n">role</span><span class="p">.</span><span class="na">getName</span><span class="p">().</span><span class="na">name</span><span class="p">()))</span>
<a id="__codelineno-9-25" name="__codelineno-9-25"></a><span class="w">        </span><span class="p">.</span><span class="na">collect</span><span class="p">(</span><span class="n">Collectors</span><span class="p">.</span><span class="na">toList</span><span class="p">());</span>
<a id="__codelineno-9-26" name="__codelineno-9-26"></a>
<a id="__codelineno-9-27" name="__codelineno-9-27"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">UserDetailsImpl</span><span class="p">(</span>
<a id="__codelineno-9-28" name="__codelineno-9-28"></a><span class="w">        </span><span class="n">user</span><span class="p">.</span><span class="na">getId</span><span class="p">(),</span><span class="w"> </span>
<a id="__codelineno-9-29" name="__codelineno-9-29"></a><span class="w">        </span><span class="n">user</span><span class="p">.</span><span class="na">getUsername</span><span class="p">(),</span><span class="w"> </span>
<a id="__codelineno-9-30" name="__codelineno-9-30"></a><span class="w">        </span><span class="n">user</span><span class="p">.</span><span class="na">getEmail</span><span class="p">(),</span>
<a id="__codelineno-9-31" name="__codelineno-9-31"></a><span class="w">        </span><span class="n">user</span><span class="p">.</span><span class="na">getPassword</span><span class="p">(),</span><span class="w"> </span>
<a id="__codelineno-9-32" name="__codelineno-9-32"></a><span class="w">        </span><span class="n">authorities</span><span class="p">);</span>
<a id="__codelineno-9-33" name="__codelineno-9-33"></a><span class="w">  </span><span class="p">}</span>
<a id="__codelineno-9-34" name="__codelineno-9-34"></a>
<a id="__codelineno-9-35" name="__codelineno-9-35"></a><span class="w">  </span><span class="nd">@Override</span>
<a id="__codelineno-9-36" name="__codelineno-9-36"></a><span class="w">  </span><span class="kd">public</span><span class="w"> </span><span class="n">Collection</span><span class="o">&lt;?</span><span class="w"> </span><span class="kd">extends</span><span class="w"> </span><span class="n">GrantedAuthority</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">getAuthorities</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-9-37" name="__codelineno-9-37"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">authorities</span><span class="p">;</span>
<a id="__codelineno-9-38" name="__codelineno-9-38"></a><span class="w">  </span><span class="p">}</span>
<a id="__codelineno-9-39" name="__codelineno-9-39"></a>
<a id="__codelineno-9-40" name="__codelineno-9-40"></a>
<a id="__codelineno-9-41" name="__codelineno-9-41"></a><span class="w">  </span><span class="nd">@Override</span>
<a id="__codelineno-9-42" name="__codelineno-9-42"></a><span class="w">  </span><span class="kd">public</span><span class="w"> </span><span class="kt">boolean</span><span class="w"> </span><span class="nf">isAccountNonExpired</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-9-43" name="__codelineno-9-43"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span>
<a id="__codelineno-9-44" name="__codelineno-9-44"></a><span class="w">  </span><span class="p">}</span>
<a id="__codelineno-9-45" name="__codelineno-9-45"></a>
<a id="__codelineno-9-46" name="__codelineno-9-46"></a><span class="w">  </span><span class="nd">@Override</span>
<a id="__codelineno-9-47" name="__codelineno-9-47"></a><span class="w">  </span><span class="kd">public</span><span class="w"> </span><span class="kt">boolean</span><span class="w"> </span><span class="nf">isAccountNonLocked</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-9-48" name="__codelineno-9-48"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span>
<a id="__codelineno-9-49" name="__codelineno-9-49"></a><span class="w">  </span><span class="p">}</span>
<a id="__codelineno-9-50" name="__codelineno-9-50"></a>
<a id="__codelineno-9-51" name="__codelineno-9-51"></a><span class="w">  </span><span class="nd">@Override</span>
<a id="__codelineno-9-52" name="__codelineno-9-52"></a><span class="w">  </span><span class="kd">public</span><span class="w"> </span><span class="kt">boolean</span><span class="w"> </span><span class="nf">isCredentialsNonExpired</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-9-53" name="__codelineno-9-53"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span>
<a id="__codelineno-9-54" name="__codelineno-9-54"></a><span class="w">  </span><span class="p">}</span>
<a id="__codelineno-9-55" name="__codelineno-9-55"></a>
<a id="__codelineno-9-56" name="__codelineno-9-56"></a><span class="w">  </span><span class="nd">@Override</span>
<a id="__codelineno-9-57" name="__codelineno-9-57"></a><span class="w">  </span><span class="kd">public</span><span class="w"> </span><span class="kt">boolean</span><span class="w"> </span><span class="nf">isEnabled</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-9-58" name="__codelineno-9-58"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span>
<a id="__codelineno-9-59" name="__codelineno-9-59"></a><span class="w">  </span><span class="p">}</span>
<a id="__codelineno-9-60" name="__codelineno-9-60"></a>
<a id="__codelineno-9-61" name="__codelineno-9-61"></a><span class="p">}</span>
</code></pre></div></td></tr></table></div>
<p>Notice than:</p>
<ul>
<li>We use <code>private Collection&lt;? extends GrantedAuthority&gt; authorities;</code> to store the authorities (i.e. roles) in format who is understood by Spring Security.</li>
<li>Instead of create a constructor, we create a <code>builder()</code>, who recieve a <code>User</code>, extract the information from it and transform the <code>List&lt;Role&gt;</code> into authorities, and then, the builder call to constructor.</li>
</ul>
<p>Instead of create a User and Role <code>Service</code>, we will create a <code>UserDetailSeriveImpl</code> (who implements Spring's <code>UserDetailService</code>), in order to recover a User from repository, and then returns a <code>UserDetailImpl</code>, as follows:</p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Java</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-10-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-10-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-10-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-10-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-10-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-10-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-10-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-10-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-10-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-10-10">10</a></span>
<span class="normal"><a href="#__codelineno-10-11">11</a></span>
<span class="normal"><a href="#__codelineno-10-12">12</a></span>
<span class="normal"><a href="#__codelineno-10-13">13</a></span>
<span class="normal"><a href="#__codelineno-10-14">14</a></span>
<span class="normal"><a href="#__codelineno-10-15">15</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-10-1" name="__codelineno-10-1"></a><span class="nd">@Service</span>
<a id="__codelineno-10-2" name="__codelineno-10-2"></a><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">UserDetailsServiceImpl</span><span class="w"> </span><span class="kd">implements</span><span class="w"> </span><span class="n">UserDetailsService</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-10-3" name="__codelineno-10-3"></a><span class="w">  </span><span class="nd">@Autowired</span>
<a id="__codelineno-10-4" name="__codelineno-10-4"></a><span class="w">  </span><span class="n">UserRepository</span><span class="w"> </span><span class="n">userRepository</span><span class="p">;</span>
<a id="__codelineno-10-5" name="__codelineno-10-5"></a>
<a id="__codelineno-10-6" name="__codelineno-10-6"></a><span class="w">  </span><span class="nd">@Override</span>
<a id="__codelineno-10-7" name="__codelineno-10-7"></a><span class="w">  </span><span class="nd">@Transactional</span>
<a id="__codelineno-10-8" name="__codelineno-10-8"></a><span class="w">  </span><span class="kd">public</span><span class="w"> </span><span class="n">UserDetails</span><span class="w"> </span><span class="nf">loadUserByUsername</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">username</span><span class="p">)</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">UsernameNotFoundException</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-10-9" name="__codelineno-10-9"></a><span class="w">    </span><span class="n">User</span><span class="w"> </span><span class="n">user</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">userRepository</span><span class="p">.</span><span class="na">findByUsername</span><span class="p">(</span><span class="n">username</span><span class="p">)</span>
<a id="__codelineno-10-10" name="__codelineno-10-10"></a><span class="w">        </span><span class="p">.</span><span class="na">orElseThrow</span><span class="p">(()</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">UsernameNotFoundException</span><span class="p">(</span><span class="s">&quot;User Not Found with username: &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">username</span><span class="p">));</span>
<a id="__codelineno-10-11" name="__codelineno-10-11"></a>
<a id="__codelineno-10-12" name="__codelineno-10-12"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">UserDetailsImpl</span><span class="p">.</span><span class="na">build</span><span class="p">(</span><span class="n">user</span><span class="p">);</span>
<a id="__codelineno-10-13" name="__codelineno-10-13"></a><span class="w">  </span><span class="p">}</span>
<a id="__codelineno-10-14" name="__codelineno-10-14"></a>
<a id="__codelineno-10-15" name="__codelineno-10-15"></a><span class="p">}</span>
</code></pre></div></td></tr></table></div>
<h3 id="25-payloads-dtos">2.5. Payloads DTO's</h3>
<p>In this section we are going to see the necessary classes who store information to:</p>
<ul>
<li>Signup a new User, to receive information from client and store a new user. This class is <code>SignupRequest</code></li>
<li>Signin a User, to login in our system. This class is <code>LoginRequest</code></li>
<li>JwtResponse, related as response to the signin request. This response will contain a <strong>JWT Token</strong>, used to Authorize subsequent request. This class is <code>JwtResponse</code></li>
</ul>
<h3 id="26-signuprequest">2.6. SignupRequest</h3>
<p>This class contains information who register a new user. Is contains validation annotations. </p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Java</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-11-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-11-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-11-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-11-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-11-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-11-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-11-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-11-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-11-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-11-10">10</a></span>
<span class="normal"><a href="#__codelineno-11-11">11</a></span>
<span class="normal"><a href="#__codelineno-11-12">12</a></span>
<span class="normal"><a href="#__codelineno-11-13">13</a></span>
<span class="normal"><a href="#__codelineno-11-14">14</a></span>
<span class="normal"><a href="#__codelineno-11-15">15</a></span>
<span class="normal"><a href="#__codelineno-11-16">16</a></span>
<span class="normal"><a href="#__codelineno-11-17">17</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-11-1" name="__codelineno-11-1"></a><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">SignupRequest</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-11-2" name="__codelineno-11-2"></a><span class="w">  </span><span class="nd">@NotBlank</span>
<a id="__codelineno-11-3" name="__codelineno-11-3"></a><span class="w">  </span><span class="nd">@Size</span><span class="p">(</span><span class="n">min</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="n">max</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">20</span><span class="p">)</span>
<a id="__codelineno-11-4" name="__codelineno-11-4"></a><span class="w">  </span><span class="kd">private</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">username</span><span class="p">;</span>
<a id="__codelineno-11-5" name="__codelineno-11-5"></a>
<a id="__codelineno-11-6" name="__codelineno-11-6"></a><span class="w">  </span><span class="nd">@NotBlank</span>
<a id="__codelineno-11-7" name="__codelineno-11-7"></a><span class="w">  </span><span class="nd">@Size</span><span class="p">(</span><span class="n">max</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">50</span><span class="p">)</span>
<a id="__codelineno-11-8" name="__codelineno-11-8"></a><span class="w">  </span><span class="nd">@Email</span>
<a id="__codelineno-11-9" name="__codelineno-11-9"></a><span class="w">  </span><span class="kd">private</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">email</span><span class="p">;</span>
<a id="__codelineno-11-10" name="__codelineno-11-10"></a>
<a id="__codelineno-11-11" name="__codelineno-11-11"></a><span class="w">  </span><span class="kd">private</span><span class="w"> </span><span class="n">Set</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span><span class="w"> </span><span class="n">role</span><span class="p">;</span>
<a id="__codelineno-11-12" name="__codelineno-11-12"></a>
<a id="__codelineno-11-13" name="__codelineno-11-13"></a><span class="w">  </span><span class="nd">@NotBlank</span>
<a id="__codelineno-11-14" name="__codelineno-11-14"></a><span class="w">  </span><span class="nd">@Size</span><span class="p">(</span><span class="n">min</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">6</span><span class="p">,</span><span class="w"> </span><span class="n">max</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">40</span><span class="p">)</span>
<a id="__codelineno-11-15" name="__codelineno-11-15"></a><span class="w">  </span><span class="kd">private</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">password</span><span class="p">;</span>
<a id="__codelineno-11-16" name="__codelineno-11-16"></a>
<a id="__codelineno-11-17" name="__codelineno-11-17"></a><span class="w">  </span><span class="c1">// get and set</span>
</code></pre></div></td></tr></table></div>
<p>To send this information, the json object will be something like:</p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">JSON</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-12-1">1</a></span>
<span class="normal"><a href="#__codelineno-12-2">2</a></span>
<span class="normal"><a href="#__codelineno-12-3">3</a></span>
<span class="normal"><a href="#__codelineno-12-4">4</a></span>
<span class="normal"><a href="#__codelineno-12-5">5</a></span>
<span class="normal"><a href="#__codelineno-12-6">6</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-12-1" name="__codelineno-12-1"></a><span class="p">{</span>
<a id="__codelineno-12-2" name="__codelineno-12-2"></a><span class="w">    </span><span class="nt">&quot;username&quot;</span><span class="p">:</span><span class="s2">&quot;joange&quot;</span><span class="p">,</span>
<a id="__codelineno-12-3" name="__codelineno-12-3"></a><span class="w">    </span><span class="nt">&quot;email&quot;</span><span class="p">:</span><span class="s2">&quot;jg.camarenaestruch@edu.gva.es&quot;</span><span class="p">,</span>
<a id="__codelineno-12-4" name="__codelineno-12-4"></a><span class="w">    </span><span class="nt">&quot;password&quot;</span><span class="p">:</span><span class="s2">&quot;123456&quot;</span><span class="p">,</span>
<a id="__codelineno-12-5" name="__codelineno-12-5"></a><span class="w">    </span><span class="nt">&quot;role&quot;</span><span class="p">:[</span><span class="s2">&quot;admin&quot;</span><span class="p">,</span><span class="s2">&quot;user&quot;</span><span class="p">]</span>
<a id="__codelineno-12-6" name="__codelineno-12-6"></a><span class="p">}</span>
</code></pre></div></td></tr></table></div>
<h3 id="27-loginrequest">2.7. LoginRequest</h3>
<p>Very easy class:</p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Java</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-13-1">1</a></span>
<span class="normal"><a href="#__codelineno-13-2">2</a></span>
<span class="normal"><a href="#__codelineno-13-3">3</a></span>
<span class="normal"><a href="#__codelineno-13-4">4</a></span>
<span class="normal"><a href="#__codelineno-13-5">5</a></span>
<span class="normal"><a href="#__codelineno-13-6">6</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-13-1" name="__codelineno-13-1"></a><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">LoginRequest</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-13-2" name="__codelineno-13-2"></a><span class="w">    </span><span class="nd">@NotBlank</span>
<a id="__codelineno-13-3" name="__codelineno-13-3"></a><span class="w">  </span><span class="kd">private</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">username</span><span class="p">;</span>
<a id="__codelineno-13-4" name="__codelineno-13-4"></a>
<a id="__codelineno-13-5" name="__codelineno-13-5"></a><span class="w">    </span><span class="nd">@NotBlank</span>
<a id="__codelineno-13-6" name="__codelineno-13-6"></a><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">password</span><span class="p">;</span>
</code></pre></div></td></tr></table></div>
<p>and the json object is something like:</p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">JSON</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-14-1">1</a></span>
<span class="normal"><a href="#__codelineno-14-2">2</a></span>
<span class="normal"><a href="#__codelineno-14-3">3</a></span>
<span class="normal"><a href="#__codelineno-14-4">4</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-14-1" name="__codelineno-14-1"></a><span class="p">{</span>
<a id="__codelineno-14-2" name="__codelineno-14-2"></a><span class="w">    </span><span class="nt">&quot;username&quot;</span><span class="p">:</span><span class="s2">&quot;joange&quot;</span><span class="p">,</span>
<a id="__codelineno-14-3" name="__codelineno-14-3"></a><span class="w">    </span><span class="nt">&quot;password&quot;</span><span class="p">:</span><span class="s2">&quot;123456&quot;</span>
<a id="__codelineno-14-4" name="__codelineno-14-4"></a><span class="p">}</span>
</code></pre></div></td></tr></table></div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>In this class we could mark fields as requireds, with annotation <code>@NotBlank</code> from <code>javax.validation.constraints.NotBlank</code>. You must add:
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">XML</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-15-1">1</a></span>
<span class="normal"><a href="#__codelineno-15-2">2</a></span>
<span class="normal"><a href="#__codelineno-15-3">3</a></span>
<span class="normal"><a href="#__codelineno-15-4">4</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-15-1" name="__codelineno-15-1"></a><span class="w">    </span><span class="nt">&lt;dependency&gt;</span>
<a id="__codelineno-15-2" name="__codelineno-15-2"></a><span class="w">        </span><span class="nt">&lt;groupId&gt;</span>org.springframework.boot<span class="nt">&lt;/groupId&gt;</span>
<a id="__codelineno-15-3" name="__codelineno-15-3"></a><span class="w">        </span><span class="nt">&lt;artifactId&gt;</span>spring-boot-starter-validation<span class="nt">&lt;/artifactId&gt;</span>
<a id="__codelineno-15-4" name="__codelineno-15-4"></a><span class="w">    </span><span class="nt">&lt;/dependency&gt;</span>
</code></pre></div></td></tr></table></div></p>
</div>
<h3 id="28-jwtresponse">2.8. JwtResponse</h3>
<p>This DTO class is the class that is returned as a <em>login</em> request. It should contain little information about our user and must important think, a JWT token. This token will be used to authorize us, as we will study in next section.</p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Java</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-16-1">1</a></span>
<span class="normal"><a href="#__codelineno-16-2">2</a></span>
<span class="normal"><a href="#__codelineno-16-3">3</a></span>
<span class="normal"><a href="#__codelineno-16-4">4</a></span>
<span class="normal"><a href="#__codelineno-16-5">5</a></span>
<span class="normal"><a href="#__codelineno-16-6">6</a></span>
<span class="normal"><a href="#__codelineno-16-7">7</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-16-1" name="__codelineno-16-1"></a><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">JwtResponse</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-16-2" name="__codelineno-16-2"></a><span class="w">  </span><span class="kd">private</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">token</span><span class="p">;</span>
<a id="__codelineno-16-3" name="__codelineno-16-3"></a><span class="w">  </span><span class="kd">private</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;Bearer&quot;</span><span class="p">;</span>
<a id="__codelineno-16-4" name="__codelineno-16-4"></a><span class="w">  </span><span class="kd">private</span><span class="w"> </span><span class="n">Long</span><span class="w"> </span><span class="n">id</span><span class="p">;</span>
<a id="__codelineno-16-5" name="__codelineno-16-5"></a><span class="w">  </span><span class="kd">private</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">username</span><span class="p">;</span>
<a id="__codelineno-16-6" name="__codelineno-16-6"></a><span class="w">  </span><span class="kd">private</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">email</span><span class="p">;</span>
<a id="__codelineno-16-7" name="__codelineno-16-7"></a><span class="w">  </span><span class="kd">private</span><span class="w"> </span><span class="n">List</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span><span class="w"> </span><span class="n">roles</span><span class="p">;</span>
</code></pre></div></td></tr></table></div>
<p>Be notice than:</p>
<ul>
<li>Fields on this clase will be populated from <code>User</code> class, like a DTO.</li>
<li>We have changed role format, from <code>Role</code> class to <code>String</code>, with a better management in clients.</li>
<li>The <code>String token</code> is where the JWT token is stored. In fact a token is a String, as we will show now.</li>
</ul>
<h2 id="3-tokens-jwt">3. Tokens JWT</h2>
<h3 id="31-what-is-a-token">3.1. What is a token?</h3>
<p>JSON Web Tokens (JWT) have been introduced as a method of secure communication between two parties. It was introduced with the RFC 7519 specification by the Internet Engineering Task Force (IETF).
Although we can use <code>JWT</code> with any kind of communication method, nowadays, JWT is very popular for handling <strong>authentication</strong> and <strong>authorization</strong> over HTTP.</p>
<p>First, you'll need to know some features of HTTP:</p>
<ul>
<li>HTTP is a <em>stateless</em> protocol, which means that an HTTP request does not maintain state. The server is not aware of any previous requests sent by the same client.</li>
<li>HTTP requests should be <em>standalone</em>. They must include information about previous requests that the user made in the same request.</li>
</ul>
<p>There are a few ways to do this, but the most popular way is to set a <strong>session_id</strong>, which is a reference to the user's information:</p>
<ul>
<li>The server will store this session ID in memory or in a database. The client will send each request with this session ID.</li>
<li>The server can then obtain information about the client using this reference.</li>
<li>Normally, this session ID is sent to the user as a <strong>cookie</strong>.</li>
</ul>
<p>Here is the diagram of how session-based authentication works.</p>
<p><center><img alt="authentication-and-authorization-in-expressjs-using-jwt-1" src="../../../UD5_Spring/img/authentication-and-authorization-in-expressjs-using-jwt-1.png" width="95%" /></center></p>
<p>On the other hand, with JWT, when the client sends an authentication request to the server, it will send a <strong>token</strong> (<em>token</em>) JSON to the client, which includes all the information about the user along with the response.</p>
<p>The client will submit this token with <strong>all</strong> subsequent requests. Therefore, the server will not have to store any information about the session. But there is a problem with this approach. Anyone can send a fake request with a fake JSON token and pretend to be someone they're not.</p>
<p>For example, let's say that after authentication, the server returns a JSON object to the client with the username and expiration time. So, since the JSON object is readable, anyone can edit this information and submit a request for it. The problem is that there is no way to validate this request.</p>
<p>This is where the <strong>witness signature</strong> comes in. So instead of just sending a normal JSON token, the server will send a signed token, which can verify that the information doesn't change.</p>
<p><center><img alt="authentication-and-authorization-in-expressjs-using-jwt-2" src="../../../UD5_Spring/img/authentication-and-authorization-in-expressjs-using-jwt-2.png" width="95%" /></center></p>
<h3 id="32-structure-of-jwt">3.2. Structure of JWT</h3>
<p>Let's talk about the structure of a JWT through a sample token:</p>
<p><center><img alt="authentication-and-authorization-in-expressjs-using-jwt-3" src="../../../UD5_Spring/img/authentication-and-authorization-in-expressjs-using-jwt-3.png" width="95%" /></center></p>
<p>As you can see, there are three sections to this JWT, each separated by a dot.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p><code>Base64</code> encoding is a way to ensure that the data is not corrupted, as they do not compress or encrypt the data, but simply encode it in a way that most systems can understand. You can read any Base64 encoded text simply by decoding them.</p>
</div>
<p>First section of the JWT is a <strong>header</strong>, which is a Base64-encoded string. If you decode the header, it would look something like this:</p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">JSON</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-17-1">1</a></span>
<span class="normal"><a href="#__codelineno-17-2">2</a></span>
<span class="normal"><a href="#__codelineno-17-3">3</a></span>
<span class="normal"><a href="#__codelineno-17-4">4</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-17-1" name="__codelineno-17-1"></a><span class="p">{</span>
<a id="__codelineno-17-2" name="__codelineno-17-2"></a><span class="w">     </span><span class="nt">&quot;alg&quot;</span><span class="p">:</span><span class="nt">&quot;HS256&quot;</span>
<a id="__codelineno-17-3" name="__codelineno-17-3"></a><span class="w">     </span><span class="nt">&quot;type&quot;</span><span class="p">:</span><span class="s2">&quot;JWT&quot;</span>
<a id="__codelineno-17-4" name="__codelineno-17-4"></a><span class="p">}</span>
</code></pre></div></td></tr></table></div>
<p>The header section contains the hash algorithm, which was used to generate the token's sign and type.</p>
<p>The second section is the <strong>payload</strong> containing the JSON object that was sent back to the user. Since it is only Base64 encoded, anyone can easily decode it. It is mandatory not to include sensitive data in JWTs, such as passwords or personally identifiable information.</p>
<p>Typically, the body of the JWT will look something like this, although it doesn't necessarily apply:</p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">JSON</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-18-1">1</a></span>
<span class="normal"><a href="#__codelineno-18-2">2</a></span>
<span class="normal"><a href="#__codelineno-18-3">3</a></span>
<span class="normal"><a href="#__codelineno-18-4">4</a></span>
<span class="normal"><a href="#__codelineno-18-5">5</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-18-1" name="__codelineno-18-1"></a><span class="p">{</span>
<a id="__codelineno-18-2" name="__codelineno-18-2"></a><span class="w">   </span><span class="nt">&quot;sub&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;1234567890&quot;</span><span class="p">,</span>
<a id="__codelineno-18-3" name="__codelineno-18-3"></a><span class="w">   </span><span class="nt">&quot;name&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;John Doe&quot;</span><span class="p">,</span>
<a id="__codelineno-18-4" name="__codelineno-18-4"></a><span class="w">   </span><span class="nt">&quot;iat&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">1516239022</span>
<a id="__codelineno-18-5" name="__codelineno-18-5"></a><span class="p">}</span>
</code></pre></div></td></tr></table></div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Most of the time, the <code>sub</code> property will contain the user ID, the <code>iat</code> (<em>issued at</em>) property, abbreviated as <code>issued at</code>, is the token's issuance timestamp.  You may also see some common properties, such as <code>eat</code> or <code>exp</code>, which is the token's expiration time.</p>
<p>All these properties are the <strong>claims</strong> of the token, the information.</p>
</div>
<p>The final section is the token signature. This is generated by hashing the string created with previous two sections and a secret password, using the algorithm mentioned in the header section.</p>
<p>You can visit <a href="https://www.javainuse.com/jwtgenerator">https://www.javainuse.com/jwtgenerator</a> and <a href="https://jwt.io">https://jwt.io</a> to generate tokens and test with several data, secrets and hashes.</p>
<h3 id="33-jwt-library-class">3.3. JWT Library class</h3>
<p>We must update our <code>pom.xml</code> with dependencies:</p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">XML</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-19-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-19-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-19-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-19-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-19-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-19-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-19-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-19-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-19-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-19-10">10</a></span>
<span class="normal"><a href="#__codelineno-19-11">11</a></span>
<span class="normal"><a href="#__codelineno-19-12">12</a></span>
<span class="normal"><a href="#__codelineno-19-13">13</a></span>
<span class="normal"><a href="#__codelineno-19-14">14</a></span>
<span class="normal"><a href="#__codelineno-19-15">15</a></span>
<span class="normal"><a href="#__codelineno-19-16">16</a></span>
<span class="normal"><a href="#__codelineno-19-17">17</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-19-1" name="__codelineno-19-1"></a><span class="nt">&lt;dependency&gt;</span>
<a id="__codelineno-19-2" name="__codelineno-19-2"></a><span class="w">  </span><span class="nt">&lt;groupId&gt;</span>io.jsonwebtoken<span class="nt">&lt;/groupId&gt;</span>
<a id="__codelineno-19-3" name="__codelineno-19-3"></a><span class="w">  </span><span class="nt">&lt;artifactId&gt;</span>jjwt-api<span class="nt">&lt;/artifactId&gt;</span>
<a id="__codelineno-19-4" name="__codelineno-19-4"></a><span class="w">  </span><span class="nt">&lt;version&gt;</span>0.10.7<span class="nt">&lt;/version&gt;</span>
<a id="__codelineno-19-5" name="__codelineno-19-5"></a><span class="nt">&lt;/dependency&gt;</span>
<a id="__codelineno-19-6" name="__codelineno-19-6"></a><span class="nt">&lt;dependency&gt;</span>
<a id="__codelineno-19-7" name="__codelineno-19-7"></a><span class="w">  </span><span class="nt">&lt;groupId&gt;</span>io.jsonwebtoken<span class="nt">&lt;/groupId&gt;</span>
<a id="__codelineno-19-8" name="__codelineno-19-8"></a><span class="w">  </span><span class="nt">&lt;artifactId&gt;</span>jjwt-impl<span class="nt">&lt;/artifactId&gt;</span>
<a id="__codelineno-19-9" name="__codelineno-19-9"></a><span class="w">  </span><span class="nt">&lt;version&gt;</span>0.10.7<span class="nt">&lt;/version&gt;</span>
<a id="__codelineno-19-10" name="__codelineno-19-10"></a><span class="w">  </span><span class="nt">&lt;scope&gt;</span>runtime<span class="nt">&lt;/scope&gt;</span>
<a id="__codelineno-19-11" name="__codelineno-19-11"></a><span class="nt">&lt;/dependency&gt;</span>
<a id="__codelineno-19-12" name="__codelineno-19-12"></a><span class="nt">&lt;dependency&gt;</span>
<a id="__codelineno-19-13" name="__codelineno-19-13"></a><span class="w">  </span><span class="nt">&lt;groupId&gt;</span>io.jsonwebtoken<span class="nt">&lt;/groupId&gt;</span>
<a id="__codelineno-19-14" name="__codelineno-19-14"></a><span class="w">  </span><span class="nt">&lt;artifactId&gt;</span>jjwt-jackson<span class="nt">&lt;/artifactId&gt;</span>
<a id="__codelineno-19-15" name="__codelineno-19-15"></a><span class="w">  </span><span class="nt">&lt;version&gt;</span>0.10.7<span class="nt">&lt;/version&gt;</span>
<a id="__codelineno-19-16" name="__codelineno-19-16"></a><span class="w">  </span><span class="nt">&lt;scope&gt;</span>runtime<span class="nt">&lt;/scope&gt;</span>
<a id="__codelineno-19-17" name="__codelineno-19-17"></a><span class="nt">&lt;/dependency&gt;</span>
</code></pre></div></td></tr></table></div>
<p>This class is who generate and checks token integrity. Let's go to show this class and what elements it needs. This class will be a library class with methods to create token, validate it and extract information from it. We will find this class with names like <code>JWTUtils</code> or <code>JWTTokenProvider</code>. This class skeleton is like follows:</p>
<ul>
<li>Loading or definition of token constants</li>
<li>Method to generate JWT from a <code>Authentication</code> object</li>
<li>Methods to get information from the token</li>
<li>Method to validate token (signature)</li>
</ul>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Java</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-20-1">1</a></span>
<span class="normal"><a href="#__codelineno-20-2">2</a></span>
<span class="normal"><a href="#__codelineno-20-3">3</a></span>
<span class="normal"><a href="#__codelineno-20-4">4</a></span>
<span class="normal"><a href="#__codelineno-20-5">5</a></span>
<span class="normal"><a href="#__codelineno-20-6">6</a></span>
<span class="normal"><a href="#__codelineno-20-7">7</a></span>
<span class="normal"><a href="#__codelineno-20-8">8</a></span>
<span class="normal"><a href="#__codelineno-20-9">9</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-20-1" name="__codelineno-20-1"></a><span class="c1">// constants and secrets</span>
<a id="__codelineno-20-2" name="__codelineno-20-2"></a>
<a id="__codelineno-20-3" name="__codelineno-20-3"></a><span class="w">  </span><span class="kd">public</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="nf">generateJwtToken</span><span class="p">(</span><span class="n">Authentication</span><span class="w"> </span><span class="n">authentication</span><span class="p">);</span>
<a id="__codelineno-20-4" name="__codelineno-20-4"></a>
<a id="__codelineno-20-5" name="__codelineno-20-5"></a><span class="w">  </span><span class="kd">public</span><span class="w"> </span><span class="kt">boolean</span><span class="w"> </span><span class="nf">validateJwtToken</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">authToken</span><span class="p">);</span>
<a id="__codelineno-20-6" name="__codelineno-20-6"></a>
<a id="__codelineno-20-7" name="__codelineno-20-7"></a><span class="w">  </span><span class="kd">public</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="nf">getUserNameFromJwtToken</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">token</span><span class="p">);</span>
<a id="__codelineno-20-8" name="__codelineno-20-8"></a>
<a id="__codelineno-20-9" name="__codelineno-20-9"></a><span class="w">  </span><span class="c1">// another methods.</span>
</code></pre></div></td></tr></table></div>
<h3 id="34-token-generation">3.4. Token generation</h3>
<p>Let's go to see each method. Firt, we find an <code>Authentication</code> object. We need to now that this object represents another token (not our JWT) with the credentials of the object we want to identify.</p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Java</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-21-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-21-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-21-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-21-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-21-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-21-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-21-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-21-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-21-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-21-10">10</a></span>
<span class="normal"><a href="#__codelineno-21-11">11</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-21-1" name="__codelineno-21-1"></a><span class="kd">public</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="nf">generateJwtToken</span><span class="p">(</span><span class="n">Authentication</span><span class="w"> </span><span class="n">authentication</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-21-2" name="__codelineno-21-2"></a>
<a id="__codelineno-21-3" name="__codelineno-21-3"></a><span class="w">    </span><span class="n">UserDetailsImpl</span><span class="w"> </span><span class="n">userPrincipal</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">UserDetailsImpl</span><span class="p">)</span><span class="w"> </span><span class="n">authentication</span><span class="p">.</span><span class="na">getPrincipal</span><span class="p">();</span>
<a id="__codelineno-21-4" name="__codelineno-21-4"></a>
<a id="__codelineno-21-5" name="__codelineno-21-5"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">Jwts</span><span class="p">.</span><span class="na">builder</span><span class="p">()</span>
<a id="__codelineno-21-6" name="__codelineno-21-6"></a><span class="w">        </span><span class="p">.</span><span class="na">setSubject</span><span class="p">((</span><span class="n">userPrincipal</span><span class="p">.</span><span class="na">getUsername</span><span class="p">()))</span>
<a id="__codelineno-21-7" name="__codelineno-21-7"></a><span class="w">        </span><span class="p">.</span><span class="na">setIssuedAt</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">Date</span><span class="p">())</span>
<a id="__codelineno-21-8" name="__codelineno-21-8"></a><span class="w">        </span><span class="p">.</span><span class="na">setExpiration</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">Date</span><span class="p">((</span><span class="k">new</span><span class="w"> </span><span class="n">Date</span><span class="p">()).</span><span class="na">getTime</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">jwtExpirationMs</span><span class="p">))</span>
<a id="__codelineno-21-9" name="__codelineno-21-9"></a><span class="w">        </span><span class="p">.</span><span class="na">signWith</span><span class="p">(</span><span class="n">SignatureAlgorithm</span><span class="p">.</span><span class="na">HS512</span><span class="p">,</span><span class="w"> </span><span class="n">jwtSecret</span><span class="p">)</span>
<a id="__codelineno-21-10" name="__codelineno-21-10"></a><span class="w">        </span><span class="p">.</span><span class="na">compact</span><span class="p">();</span>
<a id="__codelineno-21-11" name="__codelineno-21-11"></a><span class="w">  </span><span class="p">}</span>
</code></pre></div></td></tr></table></div>
<p>We see that:</p>
<ul>
<li>We recieve an <code>Authentication</code> objects, whom we have saved a <code>UserDetailsImpl</code> inside it. As all user details implementations, we could get username, and we use it to set the token subject.</li>
<li>We set IAT tho the current time stamp.</li>
<li>We establish the expiration time.</li>
<li>We set the cipher algorithm and the secret word, and the token is ready to...</li>
<li>the compact() method creates and transform the token to String</li>
</ul>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The <code>jwtSecret</code> is the password we nedd. It is a good idea to store it inside <code>application.properties</code> and recover it to a variable, as <code>jwtExpiration</code>. We could use <code>@Value</code> annotation:</p>
</div>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Java</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-22-1">1</a></span>
<span class="normal"><a href="#__codelineno-22-2">2</a></span>
<span class="normal"><a href="#__codelineno-22-3">3</a></span>
<span class="normal"><a href="#__codelineno-22-4">4</a></span>
<span class="normal"><a href="#__codelineno-22-5">5</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-22-1" name="__codelineno-22-1"></a><span class="w">  </span><span class="nd">@Value</span><span class="p">(</span><span class="s">&quot;${app.jwtSecret}&quot;</span><span class="p">)</span>
<a id="__codelineno-22-2" name="__codelineno-22-2"></a><span class="w">  </span><span class="kd">private</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">jwtSecret</span><span class="p">;</span>
<a id="__codelineno-22-3" name="__codelineno-22-3"></a>
<a id="__codelineno-22-4" name="__codelineno-22-4"></a><span class="w">  </span><span class="nd">@Value</span><span class="p">(</span><span class="s">&quot;${app.jwtExpirationMs}&quot;</span><span class="p">)</span>
<a id="__codelineno-22-5" name="__codelineno-22-5"></a><span class="w">  </span><span class="kd">private</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">jwtExpirationMs</span><span class="p">;</span>
</code></pre></div></td></tr></table></div>
<h3 id="35-token-validation">3.5. Token validation</h3>
<p>Very easy method:</p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Java</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-23-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-23-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-23-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-23-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-23-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-23-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-23-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-23-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-23-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-23-10">10</a></span>
<span class="normal"><a href="#__codelineno-23-11">11</a></span>
<span class="normal"><a href="#__codelineno-23-12">12</a></span>
<span class="normal"><a href="#__codelineno-23-13">13</a></span>
<span class="normal"><a href="#__codelineno-23-14">14</a></span>
<span class="normal"><a href="#__codelineno-23-15">15</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-23-1" name="__codelineno-23-1"></a><span class="kd">public</span><span class="w"> </span><span class="kt">boolean</span><span class="w"> </span><span class="nf">validateJwtToken</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">authToken</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-23-2" name="__codelineno-23-2"></a><span class="w">    </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-23-3" name="__codelineno-23-3"></a><span class="w">      </span><span class="n">Jwts</span><span class="p">.</span><span class="na">parser</span><span class="p">().</span><span class="na">setSigningKey</span><span class="p">(</span><span class="n">jwtSecret</span><span class="p">).</span><span class="na">parseClaimsJws</span><span class="p">(</span><span class="n">authToken</span><span class="p">);</span>
<a id="__codelineno-23-4" name="__codelineno-23-4"></a><span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span>
<a id="__codelineno-23-5" name="__codelineno-23-5"></a><span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">SignatureException</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-23-6" name="__codelineno-23-6"></a><span class="w">      </span><span class="n">logger</span><span class="p">.</span><span class="na">error</span><span class="p">(</span><span class="s">&quot;Invalid JWT signature: {}&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">e</span><span class="p">.</span><span class="na">getMessage</span><span class="p">());</span>
<a id="__codelineno-23-7" name="__codelineno-23-7"></a><span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">MalformedJwtException</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-23-8" name="__codelineno-23-8"></a><span class="w">      </span><span class="n">logger</span><span class="p">.</span><span class="na">error</span><span class="p">(</span><span class="s">&quot;Invalid JWT token: {}&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">e</span><span class="p">.</span><span class="na">getMessage</span><span class="p">());</span>
<a id="__codelineno-23-9" name="__codelineno-23-9"></a><span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">ExpiredJwtException</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-23-10" name="__codelineno-23-10"></a><span class="w">      </span><span class="n">logger</span><span class="p">.</span><span class="na">error</span><span class="p">(</span><span class="s">&quot;JWT token is expired: {}&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">e</span><span class="p">.</span><span class="na">getMessage</span><span class="p">());</span>
<a id="__codelineno-23-11" name="__codelineno-23-11"></a><span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">UnsupportedJwtException</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-23-12" name="__codelineno-23-12"></a><span class="w">      </span><span class="n">logger</span><span class="p">.</span><span class="na">error</span><span class="p">(</span><span class="s">&quot;JWT token is unsupported: {}&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">e</span><span class="p">.</span><span class="na">getMessage</span><span class="p">());</span>
<a id="__codelineno-23-13" name="__codelineno-23-13"></a><span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">IllegalArgumentException</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-23-14" name="__codelineno-23-14"></a><span class="w">      </span><span class="n">logger</span><span class="p">.</span><span class="na">error</span><span class="p">(</span><span class="s">&quot;JWT claims string is empty: {}&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">e</span><span class="p">.</span><span class="na">getMessage</span><span class="p">());</span>
<a id="__codelineno-23-15" name="__codelineno-23-15"></a><span class="w">    </span><span class="p">}</span>
</code></pre></div></td></tr></table></div>
<p>In this method we check if it is a valida token. We use <code>parseClaimsJws(String token)</code>, after assign secret password to get the claims. If exists any problem with the token integrity, could appear a Exception. We get the claims inside a <code>try-catch</code> block and inform if something happens. We will return <code>true</code> if no Exception was catched.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Remember that the <em>claims</em> are the content of the token payload. We do not need in this method the claims, only check if all is good</p>
</div>
<h2 id="4-authentication-controller">4. Authentication Controller</h2>
<p>Now we also know how to create tokens and the <code>User</code> structure in our database, is time to expose our path in order to register and login users. And so, only two methods are mandatory. The class could be something like:</p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Java</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-24-1">1</a></span>
<span class="normal"><a href="#__codelineno-24-2">2</a></span>
<span class="normal"><a href="#__codelineno-24-3">3</a></span>
<span class="normal"><a href="#__codelineno-24-4">4</a></span>
<span class="normal"><a href="#__codelineno-24-5">5</a></span>
<span class="normal"><a href="#__codelineno-24-6">6</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-24-1" name="__codelineno-24-1"></a><span class="nd">@CrossOrigin</span><span class="p">(</span><span class="n">origins</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;*&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">maxAge</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">3600</span><span class="p">)</span>
<a id="__codelineno-24-2" name="__codelineno-24-2"></a><span class="nd">@RestController</span>
<a id="__codelineno-24-3" name="__codelineno-24-3"></a><span class="nd">@RequestMapping</span><span class="p">(</span><span class="s">&quot;/api/auth&quot;</span><span class="p">)</span>
<a id="__codelineno-24-4" name="__codelineno-24-4"></a><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">AuthController</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-24-5" name="__codelineno-24-5"></a><span class="w">    </span><span class="p">...</span>
<a id="__codelineno-24-6" name="__codelineno-24-6"></a><span class="p">}</span>
</code></pre></div></td></tr></table></div>
<ul>
<li><code>@CrossOrigin</code> Annotation for permitting cross-origin requests on specific handler classes and/or handler methods. Processed if an appropriate HandlerMapping is configured. Cross-Origin Resource Sharing (<strong>CORS</strong>) is a security concept that allows restricting the resources implemented in web browsers. It prevents the JavaScript code producing or consuming the requests against different origin. For example, your web application is running on 8080 port and by using JavaScript you are trying to consume RESTful web services from 9090 port. Under such situations, you will face the Cross-Origin Resource Sharing security issue on your web browsers.</li>
<li><code>@RequestMapping("/api/auth")</code> tells that all controllers are inside <code>/api/auth</code> path.</li>
</ul>
<p>Let's go to see them, but before studying methods, this class has these required variables:</p>
<ul>
<li><code>@Autowired AuthenticationManager authenticationManager;</code> → used to create an <code>Authentication</code> token, used by Spring security context and by token generator.</li>
<li><code>@Autowired UserRepository userRepository;</code> → used to access and save users.</li>
<li><code>@Autowired RoleRepository roleRepository;</code> → to check if the roles that come in the request are valids.</li>
<li><code>@Autowired PasswordEncoder encoder;</code>  → used to encrypt user password</li>
<li><code>@Autowired JwtUtils jwtUtils;</code> → used to create JWT tokens.</li>
</ul>
<p>Now that we have presented the actors, let's go to the function</p>
<h3 id="41-signup-new-user">4.1. Signup (new user)</h3>
<p>The method in charge to create new users, will receive a <code>SignupRequest</code> with this data:</p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">JSON</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-25-1">1</a></span>
<span class="normal"><a href="#__codelineno-25-2">2</a></span>
<span class="normal"><a href="#__codelineno-25-3">3</a></span>
<span class="normal"><a href="#__codelineno-25-4">4</a></span>
<span class="normal"><a href="#__codelineno-25-5">5</a></span>
<span class="normal"><a href="#__codelineno-25-6">6</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-25-1" name="__codelineno-25-1"></a><span class="p">{</span>
<a id="__codelineno-25-2" name="__codelineno-25-2"></a><span class="w">    </span><span class="nt">&quot;username&quot;</span><span class="p">:</span><span class="s2">&quot;joange&quot;</span><span class="p">,</span>
<a id="__codelineno-25-3" name="__codelineno-25-3"></a><span class="w">    </span><span class="nt">&quot;email&quot;</span><span class="p">:</span><span class="s2">&quot;jg.camarenaestruch@edu.gva.es&quot;</span><span class="p">,</span>
<a id="__codelineno-25-4" name="__codelineno-25-4"></a><span class="w">    </span><span class="nt">&quot;password&quot;</span><span class="p">:</span><span class="s2">&quot;123456&quot;</span><span class="p">,</span>
<a id="__codelineno-25-5" name="__codelineno-25-5"></a><span class="w">    </span><span class="nt">&quot;role&quot;</span><span class="p">:[</span><span class="s2">&quot;admin&quot;</span><span class="p">,</span><span class="s2">&quot;user&quot;</span><span class="p">]</span>
<a id="__codelineno-25-6" name="__codelineno-25-6"></a><span class="p">}</span>
</code></pre></div></td></tr></table></div>
<p>the method body is following, and let we see by blocks:</p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Java</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-26-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-26-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-26-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-26-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-26-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-26-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-26-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-26-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-26-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-26-10">10</a></span>
<span class="normal"><a href="#__codelineno-26-11">11</a></span>
<span class="normal"><a href="#__codelineno-26-12">12</a></span>
<span class="normal"><a href="#__codelineno-26-13">13</a></span>
<span class="normal"><a href="#__codelineno-26-14">14</a></span>
<span class="normal"><a href="#__codelineno-26-15">15</a></span>
<span class="normal"><a href="#__codelineno-26-16">16</a></span>
<span class="normal"><a href="#__codelineno-26-17">17</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-26-1" name="__codelineno-26-1"></a><span class="nd">@PostMapping</span><span class="p">(</span><span class="s">&quot;/signup&quot;</span><span class="p">)</span>
<a id="__codelineno-26-2" name="__codelineno-26-2"></a><span class="w">  </span><span class="kd">public</span><span class="w"> </span><span class="n">ResponseEntity</span><span class="o">&lt;?&gt;</span><span class="w"> </span><span class="n">registerUser</span><span class="p">(</span><span class="nd">@Valid</span><span class="w"> </span><span class="nd">@RequestBody</span><span class="w"> </span><span class="n">SignupRequest</span><span class="w"> </span><span class="n">signUpRequest</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-26-3" name="__codelineno-26-3"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">userRepository</span><span class="p">.</span><span class="na">existsByUsername</span><span class="p">(</span><span class="n">signUpRequest</span><span class="p">.</span><span class="na">getUsername</span><span class="p">()))</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-26-4" name="__codelineno-26-4"></a><span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="n">ResponseEntity</span>
<a id="__codelineno-26-5" name="__codelineno-26-5"></a><span class="w">          </span><span class="p">.</span><span class="na">badRequest</span><span class="p">()</span>
<a id="__codelineno-26-6" name="__codelineno-26-6"></a><span class="w">          </span><span class="p">.</span><span class="na">body</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">MessageResponse</span><span class="p">(</span><span class="s">&quot;Error: Username is already taken!&quot;</span><span class="p">));</span>
<a id="__codelineno-26-7" name="__codelineno-26-7"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-26-8" name="__codelineno-26-8"></a>
<a id="__codelineno-26-9" name="__codelineno-26-9"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">userRepository</span><span class="p">.</span><span class="na">existsByEmail</span><span class="p">(</span><span class="n">signUpRequest</span><span class="p">.</span><span class="na">getEmail</span><span class="p">()))</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-26-10" name="__codelineno-26-10"></a><span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="n">ResponseEntity</span>
<a id="__codelineno-26-11" name="__codelineno-26-11"></a><span class="w">          </span><span class="p">.</span><span class="na">badRequest</span><span class="p">()</span>
<a id="__codelineno-26-12" name="__codelineno-26-12"></a><span class="w">          </span><span class="p">.</span><span class="na">body</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">MessageResponse</span><span class="p">(</span><span class="s">&quot;Error: Email is already in use!&quot;</span><span class="p">));</span>
<a id="__codelineno-26-13" name="__codelineno-26-13"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-26-14" name="__codelineno-26-14"></a><span class="w">    </span><span class="c1">// Create new user&#39;s account</span>
<a id="__codelineno-26-15" name="__codelineno-26-15"></a><span class="w">    </span><span class="n">User</span><span class="w"> </span><span class="n">user</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">User</span><span class="p">(</span><span class="n">signUpRequest</span><span class="p">.</span><span class="na">getUsername</span><span class="p">(),</span><span class="w"> </span>
<a id="__codelineno-26-16" name="__codelineno-26-16"></a><span class="w">               </span><span class="n">signUpRequest</span><span class="p">.</span><span class="na">getEmail</span><span class="p">(),</span>
<a id="__codelineno-26-17" name="__codelineno-26-17"></a><span class="w">               </span><span class="n">encoder</span><span class="p">.</span><span class="na">encode</span><span class="p">(</span><span class="n">signUpRequest</span><span class="p">.</span><span class="na">getPassword</span><span class="p">()));</span>
</code></pre></div></td></tr></table></div>
<p>In this first part:</p>
<ul>
<li>We check if any user exists with same username or email, asking our repository. If any error appears, we will return a <code>ResponseEntity</code> as a <em>bad request</em> with a description message. </li>
<li>Finally, we create a ner User with username, email and an encrypted password.</li>
</ul>
<p>Next block is responsible to get the roles (stored in a String's JSONArray) and transform to a <code>Set&lt;Role&gt;</code>. </p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Java</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-27-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-27-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-27-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-27-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-27-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-27-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-27-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-27-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-27-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-27-10">10</a></span>
<span class="normal"><a href="#__codelineno-27-11">11</a></span>
<span class="normal"><a href="#__codelineno-27-12">12</a></span>
<span class="normal"><a href="#__codelineno-27-13">13</a></span>
<span class="normal"><a href="#__codelineno-27-14">14</a></span>
<span class="normal"><a href="#__codelineno-27-15">15</a></span>
<span class="normal"><a href="#__codelineno-27-16">16</a></span>
<span class="normal"><a href="#__codelineno-27-17">17</a></span>
<span class="normal"><a href="#__codelineno-27-18">18</a></span>
<span class="normal"><a href="#__codelineno-27-19">19</a></span>
<span class="normal"><a href="#__codelineno-27-20">20</a></span>
<span class="normal"><a href="#__codelineno-27-21">21</a></span>
<span class="normal"><a href="#__codelineno-27-22">22</a></span>
<span class="normal"><a href="#__codelineno-27-23">23</a></span>
<span class="normal"><a href="#__codelineno-27-24">24</a></span>
<span class="normal"><a href="#__codelineno-27-25">25</a></span>
<span class="normal"><a href="#__codelineno-27-26">26</a></span>
<span class="normal"><a href="#__codelineno-27-27">27</a></span>
<span class="normal"><a href="#__codelineno-27-28">28</a></span>
<span class="normal"><a href="#__codelineno-27-29">29</a></span>
<span class="normal"><a href="#__codelineno-27-30">30</a></span>
<span class="normal"><a href="#__codelineno-27-31">31</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-27-1" name="__codelineno-27-1"></a><span class="w">    </span><span class="n">Set</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span><span class="w"> </span><span class="n">strRoles</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">signUpRequest</span><span class="p">.</span><span class="na">getRole</span><span class="p">();</span>
<a id="__codelineno-27-2" name="__codelineno-27-2"></a><span class="w">    </span><span class="n">Set</span><span class="o">&lt;</span><span class="n">Role</span><span class="o">&gt;</span><span class="w"> </span><span class="n">roles</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">HashSet</span><span class="o">&lt;&gt;</span><span class="p">();</span>
<a id="__codelineno-27-3" name="__codelineno-27-3"></a>
<a id="__codelineno-27-4" name="__codelineno-27-4"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">strRoles</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-27-5" name="__codelineno-27-5"></a><span class="w">      </span><span class="n">Role</span><span class="w"> </span><span class="n">userRole</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">roleRepository</span><span class="p">.</span><span class="na">findByName</span><span class="p">(</span><span class="n">ERole</span><span class="p">.</span><span class="na">ROLE_USER</span><span class="p">)</span>
<a id="__codelineno-27-6" name="__codelineno-27-6"></a><span class="w">          </span><span class="p">.</span><span class="na">orElseThrow</span><span class="p">(()</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">RuntimeException</span><span class="p">(</span><span class="s">&quot;Error: Role is not found.&quot;</span><span class="p">));</span>
<a id="__codelineno-27-7" name="__codelineno-27-7"></a><span class="w">      </span><span class="n">roles</span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="n">userRole</span><span class="p">);</span>
<a id="__codelineno-27-8" name="__codelineno-27-8"></a><span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-27-9" name="__codelineno-27-9"></a><span class="w">      </span><span class="n">strRoles</span><span class="p">.</span><span class="na">forEach</span><span class="p">(</span><span class="n">role</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-27-10" name="__codelineno-27-10"></a><span class="w">        </span><span class="k">switch</span><span class="w"> </span><span class="p">(</span><span class="n">role</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-27-11" name="__codelineno-27-11"></a><span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="s">&quot;admin&quot;</span><span class="p">:</span>
<a id="__codelineno-27-12" name="__codelineno-27-12"></a><span class="w">          </span><span class="n">Role</span><span class="w"> </span><span class="n">adminRole</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">roleRepository</span><span class="p">.</span><span class="na">findByName</span><span class="p">(</span><span class="n">ERole</span><span class="p">.</span><span class="na">ROLE_ADMIN</span><span class="p">)</span>
<a id="__codelineno-27-13" name="__codelineno-27-13"></a><span class="w">              </span><span class="p">.</span><span class="na">orElseThrow</span><span class="p">(()</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">RuntimeException</span><span class="p">(</span><span class="s">&quot;Error: Role is not found.&quot;</span><span class="p">));</span>
<a id="__codelineno-27-14" name="__codelineno-27-14"></a><span class="w">          </span><span class="n">roles</span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="n">adminRole</span><span class="p">);</span>
<a id="__codelineno-27-15" name="__codelineno-27-15"></a>
<a id="__codelineno-27-16" name="__codelineno-27-16"></a><span class="w">          </span><span class="k">break</span><span class="p">;</span>
<a id="__codelineno-27-17" name="__codelineno-27-17"></a><span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="s">&quot;mod&quot;</span><span class="p">:</span>
<a id="__codelineno-27-18" name="__codelineno-27-18"></a><span class="w">          </span><span class="n">Role</span><span class="w"> </span><span class="n">modRole</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">roleRepository</span><span class="p">.</span><span class="na">findByName</span><span class="p">(</span><span class="n">ERole</span><span class="p">.</span><span class="na">ROLE_MODERATOR</span><span class="p">)</span>
<a id="__codelineno-27-19" name="__codelineno-27-19"></a><span class="w">              </span><span class="p">.</span><span class="na">orElseThrow</span><span class="p">(()</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">RuntimeException</span><span class="p">(</span><span class="s">&quot;Error: Role is not found.&quot;</span><span class="p">));</span>
<a id="__codelineno-27-20" name="__codelineno-27-20"></a><span class="w">          </span><span class="n">roles</span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="n">modRole</span><span class="p">);</span>
<a id="__codelineno-27-21" name="__codelineno-27-21"></a>
<a id="__codelineno-27-22" name="__codelineno-27-22"></a><span class="w">          </span><span class="k">break</span><span class="p">;</span>
<a id="__codelineno-27-23" name="__codelineno-27-23"></a><span class="w">        </span><span class="k">default</span><span class="p">:</span>
<a id="__codelineno-27-24" name="__codelineno-27-24"></a><span class="w">          </span><span class="n">Role</span><span class="w"> </span><span class="n">userRole</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">roleRepository</span><span class="p">.</span><span class="na">findByName</span><span class="p">(</span><span class="n">ERole</span><span class="p">.</span><span class="na">ROLE_USER</span><span class="p">)</span>
<a id="__codelineno-27-25" name="__codelineno-27-25"></a><span class="w">              </span><span class="p">.</span><span class="na">orElseThrow</span><span class="p">(()</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">RuntimeException</span><span class="p">(</span><span class="s">&quot;Error: Role is not found.&quot;</span><span class="p">));</span>
<a id="__codelineno-27-26" name="__codelineno-27-26"></a><span class="w">          </span><span class="n">roles</span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="n">userRole</span><span class="p">);</span>
<a id="__codelineno-27-27" name="__codelineno-27-27"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-27-28" name="__codelineno-27-28"></a><span class="w">      </span><span class="p">});</span>
<a id="__codelineno-27-29" name="__codelineno-27-29"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-27-30" name="__codelineno-27-30"></a>
<a id="__codelineno-27-31" name="__codelineno-27-31"></a><span class="w">    </span><span class="n">user</span><span class="p">.</span><span class="na">setRoles</span><span class="p">(</span><span class="n">roles</span><span class="p">);</span>
</code></pre></div></td></tr></table></div>
<p>Let's go to see:</p>
<ul>
<li>First we check if the role set is empty. If true, we set a new <code>Role</code> with <code>ERole.ROLE_USER</code> by default.</li>
<li>Otherwise, we must loop over all roles we get, checking each role in database and creating as appropiate <code>Role</code> object.</li>
</ul>
<p>Finally, we set the <code>Set&lt;Role&gt;</code> to the user created in first block, and in the third block we only need to store new user with <code>UserRepositoy</code> and send an ok response to client.</p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Java</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-28-1">1</a></span>
<span class="normal"><a href="#__codelineno-28-2">2</a></span>
<span class="normal"><a href="#__codelineno-28-3">3</a></span>
<span class="normal"><a href="#__codelineno-28-4">4</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-28-1" name="__codelineno-28-1"></a><span class="w">    </span><span class="n">userRepository</span><span class="p">.</span><span class="na">save</span><span class="p">(</span><span class="n">user</span><span class="p">);</span>
<a id="__codelineno-28-2" name="__codelineno-28-2"></a>
<a id="__codelineno-28-3" name="__codelineno-28-3"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">ResponseEntity</span><span class="p">.</span><span class="na">ok</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">MessageResponse</span><span class="p">(</span><span class="s">&quot;User registered successfully!&quot;</span><span class="p">));</span>
<a id="__codelineno-28-4" name="__codelineno-28-4"></a><span class="w">  </span><span class="p">}</span>
</code></pre></div></td></tr></table></div>
<h3 id="42-signin-register-or-signin">4.2. Signin (register or signin)</h3>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>In spanish:</p>
<ul>
<li>Signin: registrarse, acceder al login.</li>
<li>Signup: inscribirse, darse de alta.</li>
</ul>
</div>
<p>This controller is used to create login a user in our app. As we have studied, the DTO that we recieve in the <code>HTTP_POST</code> is <code>LoginRequest</code> class, like this:</p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">JSON</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-29-1">1</a></span>
<span class="normal"><a href="#__codelineno-29-2">2</a></span>
<span class="normal"><a href="#__codelineno-29-3">3</a></span>
<span class="normal"><a href="#__codelineno-29-4">4</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-29-1" name="__codelineno-29-1"></a><span class="p">{</span>
<a id="__codelineno-29-2" name="__codelineno-29-2"></a><span class="w">    </span><span class="nt">&quot;username&quot;</span><span class="p">:</span><span class="s2">&quot;joange&quot;</span><span class="p">,</span>
<a id="__codelineno-29-3" name="__codelineno-29-3"></a><span class="w">    </span><span class="nt">&quot;password&quot;</span><span class="p">:</span><span class="s2">&quot;123456&quot;</span>
<a id="__codelineno-29-4" name="__codelineno-29-4"></a><span class="p">}</span>
</code></pre></div></td></tr></table></div>
<p>And the method in charge is:</p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Java</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-30-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-30-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-30-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-30-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-30-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-30-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-30-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-30-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-30-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-30-10">10</a></span>
<span class="normal"><a href="#__codelineno-30-11">11</a></span>
<span class="normal"><a href="#__codelineno-30-12">12</a></span>
<span class="normal"><a href="#__codelineno-30-13">13</a></span>
<span class="normal"><a href="#__codelineno-30-14">14</a></span>
<span class="normal"><a href="#__codelineno-30-15">15</a></span>
<span class="normal"><a href="#__codelineno-30-16">16</a></span>
<span class="normal"><a href="#__codelineno-30-17">17</a></span>
<span class="normal"><a href="#__codelineno-30-18">18</a></span>
<span class="normal"><a href="#__codelineno-30-19">19</a></span>
<span class="normal"><a href="#__codelineno-30-20">20</a></span>
<span class="normal"><a href="#__codelineno-30-21">21</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-30-1" name="__codelineno-30-1"></a><span class="nd">@PostMapping</span><span class="p">(</span><span class="s">&quot;/signin&quot;</span><span class="p">)</span>
<a id="__codelineno-30-2" name="__codelineno-30-2"></a><span class="w">  </span><span class="kd">public</span><span class="w"> </span><span class="n">ResponseEntity</span><span class="o">&lt;?&gt;</span><span class="w"> </span><span class="n">authenticateUser</span><span class="p">(</span><span class="nd">@Valid</span><span class="w"> </span><span class="nd">@RequestBody</span><span class="w"> </span><span class="n">LoginRequest</span><span class="w"> </span><span class="n">loginRequest</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-30-3" name="__codelineno-30-3"></a>
<a id="__codelineno-30-4" name="__codelineno-30-4"></a><span class="w">    </span><span class="n">Authentication</span><span class="w"> </span><span class="n">authentication</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">authenticationManager</span><span class="p">.</span><span class="na">authenticate</span><span class="p">(</span>
<a id="__codelineno-30-5" name="__codelineno-30-5"></a><span class="w">        </span><span class="k">new</span><span class="w"> </span><span class="n">UsernamePasswordAuthenticationToken</span><span class="p">(</span><span class="n">loginRequest</span><span class="p">.</span><span class="na">getUsername</span><span class="p">(),</span><span class="w"> </span><span class="n">loginRequest</span><span class="p">.</span><span class="na">getPassword</span><span class="p">()));</span>
<a id="__codelineno-30-6" name="__codelineno-30-6"></a>
<a id="__codelineno-30-7" name="__codelineno-30-7"></a><span class="w">    </span><span class="n">SecurityContextHolder</span><span class="p">.</span><span class="na">getContext</span><span class="p">().</span><span class="na">setAuthentication</span><span class="p">(</span><span class="n">authentication</span><span class="p">);</span>
<a id="__codelineno-30-8" name="__codelineno-30-8"></a><span class="w">    </span><span class="n">String</span><span class="w"> </span><span class="n">jwt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">jwtUtils</span><span class="p">.</span><span class="na">generateJwtToken</span><span class="p">(</span><span class="n">authentication</span><span class="p">);</span>
<a id="__codelineno-30-9" name="__codelineno-30-9"></a>
<a id="__codelineno-30-10" name="__codelineno-30-10"></a><span class="w">    </span><span class="n">UserDetailsImpl</span><span class="w"> </span><span class="n">userDetails</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">UserDetailsImpl</span><span class="p">)</span><span class="w"> </span><span class="n">authentication</span><span class="p">.</span><span class="na">getPrincipal</span><span class="p">();</span><span class="w">  </span>
<a id="__codelineno-30-11" name="__codelineno-30-11"></a>
<a id="__codelineno-30-12" name="__codelineno-30-12"></a><span class="w">    </span><span class="n">List</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span><span class="w"> </span><span class="n">roles</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">userDetails</span><span class="p">.</span><span class="na">getAuthorities</span><span class="p">().</span><span class="na">stream</span><span class="p">()</span>
<a id="__codelineno-30-13" name="__codelineno-30-13"></a><span class="w">        </span><span class="p">.</span><span class="na">map</span><span class="p">(</span><span class="n">item</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">item</span><span class="p">.</span><span class="na">getAuthority</span><span class="p">())</span>
<a id="__codelineno-30-14" name="__codelineno-30-14"></a><span class="w">        </span><span class="p">.</span><span class="na">collect</span><span class="p">(</span><span class="n">Collectors</span><span class="p">.</span><span class="na">toList</span><span class="p">());</span>
<a id="__codelineno-30-15" name="__codelineno-30-15"></a>
<a id="__codelineno-30-16" name="__codelineno-30-16"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">ResponseEntity</span><span class="p">.</span><span class="na">ok</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">JwtResponse</span><span class="p">(</span><span class="n">jwt</span><span class="p">,</span><span class="w"> </span>
<a id="__codelineno-30-17" name="__codelineno-30-17"></a><span class="w">                         </span><span class="n">userDetails</span><span class="p">.</span><span class="na">getId</span><span class="p">(),</span><span class="w"> </span>
<a id="__codelineno-30-18" name="__codelineno-30-18"></a><span class="w">                         </span><span class="n">userDetails</span><span class="p">.</span><span class="na">getUsername</span><span class="p">(),</span><span class="w"> </span>
<a id="__codelineno-30-19" name="__codelineno-30-19"></a><span class="w">                         </span><span class="n">userDetails</span><span class="p">.</span><span class="na">getEmail</span><span class="p">(),</span><span class="w"> </span>
<a id="__codelineno-30-20" name="__codelineno-30-20"></a><span class="w">                         </span><span class="n">roles</span><span class="p">));</span>
<a id="__codelineno-30-21" name="__codelineno-30-21"></a><span class="w">  </span><span class="p">}</span>
</code></pre></div></td></tr></table></div>
<p>Take into account:</p>
<ul>
<li><code>@Valid</code> annotation check that json object match with <code>LoginRequest</code> class (take a look to this attribute class annotations).</li>
<li>We create an <code>Authentication</code> token (this is not the JWT Token !!!) with username and password recieved. Password is not encripted yet.</li>
<li>Last <code>Authentication</code> token is setted to the <code>SecurityContextHolder</code>, and object that contains a minimum security in a thread level. In this step is when Spring security subsystem works, asking <code>UserDetailService</code> for a user with this username and password in our database, and it is stored in a <code>UserDetails</code> Bean in memory. If any credential is wrong, it will throw an Exception, that itwill be managed by our system (we will study this later).</li>
<li>With this token (authentication) we generate our token. Remember that inside <code>jwtUtils</code>, we only get username in order to generate our token subject.</li>
<li>We get the <code>UserDetails</code> object with <code>getPrincipal()</code> method, and</li>
<li>Transform the List of authorities into a List of String (have you studied how to map lists? And filter? And reduce?)</li>
<li>Finally, we create and return a <code>ResponseEntity</code>, with http_Status <strong>ok</strong>, with a <code>JwtResponse</code> inside it. Token plus attributes.  A sample of JWTrespone is:</li>
</ul>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">JSON</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-31-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-31-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-31-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-31-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-31-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-31-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-31-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-31-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-31-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-31-10">10</a></span>
<span class="normal"><a href="#__codelineno-31-11">11</a></span>
<span class="normal"><a href="#__codelineno-31-12">12</a></span>
<span class="normal"><a href="#__codelineno-31-13">13</a></span>
<span class="normal"><a href="#__codelineno-31-14">14</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-31-1" name="__codelineno-31-1"></a><span class="p">{</span>
<a id="__codelineno-31-2" name="__codelineno-31-2"></a><span class="w">    </span><span class="nt">&quot;id&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span>
<a id="__codelineno-31-3" name="__codelineno-31-3"></a><span class="w">    </span><span class="nt">&quot;username&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;joange&quot;</span><span class="p">,</span>
<a id="__codelineno-31-4" name="__codelineno-31-4"></a><span class="w">    </span><span class="nt">&quot;email&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;joange.sales@edu.gva.es&quot;</span><span class="p">,</span>
<a id="__codelineno-31-5" name="__codelineno-31-5"></a><span class="w">    </span><span class="nt">&quot;roles&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
<a id="__codelineno-31-6" name="__codelineno-31-6"></a><span class="w">        </span><span class="s2">&quot;ROLE_USER&quot;</span><span class="p">,</span>
<a id="__codelineno-31-7" name="__codelineno-31-7"></a><span class="w">        </span><span class="s2">&quot;ROLE_ADMIN&quot;</span>
<a id="__codelineno-31-8" name="__codelineno-31-8"></a><span class="w">    </span><span class="p">],</span>
<a id="__codelineno-31-9" name="__codelineno-31-9"></a><span class="w">    </span><span class="nt">&quot;accessToken&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;eyJhbGciOiJIUzUxMiJ9.</span>
<a id="__codelineno-31-10" name="__codelineno-31-10"></a><span class="s2">    eyJzdWIiOiJqb2FuZ2UiLCJpYXQiOjE2NzM2MjY1OTYsImV4cCI6MTY3MzcxMjk5Nn0.</span>
<a id="__codelineno-31-11" name="__codelineno-31-11"></a><span class="s2">    6yMcAYYvHsQ4XKmmT6tr0PmkpJKfPusxnMVHDmIl4WJQ_KtaY08vbt27KdvJHkWCZPO</span>
<a id="__codelineno-31-12" name="__codelineno-31-12"></a><span class="s2">    4dA2a2HtnAq13vMKAPw&quot;</span><span class="p">,</span>
<a id="__codelineno-31-13" name="__codelineno-31-13"></a><span class="w">    </span><span class="nt">&quot;tokenType&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;Bearer&quot;</span>
<a id="__codelineno-31-14" name="__codelineno-31-14"></a><span class="p">}</span>
</code></pre></div></td></tr></table></div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Last token has extra newlines in order to avoid exit out of paper width, is one full String</p>
</div>
<p>if the username is not found on database the following response is created by our system:</p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">JSON</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-32-1">1</a></span>
<span class="normal"><a href="#__codelineno-32-2">2</a></span>
<span class="normal"><a href="#__codelineno-32-3">3</a></span>
<span class="normal"><a href="#__codelineno-32-4">4</a></span>
<span class="normal"><a href="#__codelineno-32-5">5</a></span>
<span class="normal"><a href="#__codelineno-32-6">6</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-32-1" name="__codelineno-32-1"></a><span class="p">{</span>
<a id="__codelineno-32-2" name="__codelineno-32-2"></a><span class="w">    </span><span class="nt">&quot;path&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;/api/auth/signin&quot;</span><span class="p">,</span>
<a id="__codelineno-32-3" name="__codelineno-32-3"></a><span class="w">    </span><span class="nt">&quot;error&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;Unauthorized&quot;</span><span class="p">,</span>
<a id="__codelineno-32-4" name="__codelineno-32-4"></a><span class="w">    </span><span class="nt">&quot;message&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;Bad credentials&quot;</span><span class="p">,</span>
<a id="__codelineno-32-5" name="__codelineno-32-5"></a><span class="w">    </span><span class="nt">&quot;status&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">401</span>
<a id="__codelineno-32-6" name="__codelineno-32-6"></a><span class="p">}</span>
</code></pre></div></td></tr></table></div>
<h2 id="5-tokens-working">5. Tokens working</h2>
<p>Now that user registration and login are implemented, let's ask a question, <em>What do the client application does with the JWTResponse he has received afetr login process</em>? User data is normally used to interface (full name, avatar, etc.). But what happens with tokens? </p>
<p>The answer, as we will study later is store it, and then send to the server in each request as Authorization and Authentication method.</p>
<h3 id="51-sending-tokens">5.1. Sending tokens</h3>
<p>To send a token, we need to attach it in the <code>Header</code> section, creating an <code>Authorization</code> parameter with value <code>Bearer token_recieved</code>, as you can see on this Postman screenshot:</p>
<p><center><img alt="Send_JWT" src="../../../UD5_Spring/img/Send_JWT.png" width="95%" /></center></p>
<div class="admonition important">
<p class="admonition-title">Important</p>
<p>Remember: word <code>Bearer</code> plus <em>white space</em> plus the whole token recieved (as String)</p>
</div>
<p>Ok thus the client application will send us the token through the request, but, how does our server to get and check the token. The answer is than we have to say it in a filter way. </p>
<h2 id="6-security-config">6. Security Config</h2>
<p>The class that configure security is <code>WebSecurityConfig</code>. Let's go to explain it by blocks again. This class is composed by a set of Beans who will be used in all project (remember code injection). We will explain only necessary.</p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Java</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-33-1">1</a></span>
<span class="normal"><a href="#__codelineno-33-2">2</a></span>
<span class="normal"><a href="#__codelineno-33-3">3</a></span>
<span class="normal"><a href="#__codelineno-33-4">4</a></span>
<span class="normal"><a href="#__codelineno-33-5">5</a></span>
<span class="normal"><a href="#__codelineno-33-6">6</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-33-1" name="__codelineno-33-1"></a><span class="nd">@Configuration</span>
<a id="__codelineno-33-2" name="__codelineno-33-2"></a><span class="nd">@EnableGlobalMethodSecurity</span><span class="p">(</span>
<a id="__codelineno-33-3" name="__codelineno-33-3"></a><span class="w">    </span><span class="n">prePostEnabled</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">)</span>
<a id="__codelineno-33-4" name="__codelineno-33-4"></a><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">WebSecurityConfig</span><span class="w"> </span><span class="p">{</span><span class="w"> </span>
<a id="__codelineno-33-5" name="__codelineno-33-5"></a>
<a id="__codelineno-33-6" name="__codelineno-33-6"></a><span class="p">}</span>
</code></pre></div></td></tr></table></div>
<p>This <code>@Configuration</code> tells Spring to load this class. We say that Spring allow to pre and post filters annotations (let's study later)</p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Java</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-34-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-34-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-34-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-34-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-34-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-34-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-34-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-34-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-34-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-34-10">10</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-34-1" name="__codelineno-34-1"></a><span class="w">  </span><span class="nd">@Autowired</span>
<a id="__codelineno-34-2" name="__codelineno-34-2"></a><span class="w">  </span><span class="n">UserDetailsServiceImpl</span><span class="w"> </span><span class="n">userDetailsService</span><span class="p">;</span>
<a id="__codelineno-34-3" name="__codelineno-34-3"></a>
<a id="__codelineno-34-4" name="__codelineno-34-4"></a><span class="w">  </span><span class="nd">@Autowired</span>
<a id="__codelineno-34-5" name="__codelineno-34-5"></a><span class="w">  </span><span class="kd">private</span><span class="w"> </span><span class="n">AuthEntryPointJwt</span><span class="w"> </span><span class="n">unauthorizedHandler</span><span class="p">;</span>
<a id="__codelineno-34-6" name="__codelineno-34-6"></a>
<a id="__codelineno-34-7" name="__codelineno-34-7"></a><span class="w">  </span><span class="nd">@Bean</span>
<a id="__codelineno-34-8" name="__codelineno-34-8"></a><span class="w">  </span><span class="kd">public</span><span class="w"> </span><span class="n">AuthTokenFilter</span><span class="w"> </span><span class="nf">authenticationJwtTokenFilter</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-34-9" name="__codelineno-34-9"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">AuthTokenFilter</span><span class="p">();</span>
<a id="__codelineno-34-10" name="__codelineno-34-10"></a><span class="w">  </span><span class="p">}</span>
</code></pre></div></td></tr></table></div>
<p>These beans will be explained later. In a few words are responsible for manage errors as Exception handler and how to apply filter chains to authenticate users.</p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Java</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-35-1">1</a></span>
<span class="normal"><a href="#__codelineno-35-2">2</a></span>
<span class="normal"><a href="#__codelineno-35-3">3</a></span>
<span class="normal"><a href="#__codelineno-35-4">4</a></span>
<span class="normal"><a href="#__codelineno-35-5">5</a></span>
<span class="normal"><a href="#__codelineno-35-6">6</a></span>
<span class="normal"><a href="#__codelineno-35-7">7</a></span>
<span class="normal"><a href="#__codelineno-35-8">8</a></span>
<span class="normal"><a href="#__codelineno-35-9">9</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-35-1" name="__codelineno-35-1"></a><span class="w">  </span><span class="nd">@Bean</span>
<a id="__codelineno-35-2" name="__codelineno-35-2"></a><span class="w">  </span><span class="kd">public</span><span class="w"> </span><span class="n">DaoAuthenticationProvider</span><span class="w"> </span><span class="nf">authenticationProvider</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-35-3" name="__codelineno-35-3"></a><span class="w">      </span><span class="n">DaoAuthenticationProvider</span><span class="w"> </span><span class="n">authProvider</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">DaoAuthenticationProvider</span><span class="p">();</span>
<a id="__codelineno-35-4" name="__codelineno-35-4"></a>
<a id="__codelineno-35-5" name="__codelineno-35-5"></a><span class="w">      </span><span class="n">authProvider</span><span class="p">.</span><span class="na">setUserDetailsService</span><span class="p">(</span><span class="n">userDetailsService</span><span class="p">);</span>
<a id="__codelineno-35-6" name="__codelineno-35-6"></a><span class="w">      </span><span class="n">authProvider</span><span class="p">.</span><span class="na">setPasswordEncoder</span><span class="p">(</span><span class="n">passwordEncoder</span><span class="p">());</span>
<a id="__codelineno-35-7" name="__codelineno-35-7"></a>
<a id="__codelineno-35-8" name="__codelineno-35-8"></a><span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="n">authProvider</span><span class="p">;</span>
<a id="__codelineno-35-9" name="__codelineno-35-9"></a><span class="w">  </span><span class="p">}</span>
</code></pre></div></td></tr></table></div>
<p>This Bean use the <code>UserDetailService</code> and <code>PasswordEncoder</code> to do the authentication process. This mean access the database and check user and password (with the same encoder we use to store users). Next Beans create AuthenticationManager and encoder.</p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Java</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-36-1">1</a></span>
<span class="normal"><a href="#__codelineno-36-2">2</a></span>
<span class="normal"><a href="#__codelineno-36-3">3</a></span>
<span class="normal"><a href="#__codelineno-36-4">4</a></span>
<span class="normal"><a href="#__codelineno-36-5">5</a></span>
<span class="normal"><a href="#__codelineno-36-6">6</a></span>
<span class="normal"><a href="#__codelineno-36-7">7</a></span>
<span class="normal"><a href="#__codelineno-36-8">8</a></span>
<span class="normal"><a href="#__codelineno-36-9">9</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-36-1" name="__codelineno-36-1"></a><span class="w">  </span><span class="nd">@Bean</span>
<a id="__codelineno-36-2" name="__codelineno-36-2"></a><span class="w">  </span><span class="kd">public</span><span class="w"> </span><span class="n">AuthenticationManager</span><span class="w"> </span><span class="nf">authenticationManager</span><span class="p">(</span><span class="n">AuthenticationConfiguration</span><span class="w"> </span><span class="n">authConfig</span><span class="p">)</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">Exception</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-36-3" name="__codelineno-36-3"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">authConfig</span><span class="p">.</span><span class="na">getAuthenticationManager</span><span class="p">();</span>
<a id="__codelineno-36-4" name="__codelineno-36-4"></a><span class="w">  </span><span class="p">}</span>
<a id="__codelineno-36-5" name="__codelineno-36-5"></a>
<a id="__codelineno-36-6" name="__codelineno-36-6"></a><span class="w">  </span><span class="nd">@Bean</span>
<a id="__codelineno-36-7" name="__codelineno-36-7"></a><span class="w">  </span><span class="kd">public</span><span class="w"> </span><span class="n">PasswordEncoder</span><span class="w"> </span><span class="nf">passwordEncoder</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-36-8" name="__codelineno-36-8"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">BCryptPasswordEncoder</span><span class="p">();</span>
<a id="__codelineno-36-9" name="__codelineno-36-9"></a><span class="w">  </span><span class="p">}</span>
</code></pre></div></td></tr></table></div>
<p>And finally one of the most important (and hard to understand) configuration, the security filter chain. Filter chain are code that we put in the middle between client and server. These filters intercepts the request, analyze it and then, dependeding the result of the filter, simple pass the control to the server or send a response to the client. This filter could change the request, adding or removing information that will be used by the server.</p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Java</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-37-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-37-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-37-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-37-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-37-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-37-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-37-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-37-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-37-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-37-10">10</a></span>
<span class="normal"><a href="#__codelineno-37-11">11</a></span>
<span class="normal"><a href="#__codelineno-37-12">12</a></span>
<span class="normal"><a href="#__codelineno-37-13">13</a></span>
<span class="normal"><a href="#__codelineno-37-14">14</a></span>
<span class="normal"><a href="#__codelineno-37-15">15</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-37-1" name="__codelineno-37-1"></a><span class="w">  </span><span class="nd">@Bean</span>
<a id="__codelineno-37-2" name="__codelineno-37-2"></a><span class="w">  </span><span class="kd">public</span><span class="w"> </span><span class="n">SecurityFilterChain</span><span class="w"> </span><span class="nf">filterChain</span><span class="p">(</span><span class="n">HttpSecurity</span><span class="w"> </span><span class="n">http</span><span class="p">)</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">Exception</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-37-3" name="__codelineno-37-3"></a><span class="w">    </span><span class="n">http</span><span class="p">.</span><span class="na">cors</span><span class="p">().</span><span class="na">and</span><span class="p">().</span><span class="na">csrf</span><span class="p">().</span><span class="na">disable</span><span class="p">()</span>
<a id="__codelineno-37-4" name="__codelineno-37-4"></a><span class="w">        </span><span class="p">.</span><span class="na">exceptionHandling</span><span class="p">().</span><span class="na">authenticationEntryPoint</span><span class="p">(</span><span class="n">unauthorizedHandler</span><span class="p">).</span><span class="na">and</span><span class="p">()</span>
<a id="__codelineno-37-5" name="__codelineno-37-5"></a><span class="w">        </span><span class="p">.</span><span class="na">sessionManagement</span><span class="p">().</span><span class="na">sessionCreationPolicy</span><span class="p">(</span><span class="n">SessionCreationPolicy</span><span class="p">.</span><span class="na">STATELESS</span><span class="p">).</span><span class="na">and</span><span class="p">()</span>
<a id="__codelineno-37-6" name="__codelineno-37-6"></a><span class="w">        </span><span class="p">.</span><span class="na">authorizeRequests</span><span class="p">().</span><span class="na">antMatchers</span><span class="p">(</span><span class="s">&quot;/api/auth/**&quot;</span><span class="p">).</span><span class="na">permitAll</span><span class="p">()</span>
<a id="__codelineno-37-7" name="__codelineno-37-7"></a><span class="w">        </span><span class="p">.</span><span class="na">antMatchers</span><span class="p">(</span><span class="s">&quot;/api/test/**&quot;</span><span class="p">).</span><span class="na">permitAll</span><span class="p">()</span>
<a id="__codelineno-37-8" name="__codelineno-37-8"></a><span class="w">        </span><span class="p">.</span><span class="na">anyRequest</span><span class="p">().</span><span class="na">authenticated</span><span class="p">();</span>
<a id="__codelineno-37-9" name="__codelineno-37-9"></a>
<a id="__codelineno-37-10" name="__codelineno-37-10"></a><span class="w">    </span><span class="n">http</span><span class="p">.</span><span class="na">authenticationProvider</span><span class="p">(</span><span class="n">authenticationProvider</span><span class="p">());</span>
<a id="__codelineno-37-11" name="__codelineno-37-11"></a>
<a id="__codelineno-37-12" name="__codelineno-37-12"></a><span class="w">    </span><span class="n">http</span><span class="p">.</span><span class="na">addFilterBefore</span><span class="p">(</span><span class="n">authenticationJwtTokenFilter</span><span class="p">(),</span><span class="w"> </span><span class="n">UsernamePasswordAuthenticationFilter</span><span class="p">.</span><span class="na">class</span><span class="p">);</span>
<a id="__codelineno-37-13" name="__codelineno-37-13"></a>
<a id="__codelineno-37-14" name="__codelineno-37-14"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">http</span><span class="p">.</span><span class="na">build</span><span class="p">();</span>
<a id="__codelineno-37-15" name="__codelineno-37-15"></a><span class="w">  </span><span class="p">}</span>
</code></pre></div></td></tr></table></div>
<p>Take notice that we:</p>
<ul>
<li>Enable CORS (Cross-Origin Requests) and disble CSRF (Cross Site Request Forgery)</li>
<li>Set the authenticationEntryPoint</li>
<li>Allow access to all paths in <code>/api/auth/**</code></li>
<li>Allow access to all paths in <code>/api/auth/**</code></li>
<li>Any onther request will need to be authenticated</li>
</ul>
<p>Finaly we add the before filter and the authenticationprovider. </p>
<p>In a relaxed view, to understand it, filters are combined with anotations that where and when we have to check Authentication and Authorization.</p>
<p><center><img alt="FilterChain" src="../../../UD5_Spring/img/FilterChain.png" width="95%" /></center></p>
<h3 id="61-authtokenfilter">6.1. AuthTokenFilter</h3>
<p>This class contains the process of the token received from clients. It must implement <code>OncePerRequestFilter</code> and override <code>doFilterInternal()</code>. </p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Java</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-38-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-38-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-38-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-38-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-38-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-38-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-38-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-38-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-38-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-38-10">10</a></span>
<span class="normal"><a href="#__codelineno-38-11">11</a></span>
<span class="normal"><a href="#__codelineno-38-12">12</a></span>
<span class="normal"><a href="#__codelineno-38-13">13</a></span>
<span class="normal"><a href="#__codelineno-38-14">14</a></span>
<span class="normal"><a href="#__codelineno-38-15">15</a></span>
<span class="normal"><a href="#__codelineno-38-16">16</a></span>
<span class="normal"><a href="#__codelineno-38-17">17</a></span>
<span class="normal"><a href="#__codelineno-38-18">18</a></span>
<span class="normal"><a href="#__codelineno-38-19">19</a></span>
<span class="normal"><a href="#__codelineno-38-20">20</a></span>
<span class="normal"><a href="#__codelineno-38-21">21</a></span>
<span class="normal"><a href="#__codelineno-38-22">22</a></span>
<span class="normal"><a href="#__codelineno-38-23">23</a></span>
<span class="normal"><a href="#__codelineno-38-24">24</a></span>
<span class="normal"><a href="#__codelineno-38-25">25</a></span>
<span class="normal"><a href="#__codelineno-38-26">26</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-38-1" name="__codelineno-38-1"></a><span class="nd">@Override</span>
<a id="__codelineno-38-2" name="__codelineno-38-2"></a><span class="w">  </span><span class="kd">protected</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">doFilterInternal</span><span class="p">(</span>
<a id="__codelineno-38-3" name="__codelineno-38-3"></a><span class="w">    </span><span class="n">HttpServletRequest</span><span class="w"> </span><span class="n">request</span><span class="p">,</span><span class="w"> </span>
<a id="__codelineno-38-4" name="__codelineno-38-4"></a><span class="w">    </span><span class="n">HttpServletResponse</span><span class="w"> </span><span class="n">response</span><span class="p">,</span><span class="w"> </span>
<a id="__codelineno-38-5" name="__codelineno-38-5"></a><span class="w">    </span><span class="n">FilterChain</span><span class="w"> </span><span class="n">filterChain</span><span class="p">)</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">ServletException</span><span class="p">,</span><span class="w"> </span><span class="n">IOException</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-38-6" name="__codelineno-38-6"></a><span class="w">    </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-38-7" name="__codelineno-38-7"></a><span class="w">      </span><span class="n">String</span><span class="w"> </span><span class="n">jwt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">parseJwt</span><span class="p">(</span><span class="n">request</span><span class="p">);</span>
<a id="__codelineno-38-8" name="__codelineno-38-8"></a><span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">jwt</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">jwtUtils</span><span class="p">.</span><span class="na">validateJwtToken</span><span class="p">(</span><span class="n">jwt</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-38-9" name="__codelineno-38-9"></a><span class="w">        </span><span class="n">String</span><span class="w"> </span><span class="n">username</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">jwtUtils</span><span class="p">.</span><span class="na">getUserNameFromJwtToken</span><span class="p">(</span><span class="n">jwt</span><span class="p">);</span>
<a id="__codelineno-38-10" name="__codelineno-38-10"></a>
<a id="__codelineno-38-11" name="__codelineno-38-11"></a><span class="w">        </span><span class="n">UserDetails</span><span class="w"> </span><span class="n">userDetails</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">userDetailsService</span><span class="p">.</span><span class="na">loadUserByUsername</span><span class="p">(</span><span class="n">username</span><span class="p">);</span>
<a id="__codelineno-38-12" name="__codelineno-38-12"></a><span class="w">        </span><span class="n">UsernamePasswordAuthenticationToken</span><span class="w"> </span><span class="n">authentication</span><span class="w"> </span><span class="o">=</span>
<a id="__codelineno-38-13" name="__codelineno-38-13"></a><span class="w">            </span><span class="k">new</span><span class="w"> </span><span class="n">UsernamePasswordAuthenticationToken</span><span class="p">(</span>
<a id="__codelineno-38-14" name="__codelineno-38-14"></a><span class="w">                </span><span class="n">userDetails</span><span class="p">,</span>
<a id="__codelineno-38-15" name="__codelineno-38-15"></a><span class="w">                </span><span class="kc">null</span><span class="p">,</span>
<a id="__codelineno-38-16" name="__codelineno-38-16"></a><span class="w">                </span><span class="n">userDetails</span><span class="p">.</span><span class="na">getAuthorities</span><span class="p">());</span>
<a id="__codelineno-38-17" name="__codelineno-38-17"></a><span class="w">        </span><span class="n">authentication</span><span class="p">.</span><span class="na">setDetails</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">WebAuthenticationDetailsSource</span><span class="p">().</span><span class="na">buildDetails</span><span class="p">(</span><span class="n">request</span><span class="p">));</span>
<a id="__codelineno-38-18" name="__codelineno-38-18"></a>
<a id="__codelineno-38-19" name="__codelineno-38-19"></a><span class="w">        </span><span class="n">SecurityContextHolder</span><span class="p">.</span><span class="na">getContext</span><span class="p">().</span><span class="na">setAuthentication</span><span class="p">(</span><span class="n">authentication</span><span class="p">);</span>
<a id="__codelineno-38-20" name="__codelineno-38-20"></a><span class="w">      </span><span class="p">}</span>
<a id="__codelineno-38-21" name="__codelineno-38-21"></a><span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">Exception</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-38-22" name="__codelineno-38-22"></a><span class="w">      </span><span class="n">logger</span><span class="p">.</span><span class="na">error</span><span class="p">(</span><span class="s">&quot;Cannot set user authentication: {}&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">e</span><span class="p">);</span>
<a id="__codelineno-38-23" name="__codelineno-38-23"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-38-24" name="__codelineno-38-24"></a>
<a id="__codelineno-38-25" name="__codelineno-38-25"></a><span class="w">    </span><span class="n">filterChain</span><span class="p">.</span><span class="na">doFilter</span><span class="p">(</span><span class="n">request</span><span class="p">,</span><span class="w"> </span><span class="n">response</span><span class="p">);</span>
<a id="__codelineno-38-26" name="__codelineno-38-26"></a><span class="w">  </span><span class="p">}</span>
</code></pre></div></td></tr></table></div>
<p>In our word this method will be executed when a request is done. and:</p>
<ul>
<li>Extract token from the request, returning only relevant information (removes <code>Bearer</code>).</li>
<li>The check that the token is valid, and:</li>
<li>Extract the username (is in the token's payload) and</li>
<li>Get that <code>UserDetails</code> and create a <code>UsernamePasswordAuthenticationToken</code> to be injected throw rest of the request-response, obviously with authorities.</li>
<li>Finally, it continues with next filter, if exists, calling <code>filterChain.doFilter(req,res)</code>. If not filter were, then the dispatcher pass control to the controller requested.</li>
</ul>
<h3 id="62-authentrypoint">6.2. AuthEntryPoint</h3>
<p>This class contains code that will be executed when an Exception appears. Then it creates a generic body into the response and create to set an accurate answer to client.</p>
<h2 id="7-controller-authorization">7. Controller Authorization</h2>
<p>We only rest to say what request need to be Authorized. Remember that with other classes we prepare the Authentication, <strong>Who are you?</strong>. Now we need to ask <strong>What can you do?</strong></p>
<p>As we mark in our <code>filterChain</code> we <code>addFilterBefore</code>, to check roles. But, <em>where must we say the roles who catch each request</em>? The answer is easy: the controllers. Let's take a look a test controller with Authorization filter:</p>
<p><div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Java</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-39-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-39-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-39-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-39-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-39-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-39-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-39-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-39-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-39-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-39-10">10</a></span>
<span class="normal"><a href="#__codelineno-39-11">11</a></span>
<span class="normal"><a href="#__codelineno-39-12">12</a></span>
<span class="normal"><a href="#__codelineno-39-13">13</a></span>
<span class="normal"><a href="#__codelineno-39-14">14</a></span>
<span class="normal"><a href="#__codelineno-39-15">15</a></span>
<span class="normal"><a href="#__codelineno-39-16">16</a></span>
<span class="normal"><a href="#__codelineno-39-17">17</a></span>
<span class="normal"><a href="#__codelineno-39-18">18</a></span>
<span class="normal"><a href="#__codelineno-39-19">19</a></span>
<span class="normal"><a href="#__codelineno-39-20">20</a></span>
<span class="normal"><a href="#__codelineno-39-21">21</a></span>
<span class="normal"><a href="#__codelineno-39-22">22</a></span>
<span class="normal"><a href="#__codelineno-39-23">23</a></span>
<span class="normal"><a href="#__codelineno-39-24">24</a></span>
<span class="normal"><a href="#__codelineno-39-25">25</a></span>
<span class="normal"><a href="#__codelineno-39-26">26</a></span>
<span class="normal"><a href="#__codelineno-39-27">27</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-39-1" name="__codelineno-39-1"></a><span class="nd">@CrossOrigin</span><span class="p">(</span><span class="n">origins</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;*&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">maxAge</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">3600</span><span class="p">)</span>
<a id="__codelineno-39-2" name="__codelineno-39-2"></a><span class="nd">@RestController</span>
<a id="__codelineno-39-3" name="__codelineno-39-3"></a><span class="nd">@RequestMapping</span><span class="p">(</span><span class="s">&quot;/api/test&quot;</span><span class="p">)</span>
<a id="__codelineno-39-4" name="__codelineno-39-4"></a><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">TestController</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-39-5" name="__codelineno-39-5"></a><span class="w">  </span><span class="nd">@GetMapping</span><span class="p">(</span><span class="s">&quot;/all&quot;</span><span class="p">)</span>
<a id="__codelineno-39-6" name="__codelineno-39-6"></a><span class="w">  </span><span class="kd">public</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="nf">allAccess</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-39-7" name="__codelineno-39-7"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="s">&quot;Public Content.&quot;</span><span class="p">;</span>
<a id="__codelineno-39-8" name="__codelineno-39-8"></a><span class="w">  </span><span class="p">}</span>
<a id="__codelineno-39-9" name="__codelineno-39-9"></a>
<a id="__codelineno-39-10" name="__codelineno-39-10"></a><span class="w">  </span><span class="nd">@GetMapping</span><span class="p">(</span><span class="s">&quot;/user&quot;</span><span class="p">)</span>
<a id="__codelineno-39-11" name="__codelineno-39-11"></a><span class="w">  </span><span class="nd">@PreAuthorize</span><span class="p">(</span><span class="s">&quot;hasRole(&#39;USER&#39;) or hasRole(&#39;MODERATOR&#39;) or hasRole(&#39;ADMIN&#39;)&quot;</span><span class="p">)</span>
<a id="__codelineno-39-12" name="__codelineno-39-12"></a><span class="w">  </span><span class="kd">public</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="nf">userAccess</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-39-13" name="__codelineno-39-13"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="s">&quot;User Content.&quot;</span><span class="p">;</span>
<a id="__codelineno-39-14" name="__codelineno-39-14"></a><span class="w">  </span><span class="p">}</span>
<a id="__codelineno-39-15" name="__codelineno-39-15"></a>
<a id="__codelineno-39-16" name="__codelineno-39-16"></a><span class="w">  </span><span class="nd">@GetMapping</span><span class="p">(</span><span class="s">&quot;/mod&quot;</span><span class="p">)</span>
<a id="__codelineno-39-17" name="__codelineno-39-17"></a><span class="w">  </span><span class="nd">@PreAuthorize</span><span class="p">(</span><span class="s">&quot;hasRole(&#39;MODERATOR&#39;)&quot;</span><span class="p">)</span>
<a id="__codelineno-39-18" name="__codelineno-39-18"></a><span class="w">  </span><span class="kd">public</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="nf">moderatorAccess</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-39-19" name="__codelineno-39-19"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="s">&quot;Moderator Board.&quot;</span><span class="p">;</span>
<a id="__codelineno-39-20" name="__codelineno-39-20"></a><span class="w">  </span><span class="p">}</span>
<a id="__codelineno-39-21" name="__codelineno-39-21"></a>
<a id="__codelineno-39-22" name="__codelineno-39-22"></a><span class="w">  </span><span class="nd">@GetMapping</span><span class="p">(</span><span class="s">&quot;/admin&quot;</span><span class="p">)</span>
<a id="__codelineno-39-23" name="__codelineno-39-23"></a><span class="w">  </span><span class="nd">@PreAuthorize</span><span class="p">(</span><span class="s">&quot;hasRole(&#39;ADMIN&#39;)&quot;</span><span class="p">)</span>
<a id="__codelineno-39-24" name="__codelineno-39-24"></a><span class="w">  </span><span class="kd">public</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="nf">adminAccess</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-39-25" name="__codelineno-39-25"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="s">&quot;Admin Board.&quot;</span><span class="p">;</span>
<a id="__codelineno-39-26" name="__codelineno-39-26"></a><span class="w">  </span><span class="p">}</span>
<a id="__codelineno-39-27" name="__codelineno-39-27"></a><span class="p">}</span>
</code></pre></div></td></tr></table></div>
If:</p>
<ul>
<li>No annotation appears: all roles can ask for this request</li>
<li><code>@PreAuthorize("hasRole('role')")</code> → This annotation tells the role who is authorized to get this request. You can combine more than one role with <code>or</code></li>
</ul>
<h2 id="8-exercise-how-to-use-this-project">8. Exercise. How to use this project?</h2>
<p>You probably have a API rest unsecured. Now you have the task to merge your API Rest with this secure project, in order to secure and authorize only registered users. It's a hard work, but the results will be very grateful.</p>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    <script id="__config" type="application/json">{"base": "../../..", "features": ["content.code.copy", "content.code.select", "content.code.annotate"], "search": "../../../assets/javascripts/workers/search.6ce7567c.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script>
    
    
      <script src="../../../assets/javascripts/bundle.83f73b43.min.js"></script>
      
        <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
      
        <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
      
    
  </body>
</html>